<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>체크리스트 앱 - Supabase 전용</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- 프로덕션에서는 다운로드한 Tailwind CSS를 사용하세요 -->
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        dark: {
                            bg: '#1a1a1a',
                            card: '#2d2d2d',
                            text: '#e5e5e5',
                            border: '#404040'
                        }
                    }
                }
            }
        }
    </script>
    <!-- Supabase 클라이언트 라이브러리 -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard@v1.3.9/dist/web/variable/pretendardvariable.min.css">
    <style>
        body {
            font-family: 'Pretendard Variable', -apple-system, BlinkMacSystemFont, system-ui, Roboto, 'Helvetica Neue', 'Segoe UI', 'Apple SD Gothic Neo', 'Noto Sans KR', 'Malgun Gothic', 'Apple Color Emoji', 'Segoe UI Emoji', 'Segoe UI Symbol', sans-serif;
            transition: background-color 0.3s, color 0.3s;
        }
        .status-btn {
            min-width: 40px;
            min-height: 80px;
            transition: all 0.2s ease;
            font-weight: 600;
            font-size: 0.9rem;
        }
        .icon-btn {
            @apply p-2 rounded hover:bg-gray-100 dark:hover:bg-gray-600 transition-colors;
        }
        .main-title {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            text-shadow: 0 2px 4px rgba(0,0,0,0.1);
            position: relative;
        }
        .dark .main-title {
            background: linear-gradient(135deg, #8B5CF6 0%, #06B6D4 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        .title-badge {
            background: linear-gradient(135deg, #667eea20, #764ba240);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255,255,255,0.2);
        }
        .dark .title-badge {
            background: linear-gradient(135deg, #8B5CF620, #06B6D440);
            border: 1px solid rgba(255,255,255,0.1);
        }
        .sync-status {
            @apply text-xs px-2 py-1 rounded-full;
        }
        .sync-success { @apply bg-green-100 text-green-800 dark:bg-green-900 dark:text-green-300; }
        .sync-error { @apply bg-red-100 text-red-800 dark:bg-red-900 dark:text-red-300; }
        .loading {
            @apply opacity-50 pointer-events-none;
        }
    </style>
</head>
<body class="bg-gray-100 dark:bg-gray-900 min-h-screen">
    <!-- Supabase 설정 모달 -->
    <div id="configModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-xl max-w-md w-full mx-4">
            <h2 class="text-xl font-bold mb-4 dark:text-white">Supabase 설정</h2>
            <div class="text-sm text-gray-600 dark:text-gray-400 mb-4">
                <p>Supabase 데이터베이스에 연결하여 체크리스트를 클라우드에 저장합니다.</p>
                <p class="mt-2 text-xs">⚠️ Supabase 연결 및 교사 로그인 없이는 사용할 수 없습니다.</p>
            </div>
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium mb-2 dark:text-white">교사 아이디</label>
                    <input type="text" id="teacherIdInput" 
                           placeholder="교사 아이디를 입력하세요" 
                           class="w-full p-2 border rounded dark:bg-gray-700 dark:border-gray-600 dark:text-white">
                    <p class="text-xs text-gray-500 dark:text-gray-400 mt-1">등록된 교사 아이디만 사용 가능합니다.</p>
                </div>
                <div>
                    <label class="block text-sm font-medium mb-2 dark:text-white">Supabase URL</label>
                    <input type="url" id="supabaseUrl" 
                           placeholder="https://your-project.supabase.co" 
                           class="w-full p-2 border rounded dark:bg-gray-700 dark:border-gray-600 dark:text-white">
                </div>
                <div>
                    <label class="block text-sm font-medium mb-2 dark:text-white">Supabase Anon Key</label>
                    <input type="password" id="supabaseKey" 
                           placeholder="your-anon-key" 
                           class="w-full p-2 border rounded dark:bg-gray-700 dark:border-gray-600 dark:text-white">
                </div>
                <div class="flex gap-2">
                    <button onclick="saveSupabaseConfig()" 
                            class="flex-1 bg-blue-500 text-white p-2 rounded hover:bg-blue-600 transition-colors">
                        연결하기
                    </button>
                    <button onclick="resetUserId()" 
                            class="px-4 bg-gray-500 text-white p-2 rounded hover:bg-gray-600 transition-colors text-sm">
                        ID 초기화
                    </button>
                </div>
                <div class="text-xs text-gray-500 dark:text-gray-400">
                    <p>💡 Supabase 설정 방법:</p>
                    <p>1. supabase.com에서 프로젝트 생성</p>
                    <p>2. SQL Editor에서 테이블 생성 (아래 쿼리 사용)</p>
                    <p>3. Settings > API에서 URL과 Key 복사</p>
                    <p>4. 기존 데이터가 있다면: <code>UPDATE checklists SET teacher_id = 'seol3196';</code></p>
                    <p>5. 교사 계정 생성: <code>INSERT INTO teachers (teacher_id, name) VALUES ('seol3196', '설샘');</code></p>
                </div>
                <div class="bg-gray-100 dark:bg-gray-700 p-3 rounded text-xs">
                    <p class="font-semibold mb-2">테이블 생성 SQL:</p>
                    <pre class="text-xs overflow-x-auto">-- 교사 테이블 생성
CREATE TABLE teachers (
    id SERIAL PRIMARY KEY,
    teacher_id TEXT UNIQUE NOT NULL,
    name TEXT,
    created_at TIMESTAMP DEFAULT NOW()
);

ALTER TABLE teachers DISABLE ROW LEVEL SECURITY;

-- 교사 계정 추가
INSERT INTO teachers (teacher_id, name) VALUES 
('seol3196', '설샘'),
('jangyerim', '장예림샘');

-- 체크리스트 테이블 생성
CREATE TABLE checklists (
    id BIGINT PRIMARY KEY,
    user_id TEXT NOT NULL,
    teacher_id TEXT NOT NULL,
    name TEXT NOT NULL,
    category TEXT NOT NULL,
    student_count INTEGER NOT NULL,
    statuses INTEGER[] NOT NULL,
    completion_times TIMESTAMP[],
    created_at TIMESTAMP DEFAULT NOW(),
    updated_at TIMESTAMP DEFAULT NOW()
);

ALTER TABLE checklists DISABLE ROW LEVEL SECURITY;

-- 인덱스 생성
CREATE INDEX idx_checklists_teacher_id ON checklists(teacher_id);
CREATE INDEX idx_checklists_user_id ON checklists(user_id);</pre>
                </div>
            </div>
        </div>
    </div>

    <div class="container mx-auto p-4">
        <!-- 프로그램 제목 -->
        <div class="text-center mb-8 mt-6">
            <div class="inline-block mb-4">
                <h1 class="main-title text-5xl font-bold mb-2">✅ 다했어요!</h1>
                <div class="w-full h-1 bg-gradient-to-r from-blue-500 via-purple-500 to-blue-500 rounded-full"></div>
            </div>
            <p class="title-badge text-gray-700 dark:text-gray-200 font-medium rounded-full px-6 py-3 inline-block shadow-lg">
                📋 학급 체크리스트 관리 시스템
            </p>
        </div>
        
        <div class="flex justify-end mb-4">
            <div class="flex items-center gap-4">
                <div id="syncStatus" class="sync-status hidden">동기화 중...</div>
                <span class="clock text-gray-900 dark:text-white" id="clock"></span>
                <button class="flex items-center gap-2 px-3 py-2 rounded border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-800 hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors text-gray-900 dark:text-white" 
                        onclick="toggleDarkMode()">
                    <span id="darkModeIcon">🌙</span>
                    <span>다크모드</span>
                </button>
                <button onclick="showConfig()" 
                        class="flex items-center gap-2 px-3 py-2 rounded border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-800 hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors text-gray-900 dark:text-white">
                    ⚙️ 설정
                </button>
            </div>
        </div>
        
        <div class="flex gap-4">
            <!-- 좌측 체크리스트 목록 -->
            <div class="w-1/4 bg-white dark:bg-gray-800 rounded-lg shadow p-4">
                <h2 class="text-xl font-bold mb-4 dark:text-gray-100">Checklist</h2>
                <div class="mb-4">
                    <input type="number" id="studentCount" placeholder="학생 수 입력 (최대 100명)" 
                           class="w-full p-2 border rounded-full mb-2 bg-white dark:bg-gray-700 dark:border-gray-600 dark:text-gray-100" 
                           min="1" max="100">
                    <select id="categorySelect" class="w-full p-2 border rounded-full mb-2 bg-white dark:bg-gray-700 dark:border-gray-600 dark:text-gray-100">
                        <option value="일반">🗒️ 일반</option>
                        <option value="국어">📒 국어</option>
                        <option value="수학">🧮 수학</option>
                        <option value="사회">👥 사회</option>
                        <option value="과학">🔬 과학</option>
                        <option value="영어">🇺🇸 영어</option>
                        <option value="도덕">🤝 도덕</option>
                        <option value="실과">🧶 실과</option>
                        <option value="음악">🎵 음악</option>
                        <option value="미술">🎨 미술</option>
                        <option value="체육">🏃 체육</option>
                        <option value="창체">👥 창체</option>
                        <option value="아침활동">🌞 아침활동</option>
                        <option value="독서">🤓 독서</option>
                        <option value="기타">🤔 기타</option>
                    </select>
                    <button id="createChecklist" 
                            class="w-full bg-blue-500 text-white p-2 rounded hover:bg-blue-600 flex items-center justify-center gap-2 transition-colors"
                            onclick="createChecklist()">
                        ➕ 추가
                    </button>
                </div>
                <div class="mb-4">
                    <div class="flex items-center justify-between mb-2">
                        <h3 class="font-semibold dark:text-gray-100">목록</h3>
                        <button onclick="toggleCategoryFilter()" class="icon-btn dark:text-white">
                            🔍
                        </button>
                    </div>
                    <div id="categoryFilter" class="hidden space-y-1">
                        <label class="flex items-center dark:text-white">
                            <input type="checkbox" value="all" checked class="mr-2" onchange="filterChecklists()">
                            전체
                        </label>
                        <div id="categoryCheckboxes" class="space-y-1 dark:text-white"></div>
                    </div>
                </div>
                <div id="checklistList" class="space-y-2"></div>
                <div class="text-center text-xs text-gray-400 dark:text-gray-500 mt-4">
                    <div>by 행복한엄쌤</div>
                    <div id="storageInfo" class="mt-1">☁️ Supabase</div>
                </div>
            </div>

        <!-- 우측 체크리스트 내용 -->
            <div class="w-3/4 bg-white dark:bg-gray-800 rounded-lg shadow p-4">
                <div id="noConnection" class="text-center py-8 text-gray-500 dark:text-gray-400">
                    <div class="text-4xl mb-4">☁️</div>
                    <div class="text-lg font-semibold mb-2">Supabase에 연결해주세요</div>
                    <div class="text-sm">설정 버튼을 클릭하여 데이터베이스를 연결하세요.</div>
                </div>
                
                <div id="mainContent" class="hidden">
                    <div class="flex justify-between items-center mb-4">
                        <div class="flex-1">
                            <div class="flex items-center gap-2">
                                <select id="editCategorySelect" 
                                        class="p-2 border rounded-full bg-white dark:bg-gray-700 dark:border-gray-600 dark:text-gray-100" 
                                        onchange="updateCurrentChecklist()">
                                    <option value="일반">🗒️ 일반</option>
                                    <option value="국어">📒 국어</option>
                                    <option value="수학">🧮 수학</option>
                                    <option value="사회">👥 사회</option>
                                    <option value="과학">🔬 과학</option>
                                    <option value="영어">🇺🇸 영어</option>
                                    <option value="도덕">🤝 도덕</option>
                                    <option value="실과">🧶 실과</option>
                                    <option value="음악">🎵 음악</option>
                                    <option value="미술">🎨 미술</option>
                                    <option value="체육">🏃 체육</option>
                                    <option value="창체">👥 창체</option>
                                    <option value="아침활동">🌞 아침활동</option>
                                    <option value="독서">🤓 독서</option>
                                    <option value="기타">🤔 기타</option>
                                </select>
                                <input type="text" id="checklistTitle" 
                                       class="flex-1 text-xl font-bold bg-transparent border-b border-transparent hover:border-gray-300 focus:border-blue-500 focus:outline-none px-1 dark:text-gray-100 dark:border-gray-600" 
                                       onchange="updateCurrentChecklist()">
                            </div>
                            <div id="checklistInfo" class="text-sm text-gray-400 dark:text-gray-500 mt-1"></div>
                        </div>
                        <div id="checklistActions" class="hidden">
                            <button onclick="deleteCurrentChecklist()" 
                                    class="icon-btn text-red-500 hover:bg-red-100 dark:hover:bg-red-900">
                                🗑️
                            </button>
                        </div>
                    </div>
                    
                    <div id="checklistContent" class="grid grid-cols-5 gap-3 mb-6"></div>
                    
                    <!-- 통계 섹션 -->
                    <div id="statistics" class="border-t border-gray-200 dark:border-gray-600 pt-4 hidden">
                        <h3 class="text-lg font-semibold mb-3 dark:text-gray-100">상태별 통계</h3>
                        <div class="grid grid-cols-5 gap-4 mb-4">
                            <div class="text-center">
                                <div class="bg-green-500 text-white p-2 rounded mb-1">완료</div>
                                <div class="text-sm dark:text-gray-100">
                                    <span id="completedCount">0</span>명
                                    (<span id="completedPercent">0.0</span>%)
                                </div>
                            </div>
                            <div class="text-center">
                                <div class="bg-yellow-500 text-white p-2 rounded mb-1">진행중</div>
                                <div class="text-sm dark:text-gray-100">
                                    <span id="inProgressCount">0</span>명
                                    (<span id="inProgressPercent">0.0</span>%)
                                </div>
                            </div>
                            <div class="text-center">
                                <div class="bg-orange-500 text-white p-2 rounded mb-1">재제출</div>
                                <div class="text-sm dark:text-gray-100">
                                    <span id="resubmitCount">0</span>명
                                    (<span id="resubmitPercent">0.0</span>%)
                                </div>
                            </div>
                            <div class="text-center">
                                <div class="bg-gray-500 text-white p-2 rounded mb-1">미완료</div>
                                <div class="text-sm dark:text-gray-100">
                                    <span id="incompleteCount">0</span>명
                                    (<span id="incompletePercent">0.0</span>%)
                                </div>
                            </div>
                            <div class="text-center">
                                <div class="bg-red-500 text-white p-2 rounded mb-1">미제출마감</div>
                                <div class="text-sm dark:text-gray-100">
                                    <span id="deadlineCount">0</span>명
                                    (<span id="deadlinePercent">0.0</span>%)
                                </div>
                            </div>
                        </div>
                        <!-- 프로그레스 바 -->
                        <div class="mt-4">
                            <div class="flex h-6 rounded-full overflow-hidden">
                                <div id="completedBar" class="bg-green-500 transition-all duration-500" style="width: 0%"></div>
                                <div id="inProgressBar" class="bg-yellow-500 transition-all duration-500" style="width: 0%"></div>
                                <div id="resubmitBar" class="bg-orange-500 transition-all duration-500" style="width: 0%"></div>
                                <div id="incompleteBar" class="bg-gray-500 transition-all duration-500" style="width: 100%"></div>
                                <div id="deadlineBar" class="bg-red-500 transition-all duration-500" style="width: 0%"></div>
                            </div>
                            <div class="flex justify-between mt-2 text-xs text-gray-500 dark:text-gray-400">
                                <span>0%</span>
                                <span>100%</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // 상태 상수 정의
        const STATUS = {
            INCOMPLETE: { id: 0, color: 'bg-gray-500', text: '미완료' },
            COMPLETED: { id: 1, color: 'bg-green-500', text: '완료' },
            IN_PROGRESS: { id: 2, color: 'bg-yellow-500', text: '진행중' },
            RESUBMIT: { id: 3, color: 'bg-orange-500', text: '재제출' },
            DEADLINE_PASSED: { id: 4, color: 'bg-red-500', text: '미제출마감' }
        };

        // Supabase 관련 변수
        let supabase = null;
        let userId = null;
        let teacherId = null;

        // 로컬 스토리지 키 (설정 정보만 저장)
        const STORAGE_KEYS = {
            DARK_MODE: 'darkMode',
            STUDENT_COUNT: 'studentCount',
            LAST_VIEWED: 'lastViewedChecklist',
            SUPABASE_URL: 'supabaseUrl',
            SUPABASE_KEY: 'supabaseKey',
            USER_ID: 'userId',
            TEACHER_ID: 'teacherId'
        };

        // 앱 상태 (메모리에만 저장)
        let checklists = [];
        let currentChecklistId = null;
        let isDarkMode = localStorage.getItem(STORAGE_KEYS.DARK_MODE) === 'true';

        // 상태 ID를 텍스트로 변환하는 함수
        function getStatusById(id) {
            return Object.values(STATUS).find(status => status.id === id);
        }

        // 사용자 ID 초기화
        function resetUserId() {
            localStorage.removeItem(STORAGE_KEYS.USER_ID);
            alert('사용자 ID가 초기화되었습니다. 페이지를 새로고침합니다.');
            location.reload();
        }

        // 사용자 ID 생성 (고정 ID 사용)
        function generateUserId() {
            // 고정 사용자 ID 사용 (모든 기기에서 동일)
            return 'default_user';
        }

        // Supabase 초기화
        async function initSupabase() {
            const savedUrl = localStorage.getItem(STORAGE_KEYS.SUPABASE_URL);
            const savedKey = localStorage.getItem(STORAGE_KEYS.SUPABASE_KEY);
            const savedTeacherId = localStorage.getItem(STORAGE_KEYS.TEACHER_ID);

            console.log('Initializing Supabase with:', { 
                savedUrl, 
                savedKey: savedKey ? '***' : 'none',
                savedTeacherId 
            });

            if (savedUrl && savedKey && savedTeacherId) {
                try {
                    supabase = window.supabase.createClient(savedUrl, savedKey);
                    
                    // 교사 ID 검증
                    const teacherData = await validateTeacherId(savedTeacherId);
                    if (!teacherData) {
                        throw new Error('저장된 교사 아이디가 유효하지 않습니다.');
                    }

                    teacherId = savedTeacherId;
                    
                    // 사용자 ID 생성 또는 가져오기
                    userId = localStorage.getItem(STORAGE_KEYS.USER_ID) || generateUserId();
                    localStorage.setItem(STORAGE_KEYS.USER_ID, userId);
                    
                    console.log('Teacher ID:', teacherId);
                    console.log('User ID:', userId);
                    
                    document.getElementById('configModal').style.display = 'none';
                    document.getElementById('noConnection').classList.add('hidden');
                    document.getElementById('mainContent').classList.remove('hidden');
                    
                    await loadChecklists();
                    
                    showSyncStatus('success', `${teacherData.name || teacherId}님 환영합니다!`);
                    
                    // 교사 정보 표시
                    const teacherInfoEl = document.getElementById('teacherInfo');
                    if (teacherInfoEl) {
                        teacherInfoEl.textContent = `👨‍🏫 ${teacherData.name || teacherId}`;
                    }
                    
                    setTimeout(() => hideSyncStatus(), 3000);
                } catch (error) {
                    console.error('Supabase 초기화 실패:', error);
                    showSyncStatus('error', 'Supabase 연결 실패');
                    document.getElementById('configModal').style.display = 'flex';
                    document.getElementById('noConnection').classList.remove('hidden');
                    document.getElementById('mainContent').classList.add('hidden');
                }
            } else {
                console.log('No saved Supabase config or teacher ID, showing modal');
                document.getElementById('configModal').style.display = 'flex';
                document.getElementById('noConnection').classList.remove('hidden');
                document.getElementById('mainContent').classList.add('hidden');
            }
        }

        // 교사 ID 검증
        async function validateTeacherId(inputTeacherId) {
            if (!supabase) return false;
            
            try {
                const { data, error } = await supabase
                    .from('teachers')
                    .select('teacher_id, name')
                    .eq('teacher_id', inputTeacherId)
                    .single();
                
                if (error || !data) {
                    return false;
                }
                
                return data;
            } catch (error) {
                console.error('교사 ID 검증 실패:', error);
                return false;
            }
        }

        // Supabase 설정 저장
        async function saveSupabaseConfig() {
            const url = document.getElementById('supabaseUrl').value.trim();
            const key = document.getElementById('supabaseKey').value.trim();
            const inputTeacherId = document.getElementById('teacherIdInput').value.trim();

            if (!url || !key) {
                alert('URL과 Key를 모두 입력해주세요.');
                return;
            }

            if (!inputTeacherId) {
                alert('교사 아이디를 입력해주세요.');
                return;
            }

            try {
                showSyncStatus('syncing', '연결 중...');
                
                // Supabase 클라이언트 생성 및 테스트
                const testClient = window.supabase.createClient(url, key);
                supabase = testClient; // 임시로 설정 (검증용)
                
                // 교사 ID 검증
                const teacherData = await validateTeacherId(inputTeacherId);
                if (!teacherData) {
                    throw new Error('등록되지 않은 교사 아이디입니다. 관리자에게 문의하세요.');
                }

                console.log('교사 정보:', teacherData);

                // 연결 테스트
                const { data, error } = await testClient.from('checklists').select('id').limit(1);
                
                if (error) {
                    console.error('Connection test error:', error);
                    if (error.code === 'PGRST116') {
                        throw new Error('checklists 테이블이 존재하지 않습니다. 먼저 테이블을 생성해주세요.');
                    } else if (error.code === '42501') {
                        throw new Error('권한이 없습니다. RLS 정책을 확인해주세요.');
                    } else {
                        throw new Error('연결 실패: ' + error.message);
                    }
                }

                console.log('Connection test successful');

                // 설정 저장 (로컬 스토리지)
                localStorage.setItem(STORAGE_KEYS.SUPABASE_URL, url);
                localStorage.setItem(STORAGE_KEYS.SUPABASE_KEY, key);
                localStorage.setItem(STORAGE_KEYS.TEACHER_ID, inputTeacherId);

                teacherId = inputTeacherId;
                userId = localStorage.getItem(STORAGE_KEYS.USER_ID) || generateUserId();
                localStorage.setItem(STORAGE_KEYS.USER_ID, userId);

                document.getElementById('configModal').style.display = 'none';
                document.getElementById('noConnection').classList.add('hidden');
                document.getElementById('mainContent').classList.remove('hidden');
                
                // 데이터 로드
                await loadChecklists();
                
                showSyncStatus('success', `${teacherData.name || teacherData.teacher_id}님 환영합니다!`);
                setTimeout(() => hideSyncStatus(), 3000);
            } catch (error) {
                console.error('Supabase 연결 실패:', error);
                alert('연결 실패:\n\n' + error.message + '\n\n확인사항:\n1. URL과 Key가 정확한가요?\n2. 테이블이 생성되었나요?\n3. 교사 아이디가 등록되었나요?');
                showSyncStatus('error', '연결 실패');
                setTimeout(() => hideSyncStatus(), 3000);
                supabase = null; // 실패 시 초기화
            }
        }

        // 설정 모달 표시
        function showConfig() {
            document.getElementById('teacherIdInput').value = localStorage.getItem(STORAGE_KEYS.TEACHER_ID) || '';
            document.getElementById('supabaseUrl').value = localStorage.getItem(STORAGE_KEYS.SUPABASE_URL) || '';
            document.getElementById('supabaseKey').value = localStorage.getItem(STORAGE_KEYS.SUPABASE_KEY) || '';
            document.getElementById('configModal').style.display = 'flex';
        }

        // 동기화 상태 표시
        function showSyncStatus(type, message) {
            const statusEl = document.getElementById('syncStatus');
            statusEl.className = `sync-status sync-${type}`;
            statusEl.textContent = message;
            statusEl.classList.remove('hidden');
        }

        function hideSyncStatus() {
            document.getElementById('syncStatus').classList.add('hidden');
        }

        // 체크리스트 로드
        async function loadChecklists() {
            if (!supabase) {
                console.log('Supabase not initialized');
                return;
            }

            try {
                showSyncStatus('syncing', '데이터 로드 중...');
                
                console.log('Loading checklists for teacher:', teacherId, 'user:', userId);
                
                const { data, error } = await supabase
                    .from('checklists')
                    .select('*')
                    .eq('teacher_id', teacherId)
                    .eq('user_id', userId)
                    .order('created_at', { ascending: false });

                console.log('Supabase response:', { data, error });

                if (error) {
                    console.error('Supabase load error:', error);
                    throw error;
                }

                if (!data) {
                    console.log('No data returned from Supabase');
                    checklists = [];
                } else {
                    console.log('Raw data from Supabase:', data);
                    
                    checklists = data.map(item => {
                        console.log('Processing item:', item);
                        return {
                            id: item.id,
                            n: item.name,
                            c: item.category,
                            sc: item.student_count,
                            s: item.statuses,
                            ct: item.created_at,
                            ut: item.updated_at,
                            t: item.completion_times || Array(item.student_count).fill(null)
                        };
                    });
                    
                    console.log('Processed checklists:', checklists);
                }

                hideSyncStatus();

                renderChecklistList();
                updateCategoryCheckboxes();
                
                // 마지막으로 본 체크리스트 선택
                const lastViewedId = localStorage.getItem(STORAGE_KEYS.LAST_VIEWED);
                console.log('Last viewed ID:', lastViewedId);
                
                if (lastViewedId && checklists.some(c => c.id == lastViewedId)) {
                    console.log('Selecting last viewed checklist:', lastViewedId);
                    selectChecklist(parseInt(lastViewedId));
                } else if (checklists.length > 0) {
                    console.log('Selecting first checklist:', checklists[0].id);
                    selectChecklist(checklists[0].id);
                } else {
                    console.log('No checklists to select');
                }
                
            } catch (error) {
                console.error('체크리스트 로드 실패:', error);
                showSyncStatus('error', '로드 실패: ' + error.message);
                setTimeout(() => hideSyncStatus(), 5000);
                
                // 빈 배열로 초기화
                checklists = [];
                renderChecklistList();
                updateCategoryCheckboxes();
            }
        }

        // Supabase에 체크리스트 저장
        async function saveChecklistToSupabase(checklist) {
            if (!supabase) return;

            try {
                const checklistData = {
                    id: checklist.id,
                    user_id: userId,
                    teacher_id: teacherId,
                    name: checklist.n,
                    category: checklist.c,
                    student_count: checklist.sc,
                    statuses: checklist.s,
                    completion_times: checklist.t || Array(checklist.sc).fill(null),
                    created_at: checklist.ct,
                    updated_at: new Date().toISOString()
                };

                console.log('Saving to Supabase:', checklistData);

                const { data, error } = await supabase
                    .from('checklists')
                    .upsert(checklistData, { 
                        onConflict: 'id',
                        ignoreDuplicates: false 
                    });

                if (error) {
                    console.error('Supabase error details:', error);
                    throw error;
                }

                console.log('Successfully saved to Supabase:', data);
            } catch (error) {
                console.error('Supabase 저장 실패:', error);
                throw error;
            }
        }

        // 체크리스트 생성
        async function createChecklist() {
            if (!supabase) {
                alert('Supabase에 연결되지 않았습니다. 설정을 확인해주세요.');
                return;
            }

            const studentCount = parseInt(document.getElementById('studentCount').value);
            const category = document.getElementById('categorySelect').value;
            
            if (!studentCount || studentCount <= 0) {
                alert('유효한 학생 수를 입력해주세요.');
                return;
            }
            if (studentCount > 100) {
                alert('학생 수는 최대 100명까지 입력 가능합니다.');
                return;
            }

            const now = new Date().toISOString();
            const checklist = {
                id: Date.now(),
                n: `체크리스트 ${checklists.length + 1}`,
                c: category,
                sc: studentCount,
                s: Array(studentCount).fill(0),
                ct: now,
                ut: now,
                t: Array(studentCount).fill(null)
            };

            checklists.unshift(checklist); // 메모리에만 추가
            
            try {
                showSyncStatus('syncing', '저장 중...');
                await saveChecklistToSupabase(checklist);
                showSyncStatus('success', '저장됨');
                setTimeout(() => hideSyncStatus(), 1000);
                
                renderChecklistList();
                selectChecklist(checklist.id);
                updateCategoryCheckboxes();
                
                // 학생 수 저장
                localStorage.setItem(STORAGE_KEYS.STUDENT_COUNT, studentCount);
            } catch (error) {
                console.error('체크리스트 생성 실패:', error);
                showSyncStatus('error', '저장 실패');
                setTimeout(() => hideSyncStatus(), 3000);
                // 실패 시 메모리에서 제거
                checklists.shift();
                renderChecklistList();
            }
        }

        // 카테고리 체크박스 업데이트
        function updateCategoryCheckboxes() {
            const container = document.getElementById('categoryCheckboxes');
            const categories = [...new Set(checklists.map(c => c.c))];
            container.innerHTML = categories.map(category => `
                <label class="flex items-center">
                    <input type="checkbox" value="${category}" checked 
                           class="mr-2" onchange="filterChecklists()">
                    ${category}
                </label>
            `).join('');
        }

        // 카테고리 필터 토글
        function toggleCategoryFilter() {
            const filter = document.getElementById('categoryFilter');
            filter.classList.toggle('hidden');
        }

        // 체크리스트 필터링
        function filterChecklists() {
            const checkboxes = document.querySelectorAll('#categoryFilter input[type="checkbox"]');
            const selectedCategories = Array.from(checkboxes)
                .filter(cb => cb.checked)
                .map(cb => cb.value);

            const listContainer = document.getElementById('checklistList');
            const items = listContainer.getElementsByClassName('checklist-item');
            
            Array.from(items).forEach(item => {
                const category = item.dataset.category;
                if (selectedCategories.includes('all') || selectedCategories.includes(category)) {
                    item.classList.remove('hidden');
                } else {
                    item.classList.add('hidden');
                }
            });
        }

        // 체크리스트 목록 렌더링
        function renderChecklistList() {
            const listContainer = document.getElementById('checklistList');
            
            console.log('Rendering checklist list, checklists count:', checklists.length);
            console.log('Checklists data:', checklists);
            
            if (checklists.length === 0) {
                listContainer.innerHTML = '<div class="text-center text-gray-500 dark:text-gray-400 py-4">체크리스트가 없습니다.</div>';
                return;
            }
            
            listContainer.innerHTML = checklists.map((checklist, index) => {
                const truncatedTitle = checklist.n.length > 15 ? checklist.n.substring(0, 15) + '...' : checklist.n;
                return `
                <div class="checklist-item flex items-center p-2 bg-gray-50 rounded cursor-pointer hover:bg-gray-100 ${currentChecklistId === checklist.id ? 'bg-blue-100 dark:bg-blue-900' : ''} dark:bg-gray-700 dark:hover:bg-gray-600"
                     onclick="selectChecklist(${checklist.id})"
                     data-category="${checklist.c}">
                    <div class="flex-1 flex items-center gap-2 min-w-0">
                        <span class="flex-shrink-0 px-2 py-0.5 text-xs rounded-full bg-gray-200 dark:bg-gray-600 text-gray-600 dark:text-gray-300">${checklist.c}</span>
                        <span class="truncate dark:text-gray-100 flex-1 min-w-0" title="${checklist.n}">${truncatedTitle}</span>
                    </div>
                </div>
            `}).join('');
            
            console.log('Rendered HTML:', listContainer.innerHTML);
        }

        // 체크리스트 선택
        function selectChecklist(id) {
            currentChecklistId = id;
            localStorage.setItem(STORAGE_KEYS.LAST_VIEWED, id);
            
            const checklist = checklists.find(c => c.id === id);
            if (checklist) {
                document.getElementById('checklistActions').classList.remove('hidden');
                document.getElementById('statistics').classList.remove('hidden');
                document.getElementById('checklistTitle').value = checklist.n;
                
                // 카테고리 선택 옵션 업데이트
                const categorySelect = document.getElementById('editCategorySelect');
                categorySelect.value = checklist.c;
                
                // 생성/수정 시각 표시 (한국 시간)
                const createdAt = new Date(checklist.ct);
                const updatedAt = new Date(checklist.ut);
                
                const createdKST = createdAt.toLocaleString('ko-KR', {
                    timeZone: 'Asia/Seoul',
                    year: 'numeric',
                    month: '2-digit',
                    day: '2-digit',
                    hour: '2-digit',
                    minute: '2-digit',
                    second: '2-digit',
                    hour12: false
                });
                
                const updatedKST = updatedAt.toLocaleString('ko-KR', {
                    timeZone: 'Asia/Seoul',
                    year: 'numeric',
                    month: '2-digit',
                    day: '2-digit',
                    hour: '2-digit',
                    minute: '2-digit',
                    second: '2-digit',
                    hour12: false
                });
                
                document.getElementById('checklistInfo').innerHTML = `
                    생성: ${createdKST} | 
                    수정: ${updatedKST}
                `;

                renderChecklistContent(checklist);
                updateStatistics(checklist);
                renderChecklistList();
            }
        }

        // 현재 체크리스트 업데이트
        async function updateCurrentChecklist() {
            if (!currentChecklistId || !supabase) return;
            
            const newName = document.getElementById('checklistTitle').value;
            const newCategory = document.getElementById('editCategorySelect').value;
            const checklist = checklists.find(c => c.id === currentChecklistId);
            
            if (checklist) {
                checklist.n = newName;
                checklist.c = newCategory;
                checklist.ut = new Date().toISOString();
                
                try {
                    showSyncStatus('syncing', '저장 중...');
                    await saveChecklistToSupabase(checklist);
                    showSyncStatus('success', '저장됨');
                    setTimeout(() => hideSyncStatus(), 1000);
                    
                    renderChecklistList();
                    selectChecklist(currentChecklistId);
                    updateCategoryCheckboxes();
                } catch (error) {
                    console.error('업데이트 실패:', error);
                    showSyncStatus('error', '저장 실패');
                    setTimeout(() => hideSyncStatus(), 3000);
                }
            }
        }

        // 현재 체크리스트 삭제
        async function deleteCurrentChecklist() {
            if (!currentChecklistId || !supabase) return;
            
            if (confirm('정말 삭제하시겠습니까?')) {
                try {
                    showSyncStatus('syncing', '삭제 중...');
                    const { error } = await supabase
                        .from('checklists')
                        .delete()
                        .eq('id', currentChecklistId)
                        .eq('teacher_id', teacherId)
                        .eq('user_id', userId);
                    
                    if (error) throw error;
                    
                    showSyncStatus('success', '삭제됨');
                    setTimeout(() => hideSyncStatus(), 1000);
                    
                    checklists = checklists.filter(c => c.id !== currentChecklistId);
                    
                    currentChecklistId = null;
                    document.getElementById('checklistActions').classList.add('hidden');
                    document.getElementById('statistics').classList.add('hidden');
                    document.getElementById('checklistContent').innerHTML = '';
                    document.getElementById('checklistTitle').value = '';
                    document.getElementById('checklistInfo').innerHTML = '';
                    
                    renderChecklistList();
                    updateCategoryCheckboxes();
                } catch (error) {
                    console.error('삭제 실패:', error);
                    showSyncStatus('error', '삭제 실패');
                    setTimeout(() => hideSyncStatus(), 3000);
                }
            }
        }

        // 상태 변경
        async function changeStatus(checklistId, studentIndex) {
            if (!supabase) return;

            const checklist = checklists.find(c => c.id === checklistId);
            if (checklist) {
                const currentStatusId = checklist.s[studentIndex];
                const statusKeys = Object.values(STATUS);
                const currentIndex = statusKeys.findIndex(status => status.id === currentStatusId);
                const nextIndex = (currentIndex + 1) % statusKeys.length;
                const nextStatus = statusKeys[nextIndex];
                
                checklist.s[studentIndex] = nextStatus.id;
                
                // 완료 상태로 변경될 때 시간 기록
                if (nextStatus.id === 1) { // COMPLETED
                    checklist.t[studentIndex] = new Date().toISOString();
                } else if (currentStatusId === 1) { // 완료에서 다른 상태로 변경될 때
                    checklist.t[studentIndex] = null;
                }
                
                checklist.ut = new Date().toISOString();
                
                try {
                    await saveChecklistToSupabase(checklist);
                    renderChecklistContent(checklist);
                    updateStatistics(checklist);
                } catch (error) {
                    console.error('상태 변경 실패:', error);
                    showSyncStatus('error', '저장 실패');
                    setTimeout(() => hideSyncStatus(), 3000);
                }
            }
        }

        // 통계 업데이트
        function updateStatistics(checklist) {
            const total = checklist.s.length;
            const counts = { 0: 0, 1: 0, 2: 0, 3: 0, 4: 0 };

            checklist.s.forEach(statusId => {
                counts[statusId]++;
            });

            // 각 상태별 카운트와 퍼센트 업데이트
            const statusMapping = {
                0: { countId: 'incompleteCount', percentId: 'incompletePercent', barId: 'incompleteBar' },
                1: { countId: 'completedCount', percentId: 'completedPercent', barId: 'completedBar' },
                2: { countId: 'inProgressCount', percentId: 'inProgressPercent', barId: 'inProgressBar' },
                3: { countId: 'resubmitCount', percentId: 'resubmitPercent', barId: 'resubmitBar' },
                4: { countId: 'deadlineCount', percentId: 'deadlinePercent', barId: 'deadlineBar' }
            };

            Object.entries(counts).forEach(([statusId, count]) => {
                const percent = total > 0 ? ((count / total) * 100).toFixed(1) : '0.0';
                const { countId, percentId, barId } = statusMapping[statusId];
                
                document.getElementById(countId).textContent = count;
                document.getElementById(percentId).textContent = percent;
                document.getElementById(barId).style.width = `${percent}%`;
            });

            // 완료 순위 표시
            const completionOrder = checklist.t
                .map((time, index) => ({ index, time }))
                .filter(item => item.time !== null)
                .sort((a, b) => new Date(a.time) - new Date(b.time))
                .slice(0, 5);

            // 기존 순위 섹션 제거
            const statisticsSection = document.getElementById('statistics');
            const existingRanking = statisticsSection.querySelector('.ranking-section');
            if (existingRanking) {
                existingRanking.remove();
            }

            if (completionOrder.length > 0) {
                const rankingHtml = `
                    <div class="ranking-section mt-4 p-3 bg-gray-50 dark:bg-gray-700 rounded-lg">
                        <h4 class="text-sm font-semibold dark:text-gray-100 mb-2">🏆 완료 순위 (상위 5명)</h4>
                        <div class="space-y-1">
                            ${completionOrder.map((item, index) => {
                                const completionTime = new Date(item.time);
                                // 한국 시간으로 변환
                                const koreanTime = completionTime.toLocaleString('ko-KR', {
                                    timeZone: 'Asia/Seoul',
                                    hour: '2-digit',
                                    minute: '2-digit',
                                    second: '2-digit',
                                    hour12: false
                                });
                                
                                return `
                                <div class="flex items-center justify-between text-sm">
                                    <span class="dark:text-gray-100">
                                        ${index + 1}위: ${item.index + 1}번
                                    </span>
                                    <span class="text-gray-500 dark:text-gray-400">
                                        ${koreanTime}
                                    </span>
                                </div>
                            `}).join('')}
                        </div>
                    </div>
                `;
                statisticsSection.insertAdjacentHTML('beforeend', rankingHtml);
            }
        }

        // 체크리스트 내용 렌더링
        function renderChecklistContent(checklist) {
            const contentContainer = document.getElementById('checklistContent');
            
            contentContainer.innerHTML = checklist.s.map((statusId, index) => {
                const status = getStatusById(statusId);
                
                return `
                    <div class="flex flex-col items-center">
                        <span class="text-sm mb-1 dark:text-gray-100">${index + 1}번</span>
                        <button class="status-btn ${status.color} text-white rounded hover:opacity-90 w-full"
                                onclick="changeStatus(${checklist.id}, ${index})">
                            ${status.text}
                        </button>
                    </div>
                `;
            }).join('');
        }

        // 체크리스트 내보내기 (JSON 형태로)
        function exportChecklists() {
            if (checklists.length === 0) {
                alert('내보낼 체크리스트가 없습니다.');
                return;
            }

            const now = new Date();
            const dateStr = now.toISOString().slice(0, 19).replace(/[:]/g, '-');
            const fileName = `체크리스트_${dateStr}.json`;
            
            const dataStr = JSON.stringify(checklists, null, 2);
            const dataUri = 'data:application/json;charset=utf-8,'+ encodeURIComponent(dataStr);
            
            const linkElement = document.createElement('a');
            linkElement.setAttribute('href', dataUri);
            linkElement.setAttribute('download', fileName);
            linkElement.click();
        }

        // 체크리스트 가져오기
        async function importChecklists(event) {
            const file = event.target.files[0];
            if (!file || !supabase) return;

            const reader = new FileReader();
            reader.onload = async function(e) {
                try {
                    const importedChecklists = JSON.parse(e.target.result);
                    
                    if (!Array.isArray(importedChecklists)) {
                        throw new Error('유효하지 않은 체크리스트 파일입니다.');
                    }

                    if (confirm('기존 체크리스트를 모두 덮어쓰시겠습니까?')) {
                        showSyncStatus('syncing', '가져오기 중...');
                        
                        // 기존 데이터 삭제
                        const { error: deleteError } = await supabase
                            .from('checklists')
                            .delete()
                            .eq('user_id', userId);
                        
                        if (deleteError) throw deleteError;
                        
                        // 새 데이터 저장
                        for (const checklist of importedChecklists) {
                            await saveChecklistToSupabase(checklist);
                        }
                        
                        showSyncStatus('success', '가져오기 완료');
                        setTimeout(() => hideSyncStatus(), 2000);
                        
                        // 데이터 다시 로드
                        await loadChecklists();
                    }
                } catch (error) {
                    console.error('가져오기 실패:', error);
                    alert('파일 가져오기에 실패했습니다: ' + error.message);
                    showSyncStatus('error', '가져오기 실패');
                    setTimeout(() => hideSyncStatus(), 3000);
                }
            };
            reader.readAsText(file);
            
            // 파일 입력 초기화
            event.target.value = '';
        }

        // 다크모드 토글
        function toggleDarkMode() {
            isDarkMode = !isDarkMode;
            if (isDarkMode) {
                document.documentElement.classList.add('dark');
                document.getElementById('darkModeIcon').textContent = '☀️';
            } else {
                document.documentElement.classList.remove('dark');
                document.getElementById('darkModeIcon').textContent = '🌙';
            }
            localStorage.setItem(STORAGE_KEYS.DARK_MODE, isDarkMode);
        }

        // 시계 업데이트
        function updateClock() {
            const now = new Date();
            document.getElementById('clock').textContent = now.toLocaleTimeString();
        }

        // 초기화
        async function init() {
            // 다크모드 설정
            if (isDarkMode) {
                document.documentElement.classList.add('dark');
                document.getElementById('darkModeIcon').textContent = '☀️';
            }

            // 시계 시작
            updateClock();
            setInterval(updateClock, 1000);

            // 저장된 학생 수 불러오기
            const savedCount = localStorage.getItem(STORAGE_KEYS.STUDENT_COUNT);
            if (savedCount) {
                document.getElementById('studentCount').value = savedCount;
            }

            // Supabase 초기화
            await initSupabase();
        }

        // 페이지 로드 시 초기화
        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>