<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì²´í¬ë¦¬ìŠ¤íŠ¸ ì•± - Supabase ì „ìš©</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        dark: {
                            bg: '#1a1a1a',
                            card: '#2d2d2d',
                            text: '#e5e5e5',
                            border: '#404040'
                        }
                    }
                }
            }
        }
    </script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard@v1.3.9/dist/web/variable/pretendardvariable.min.css">
    <style>
        body {
            font-family: 'Pretendard Variable', -apple-system, BlinkMacSystemFont, system-ui, Roboto, 'Helvetica Neue', 'Segoe UI', 'Apple SD Gothic Neo', 'Noto Sans KR', 'Malgun Gothic', 'Apple Color Emoji', 'Segoe UI Emoji', 'Segoe UI Symbol', sans-serif;
            transition: background-color 0.3s, color 0.3s;
        }
        .student-card {
            min-width: 80px;
            transition: all 0.2s ease;
            border: 2px solid transparent;
            position: relative;
        }
        .student-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            border-color: rgba(59, 130, 246, 0.3);
        }
        .student-number {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            font-weight: bold;
            font-size: 0.9rem;
            padding: 8px 12px;
            border-radius: 8px 8px 0 0;
            text-align: center;
            min-height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            text-shadow: 0 1px 2px rgba(0,0,0,0.2);
        }
        .dark .student-number {
            background: linear-gradient(135deg, #8B5CF6 0%, #06B6D4 100%);
        }
        .status-btn {
            min-height: 80px;
            transition: all 0.2s ease;
            font-weight: 600;
            font-size: 0.9rem;
            border-radius: 0 0 8px 8px;
            border: none;
            cursor: pointer;
            position: relative;
            overflow: hidden;
        }
        .status-btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
            transition: left 0.5s;
        }
        .status-btn:hover::before {
            left: 100%;
        }
        .status-btn:active {
            transform: scale(0.98);
        }
        .icon-btn {
            @apply p-2 rounded hover:bg-gray-100 dark:hover:bg-gray-600 transition-colors;
        }
        .main-title {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            text-shadow: 0 2px 4px rgba(0,0,0,0.1);
            position: relative;
        }
        .dark .main-title {
            background: linear-gradient(135deg, #8B5CF6 0%, #06B6D4 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        .title-badge {
            background: linear-gradient(135deg, #667eea20, #764ba240);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255,255,255,0.2);
        }
        .dark .title-badge {
            background: linear-gradient(135deg, #8B5CF620, #06B6D440);
            border: 1px solid rgba(255,255,255,0.1);
        }
        .sync-status {
            @apply text-xs px-2 py-1 rounded-full;
        }
        .sync-success { @apply bg-green-100 text-green-800 dark:bg-green-900 dark:text-green-300; }
        .sync-error { @apply bg-red-100 text-red-800 dark:bg-red-900 dark:text-red-300; }
        .sync-syncing { @apply bg-blue-100 text-blue-800 dark:bg-blue-900 dark:text-blue-300; }
        .loading {
            @apply opacity-50 pointer-events-none;
        }
        .ranking-badge {
            position: absolute;
            top: -8px;
            right: -8px;
            background: linear-gradient(135deg, #fbbf24, #f59e0b);
            color: white;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.7rem;
            font-weight: bold;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }
        .student-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
            gap: 16px;
            padding: 8px;
        }
        @media (max-width: 640px) {
            .student-grid {
                grid-template-columns: repeat(auto-fill, minmax(80px, 1fr));
                gap: 8px;
            }
        }
    </style>
</head>
<body class="bg-gray-100 dark:bg-gray-900 min-h-screen">
    <!-- êµì‚¬ ë¡œê·¸ì¸ ëª¨ë‹¬ -->
    <div id="configModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-xl max-w-md w-full mx-4">
            <h2 class="text-xl font-bold mb-4 dark:text-white">êµì‚¬ ë¡œê·¸ì¸</h2>
            <div class="text-sm text-gray-600 dark:text-gray-400 mb-4">
                <p>ë“±ë¡ëœ êµì‚¬ ì•„ì´ë””ë¡œ ë¡œê·¸ì¸í•˜ì„¸ìš”.</p>
                <p class="mt-2 text-xs">âš ï¸ êµì‚¬ ë¡œê·¸ì¸ ì—†ì´ëŠ” ì‚¬ìš©í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</p>
            </div>
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium mb-2 dark:text-white">êµì‚¬ ì•„ì´ë””</label>
                    <input type="text" id="teacherIdInput" 
                           placeholder="êµì‚¬ ì•„ì´ë””ë¥¼ ì…ë ¥í•˜ì„¸ìš”" 
                           class="w-full p-2 border rounded dark:bg-gray-700 dark:border-gray-600 dark:text-white">
                </div>
                <div class="flex gap-2">
                    <button onclick="teacherLogin()" 
                            class="flex-1 bg-blue-500 text-white p-2 rounded hover:bg-blue-600 transition-colors">
                        ë¡œê·¸ì¸
                    </button>
                    <button onclick="resetUserId()" 
                            class="px-4 bg-gray-500 text-white p-2 rounded hover:bg-gray-600 transition-colors text-sm">
                        ID ì´ˆê¸°í™”
                    </button>
                </div>
            </div>
        </div>
    </div>

    <div class="container mx-auto p-4">
        <!-- í”„ë¡œê·¸ë¨ ì œëª© -->
        <div class="text-center mb-8 mt-6">
            <div class="inline-block mb-4">
                <h1 class="main-title text-5xl font-bold mb-2">ë‹¤ í–ˆì–´ìš”!</h1>
                <div class="w-full h-1 bg-gradient-to-r from-blue-500 via-purple-500 to-blue-500 rounded-full"></div>
            </div>
            <p class="title-badge text-gray-700 dark:text-gray-200 font-medium rounded-full px-6 py-3 inline-block shadow-lg">
                ğŸ“‹ í•™ê¸‰ ì²´í¬ë¦¬ìŠ¤íŠ¸ ê´€ë¦¬ ì‹œìŠ¤í…œ
            </p>
        </div>
        
        <div class="flex justify-end mb-4">
            <div class="flex items-center gap-4">
                <div id="syncStatus" class="sync-status hidden">ë™ê¸°í™” ì¤‘...</div>
                <div id="teacherInfo" class="text-sm text-gray-600 dark:text-gray-400"></div>
                <span class="clock text-gray-900 dark:text-white" id="clock"></span>
                <button class="flex items-center gap-2 px-3 py-2 rounded border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-800 hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors text-gray-900 dark:text-white" 
                        onclick="toggleDarkMode()">
                    <span id="darkModeIcon">ğŸŒ™</span>
                    <span>ë‹¤í¬ëª¨ë“œ</span>
                </button>
                <button onclick="showConfig()" 
                        class="flex items-center gap-2 px-3 py-2 rounded border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-800 hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors text-gray-900 dark:text-white">
                    ğŸ‘¨â€ğŸ« êµì‚¬ ë³€ê²½
                </button>
            </div>
        </div>
        
        <div class="flex gap-4">
            <!-- ì¢Œì¸¡ ì²´í¬ë¦¬ìŠ¤íŠ¸ ëª©ë¡ -->
            <div class="w-1/4 bg-white dark:bg-gray-800 rounded-lg shadow p-4">
                <h2 class="text-xl font-bold mb-4 dark:text-gray-100">Checklist</h2>
                <div class="mb-4">
                    <input type="number" id="studentCount" placeholder="í•™ìƒ ìˆ˜ ì…ë ¥ (ìµœëŒ€ 100ëª…)" 
                           class="w-full p-2 border rounded-full mb-2 bg-white dark:bg-gray-700 dark:border-gray-600 dark:text-gray-100" 
                           min="1" max="100">
                    <select id="categorySelect" class="w-full p-2 border rounded-full mb-2 bg-white dark:bg-gray-700 dark:border-gray-600 dark:text-gray-100">
                        <option value="ì¼ë°˜">ğŸ—’ï¸ ì¼ë°˜</option>
                        <option value="êµ­ì–´">ğŸ“’ êµ­ì–´</option>
                        <option value="ìˆ˜í•™">ğŸ§® ìˆ˜í•™</option>
                        <option value="ì‚¬íšŒ">ğŸ‘¥ ì‚¬íšŒ</option>
                        <option value="ê³¼í•™">ğŸ”¬ ê³¼í•™</option>
                        <option value="ì˜ì–´">ğŸ‡ºğŸ‡¸ ì˜ì–´</option>
                        <option value="ë„ë•">ğŸ¤ ë„ë•</option>
                        <option value="ì‹¤ê³¼">ğŸ§¶ ì‹¤ê³¼</option>
                        <option value="ìŒì•…">ğŸµ ìŒì•…</option>
                        <option value="ë¯¸ìˆ ">ğŸ¨ ë¯¸ìˆ </option>
                        <option value="ì²´ìœ¡">ğŸƒ ì²´ìœ¡</option>
                        <option value="ì°½ì²´">ğŸ‘¥ ì°½ì²´</option>
                        <option value="ì•„ì¹¨í™œë™">ğŸŒ ì•„ì¹¨í™œë™</option>
                        <option value="ë…ì„œ">ğŸ¤“ ë…ì„œ</option>
                        <option value="ê¸°íƒ€">ğŸ¤” ê¸°íƒ€</option>
                    </select>
                    <button id="createChecklist" 
                            class="w-full bg-blue-500 text-white p-2 rounded hover:bg-blue-600 flex items-center justify-center gap-2 transition-colors"
                            onclick="createChecklist()">
                        â• ì¶”ê°€
                    </button>
                </div>
                <div class="mb-4">
                    <div class="flex items-center justify-between mb-2">
                        <h3 class="font-semibold dark:text-gray-100">ëª©ë¡</h3>
                        <button onclick="toggleCategoryFilter()" class="icon-btn dark:text-white">
                            ğŸ”
                        </button>
                    </div>
                    <div id="categoryFilter" class="hidden space-y-1">
                        <label class="flex items-center dark:text-white">
                            <input type="checkbox" value="all" checked class="mr-2" onchange="filterChecklists()">
                            ì „ì²´
                        </label>
                        <div id="categoryCheckboxes" class="space-y-1 dark:text-white"></div>
                    </div>
                </div>
                <div id="checklistList" class="space-y-2"></div>
                <div class="text-center text-xs text-gray-400 dark:text-gray-500 mt-4">
                    <div id="storageInfo" class="mt-1">â˜ï¸ Supabase</div>
                </div>
            </div>

            <!-- ìš°ì¸¡ ì²´í¬ë¦¬ìŠ¤íŠ¸ ë‚´ìš© -->
            <div class="w-3/4 bg-white dark:bg-gray-800 rounded-lg shadow p-4">
                <div id="noConnection" class="text-center py-8 text-gray-500 dark:text-gray-400">
                    <div class="text-4xl mb-4">ğŸ‘¨â€ğŸ«</div>
                    <div class="text-lg font-semibold mb-2">êµì‚¬ ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤</div>
                    <div class="text-sm">êµì‚¬ ë³€ê²½ ë²„íŠ¼ì„ í´ë¦­í•˜ì—¬ ë¡œê·¸ì¸í•˜ì„¸ìš”.</div>
                </div>
                
                <div id="mainContent" class="hidden">
                    <div class="flex justify-between items-center mb-4">
                        <div class="flex-1">
                            <div class="flex items-center gap-2">
                                <select id="editCategorySelect" 
                                        class="p-2 border rounded-full bg-white dark:bg-gray-700 dark:border-gray-600 dark:text-gray-100" 
                                        onchange="updateCurrentChecklist()">
                                    <option value="ì¼ë°˜">ğŸ—’ï¸ ì¼ë°˜</option>
                                    <option value="êµ­ì–´">ğŸ“’ êµ­ì–´</option>
                                    <option value="ìˆ˜í•™">ğŸ§® ìˆ˜í•™</option>
                                    <option value="ì‚¬íšŒ">ğŸ‘¥ ì‚¬íšŒ</option>
                                    <option value="ê³¼í•™">ğŸ”¬ ê³¼í•™</option>
                                    <option value="ì˜ì–´">ğŸ‡ºğŸ‡¸ ì˜ì–´</option>
                                    <option value="ë„ë•">ğŸ¤ ë„ë•</option>
                                    <option value="ì‹¤ê³¼">ğŸ§¶ ì‹¤ê³¼</option>
                                    <option value="ìŒì•…">ğŸµ ìŒì•…</option>
                                    <option value="ë¯¸ìˆ ">ğŸ¨ ë¯¸ìˆ </option>
                                    <option value="ì²´ìœ¡">ğŸƒ ì²´ìœ¡</option>
                                    <option value="ì°½ì²´">ğŸ‘¥ ì°½ì²´</option>
                                    <option value="ì•„ì¹¨í™œë™">ğŸŒ ì•„ì¹¨í™œë™</option>
                                    <option value="ë…ì„œ">ğŸ¤“ ë…ì„œ</option>
                                    <option value="ê¸°íƒ€">ğŸ¤” ê¸°íƒ€</option>
                                </select>
                                <input type="text" id="checklistTitle" 
                                       class="flex-1 text-xl font-bold bg-transparent border-b border-transparent hover:border-gray-300 focus:border-blue-500 focus:outline-none px-1 dark:text-gray-100 dark:border-gray-600" 
                                       onchange="updateCurrentChecklist()">
                            </div>
                            <div id="checklistInfo" class="text-sm text-gray-400 dark:text-gray-500 mt-1"></div>
                        </div>
                        <div id="checklistActions" class="hidden">
                            <button onclick="deleteCurrentChecklist()" 
                                    class="icon-btn text-red-500 hover:bg-red-100 dark:hover:bg-red-900">
                                ğŸ—‘ï¸
                            </button>
                        </div>
                    </div>
                    
                    <div id="checklistContent" class="student-grid mb-6"></div>
                    
                    <!-- í†µê³„ ì„¹ì…˜ -->
                    <div id="statistics" class="border-t border-gray-200 dark:border-gray-600 pt-4 hidden">
                        <h3 class="text-lg font-semibold mb-3 dark:text-gray-100">ìƒíƒœë³„ í†µê³„</h3>
                        <div class="grid grid-cols-5 gap-4 mb-4">
                            <div class="text-center">
                                <div class="bg-green-500 text-white p-2 rounded mb-1">ì™„ë£Œ</div>
                                <div class="text-sm dark:text-gray-100">
                                    <span id="completedCount">0</span>ëª…
                                    (<span id="completedPercent">0.0</span>%)
                                </div>
                            </div>
                            <div class="text-center">
                                <div class="bg-yellow-500 text-white p-2 rounded mb-1">ì§„í–‰ì¤‘</div>
                                <div class="text-sm dark:text-gray-100">
                                    <span id="inProgressCount">0</span>ëª…
                                    (<span id="inProgressPercent">0.0</span>%)
                                </div>
                            </div>
                            <div class="text-center">
                                <div class="bg-orange-500 text-white p-2 rounded mb-1">ì¬ì œì¶œ</div>
                                <div class="text-sm dark:text-gray-100">
                                    <span id="resubmitCount">0</span>ëª…
                                    (<span id="resubmitPercent">0.0</span>%)
                                </div>
                            </div>
                            <div class="text-center">
                                <div class="bg-gray-500 text-white p-2 rounded mb-1">ë¯¸ì™„ë£Œ</div>
                                <div class="text-sm dark:text-gray-100">
                                    <span id="incompleteCount">0</span>ëª…
                                    (<span id="incompletePercent">0.0</span>%)
                                </div>
                            </div>
                            <div class="text-center">
                                <div class="bg-red-500 text-white p-2 rounded mb-1">ë¯¸ì œì¶œë§ˆê°</div>
                                <div class="text-sm dark:text-gray-100">
                                    <span id="deadlineCount">0</span>ëª…
                                    (<span id="deadlinePercent">0.0</span>%)
                                </div>
                            </div>
                        </div>
                        <!-- í”„ë¡œê·¸ë ˆìŠ¤ ë°” -->
                        <div class="mt-4">
                            <div class="flex h-6 rounded-full overflow-hidden">
                                <div id="completedBar" class="bg-green-500 transition-all duration-500" style="width: 0%"></div>
                                <div id="inProgressBar" class="bg-yellow-500 transition-all duration-500" style="width: 0%"></div>
                                <div id="resubmitBar" class="bg-orange-500 transition-all duration-500" style="width: 0%"></div>
                                <div id="incompleteBar" class="bg-gray-500 transition-all duration-500" style="width: 100%"></div>
                                <div id="deadlineBar" class="bg-red-500 transition-all duration-500" style="width: 0%"></div>
                            </div>
                            <div class="flex justify-between mt-2 text-xs text-gray-500 dark:text-gray-400">
                                <span>0%</span>
                                <span>100%</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ìƒíƒœ ìƒìˆ˜ ì •ì˜
        const STATUS = {
            INCOMPLETE: { id: 0, color: 'bg-gray-500', text: 'ë¯¸ì™„ë£Œ' },
            COMPLETED: { id: 1, color: 'bg-green-500', text: 'ì™„ë£Œ' },
            IN_PROGRESS: { id: 2, color: 'bg-yellow-500', text: 'ì§„í–‰ì¤‘' },
            RESUBMIT: { id: 3, color: 'bg-orange-500', text: 'ì¬ì œì¶œ' },
            DEADLINE_PASSED: { id: 4, color: 'bg-red-500', text: 'ë¯¸ì œì¶œë§ˆê°' }
        };

        // ê³ ì •ëœ Supabase ì„¤ì •
        const SUPABASE_CONFIG = {
            URL: 'https://prujjupqzvxbrybzjump.supabase.co',
            ANON_KEY: 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InBydWpqdXBxenZ4YnJ5YnpqdW1wIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDk3ODI1NDksImV4cCI6MjA2NTM1ODU0OX0.n9-c_IgKpvzy__YK5_b2cekOit_LW3AnK4cIz2iDOPU'
        };

        // ì „ì—­ ë³€ìˆ˜
        let supabase = null;
        let userId = null;
        let teacherId = null;
        let checklists = [];
        let currentChecklistId = null;
        let isDarkMode = localStorage.getItem('darkMode') === 'true';

        // ë¡œì»¬ ìŠ¤í† ë¦¬ì§€ í‚¤
        const STORAGE_KEYS = {
            DARK_MODE: 'darkMode',
            STUDENT_COUNT: 'studentCount',
            LAST_VIEWED: 'lastViewedChecklist',
            USER_ID: 'userId',
            TEACHER_ID: 'teacherId'
        };

        // ìƒíƒœ IDë¥¼ í…ìŠ¤íŠ¸ë¡œ ë³€í™˜í•˜ëŠ” í•¨ìˆ˜
        function getStatusById(id) {
            return Object.values(STATUS).find(status => status.id === id);
        }

        // ì‚¬ìš©ì ID ìƒì„±
        function generateUserId() {
            return 'default_user';
        }

        // ë™ê¸°í™” ìƒíƒœ í‘œì‹œ
        function showSyncStatus(type, message) {
            const statusEl = document.getElementById('syncStatus');
            statusEl.className = `sync-status sync-${type}`;
            statusEl.textContent = message;
            statusEl.classList.remove('hidden');
        }

        function hideSyncStatus() {
            document.getElementById('syncStatus').classList.add('hidden');
        }

        // ì‚¬ìš©ì ID ì´ˆê¸°í™”
        function resetUserId() {
            localStorage.removeItem(STORAGE_KEYS.USER_ID);
            localStorage.removeItem(STORAGE_KEYS.TEACHER_ID);
            alert('ì‚¬ìš©ì IDê°€ ì´ˆê¸°í™”ë˜ì—ˆìŠµë‹ˆë‹¤. í˜ì´ì§€ë¥¼ ìƒˆë¡œê³ ì¹¨í•©ë‹ˆë‹¤.');
            location.reload();
        }

        // êµì‚¬ ID ê²€ì¦
        async function validateTeacherId(inputTeacherId) {
            console.log('Validating teacher ID:', inputTeacherId);
            
            if (!supabase) {
                console.log('Supabase not initialized');
                return false;
            }
            
            try {
                const { data, error } = await supabase
                    .from('teachers')
                    .select('teacher_id, name')
                    .eq('teacher_id', inputTeacherId)
                    .single();
                
                console.log('Teacher validation result:', { data, error });
                
                if (error || !data) {
                    console.log('Teacher validation failed:', error);
                    return false;
                }
                
                console.log('Teacher validation success:', data);
                return data;
            } catch (error) {
                console.error('êµì‚¬ ID ê²€ì¦ ì‹¤íŒ¨:', error);
                return false;
            }
        }

        // êµì‚¬ ë¡œê·¸ì¸
        async function teacherLogin() {
            const inputTeacherId = document.getElementById('teacherIdInput').value.trim();

            if (!inputTeacherId) {
                alert('êµì‚¬ ì•„ì´ë””ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                return;
            }

            try {
                showSyncStatus('syncing', 'ë¡œê·¸ì¸ ì¤‘...');
                
                // ê³ ì •ëœ Supabase ì„¤ì •ìœ¼ë¡œ í´ë¼ì´ì–¸íŠ¸ ìƒì„±
                if (!supabase) {
                    supabase = window.supabase.createClient(SUPABASE_CONFIG.URL, SUPABASE_CONFIG.ANON_KEY);
                }
                
                // êµì‚¬ ID ê²€ì¦
                const teacherData = await validateTeacherId(inputTeacherId);
                if (!teacherData) {
                    throw new Error('ë“±ë¡ë˜ì§€ ì•Šì€ êµì‚¬ ì•„ì´ë””ì…ë‹ˆë‹¤. ê´€ë¦¬ìì—ê²Œ ë¬¸ì˜í•˜ì„¸ìš”.');
                }

                console.log('êµì‚¬ ì •ë³´:', teacherData);

                // êµì‚¬ ID ì €ì¥
                localStorage.setItem(STORAGE_KEYS.TEACHER_ID, inputTeacherId);
                teacherId = inputTeacherId;
                
                userId = localStorage.getItem(STORAGE_KEYS.USER_ID) || generateUserId();
                localStorage.setItem(STORAGE_KEYS.USER_ID, userId);

                document.getElementById('configModal').style.display = 'none';
                document.getElementById('noConnection').classList.add('hidden');
                document.getElementById('mainContent').classList.remove('hidden');
                
                // êµì‚¬ ì •ë³´ í‘œì‹œ
                document.getElementById('teacherInfo').textContent = `ğŸ‘¨â€ğŸ« ${teacherData.name || teacherId}`;
                
                // ë°ì´í„° ë¡œë“œ
                await loadChecklists();
                
                showSyncStatus('success', `${teacherData.name || teacherData.teacher_id}ë‹˜ í™˜ì˜í•©ë‹ˆë‹¤!`);
                setTimeout(() => hideSyncStatus(), 3000);
            } catch (error) {
                console.error('êµì‚¬ ë¡œê·¸ì¸ ì‹¤íŒ¨:', error);
                alert('ë¡œê·¸ì¸ ì‹¤íŒ¨:\n\n' + error.message);
                showSyncStatus('error', 'ë¡œê·¸ì¸ ì‹¤íŒ¨');
                setTimeout(() => hideSyncStatus(), 3000);
            }
        }

        // ì„¤ì • ëª¨ë‹¬ í‘œì‹œ
        function showConfig() {
            document.getElementById('teacherIdInput').value = localStorage.getItem(STORAGE_KEYS.TEACHER_ID) || '';
            document.getElementById('configModal').style.display = 'flex';
        }

        // Supabase ì´ˆê¸°í™”
        async function initSupabase() {
            const savedTeacherId = localStorage.getItem(STORAGE_KEYS.TEACHER_ID);

            console.log('Initializing Supabase with teacher ID:', savedTeacherId);

            // ê³ ì •ëœ Supabase ì„¤ì •ìœ¼ë¡œ í´ë¼ì´ì–¸íŠ¸ ìƒì„±
            supabase = window.supabase.createClient(SUPABASE_CONFIG.URL, SUPABASE_CONFIG.ANON_KEY);

            if (savedTeacherId) {
                console.log('Found saved teacher ID, auto-login...');
                
                // êµì‚¬ IDê°€ ì €ì¥ë˜ì–´ ìˆìœ¼ë©´ ê²€ì¦ ì—†ì´ ë°”ë¡œ ë¡œê·¸ì¸ ì²˜ë¦¬
                teacherId = savedTeacherId;
                userId = localStorage.getItem(STORAGE_KEYS.USER_ID) || generateUserId();
                localStorage.setItem(STORAGE_KEYS.USER_ID, userId);
                
                console.log('Teacher ID:', teacherId);
                console.log('User ID:', userId);
                
                document.getElementById('configModal').style.display = 'none';
                document.getElementById('noConnection').classList.add('hidden');
                document.getElementById('mainContent').classList.remove('hidden');
                
                // êµì‚¬ ì •ë³´ í‘œì‹œ
                document.getElementById('teacherInfo').textContent = `ğŸ‘¨â€ğŸ« ${teacherId}`;
                
                // ë°ì´í„° ë¡œë“œ ì‹œë„
                try {
                    await loadChecklists();
                    showSyncStatus('success', `${teacherId}ë‹˜ í™˜ì˜í•©ë‹ˆë‹¤!`);
                    setTimeout(() => hideSyncStatus(), 3000);
                } catch (error) {
                    console.error('ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨:', error);
                    showSyncStatus('error', 'ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨ (ë¡œê·¸ì¸ì€ ìœ ì§€ë¨)');
                    setTimeout(() => hideSyncStatus(), 3000);
                }
            } else {
                console.log('No saved teacher ID, showing modal');
                document.getElementById('configModal').style.display = 'flex';
                document.getElementById('noConnection').classList.remove('hidden');
                document.getElementById('mainContent').classList.add('hidden');
            }
        }

        // ì²´í¬ë¦¬ìŠ¤íŠ¸ ë¡œë“œ
        async function loadChecklists() {
            if (!supabase) {
                console.log('Supabase not initialized');
                return;
            }

            try {
                showSyncStatus('syncing', 'ë°ì´í„° ë¡œë“œ ì¤‘...');
                
                console.log('Loading checklists for teacher:', teacherId, 'user:', userId);
                
                const { data, error } = await supabase
                    .from('checklists')
                    .select('*')
                    .eq('teacher_id', teacherId)
                    .eq('user_id', userId)
                    .order('created_at', { ascending: false });

                console.log('Supabase response:', { data, error });

                if (error) {
                    console.error('Supabase load error:', error);
                    throw error;
                }

                if (!data) {
                    console.log('No data returned from Supabase');
                    checklists = [];
                } else {
                    console.log('Raw data from Supabase:', data);
                    
                    checklists = data.map(item => ({
                        id: item.id,
                        n: item.name,
                        c: item.category,
                        sc: item.student_count,
                        s: item.statuses,
                        ct: item.created_at,
                        ut: item.updated_at,
                        t: item.completion_times || Array(item.student_count).fill(null)
                    }));
                    
                    console.log('Processed checklists:', checklists);
                }

                hideSyncStatus();
                renderChecklistList();
                updateCategoryCheckboxes();
                
                // ë§ˆì§€ë§‰ìœ¼ë¡œ ë³¸ ì²´í¬ë¦¬ìŠ¤íŠ¸ ì„ íƒ
                const lastViewedId = localStorage.getItem(STORAGE_KEYS.LAST_VIEWED);
                if (lastViewedId && checklists.some(c => c.id == lastViewedId)) {
                    selectChecklist(parseInt(lastViewedId));
                } else if (checklists.length > 0) {
                    selectChecklist(checklists[0].id);
                }
                
            } catch (error) {
                console.error('ì²´í¬ë¦¬ìŠ¤íŠ¸ ë¡œë“œ ì‹¤íŒ¨:', error);
                showSyncStatus('error', 'ë¡œë“œ ì‹¤íŒ¨: ' + error.message);
                setTimeout(() => hideSyncStatus(), 5000);
                
                checklists = [];
                renderChecklistList();
                updateCategoryCheckboxes();
            }
        }

        // Supabaseì— ì²´í¬ë¦¬ìŠ¤íŠ¸ ì €ì¥
        async function saveChecklistToSupabase(checklist) {
            if (!supabase) return;

            try {
                const checklistData = {
                    id: checklist.id,
                    user_id: userId,
                    teacher_id: teacherId,
                    name: checklist.n,
                    category: checklist.c,
                    student_count: checklist.sc,
                    statuses: checklist.s,
                    completion_times: checklist.t || Array(checklist.sc).fill(null),
                    created_at: checklist.ct,
                    updated_at: new Date().toISOString()
                };

                console.log('Saving to Supabase:', checklistData);

                const { data, error } = await supabase
                    .from('checklists')
                    .upsert(checklistData, { 
                        onConflict: 'id',
                        ignoreDuplicates: false 
                    });

                if (error) {
                    console.error('Supabase error details:', error);
                    throw error;
                }

                console.log('Successfully saved to Supabase:', data);
            } catch (error) {
                console.error('Supabase ì €ì¥ ì‹¤íŒ¨:', error);
                throw error;
            }
        }

        // ì²´í¬ë¦¬ìŠ¤íŠ¸ ìƒì„±
        async function createChecklist() {
            if (!supabase) {
                alert('Supabaseì— ì—°ê²°ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. ì„¤ì •ì„ í™•ì¸í•´ì£¼ì„¸ìš”.');
                return;
            }

            const studentCount = parseInt(document.getElementById('studentCount').value);
            const category = document.getElementById('categorySelect').value;
            
            if (!studentCount || studentCount <= 0) {
                alert('ìœ íš¨í•œ í•™ìƒ ìˆ˜ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                return;
            }
            if (studentCount > 100) {
                alert('í•™ìƒ ìˆ˜ëŠ” ìµœëŒ€ 100ëª…ê¹Œì§€ ì…ë ¥ ê°€ëŠ¥í•©ë‹ˆë‹¤.');
                return;
            }

            const now = new Date().toISOString();
            const checklist = {
                id: Date.now(),
                n: `ì²´í¬ë¦¬ìŠ¤íŠ¸ ${checklists.length + 1}`,
                c: category,
                sc: studentCount,
                s: Array(studentCount).fill(0),
                ct: now,
                ut: now,
                t: Array(studentCount).fill(null)
            };

            checklists.unshift(checklist);
            
            try {
                showSyncStatus('syncing', 'ì €ì¥ ì¤‘...');
                await saveChecklistToSupabase(checklist);
                showSyncStatus('success', 'ì €ì¥ë¨');
                setTimeout(() => hideSyncStatus(), 1000);
                
                renderChecklistList();
                selectChecklist(checklist.id);
                updateCategoryCheckboxes();
                
                localStorage.setItem(STORAGE_KEYS.STUDENT_COUNT, studentCount);
            } catch (error) {
                console.error('ì²´í¬ë¦¬ìŠ¤íŠ¸ ìƒì„± ì‹¤íŒ¨:', error);
                showSyncStatus('error', 'ì €ì¥ ì‹¤íŒ¨');
                setTimeout(() => hideSyncStatus(), 3000);
                checklists.shift();
                renderChecklistList();
            }
        }

        // ì¹´í…Œê³ ë¦¬ ì²´í¬ë°•ìŠ¤ ì—…ë°ì´íŠ¸
        function updateCategoryCheckboxes() {
            const container = document.getElementById('categoryCheckboxes');
            const categories = [...new Set(checklists.map(c => c.c))];
            container.innerHTML = categories.map(category => `
                <label class="flex items-center">
                    <input type="checkbox" value="${category}" checked 
                           class="mr-2" onchange="filterChecklists()">
                    ${category}
                </label>
            `).join('');
        }

        // ì¹´í…Œê³ ë¦¬ í•„í„° í† ê¸€
        function toggleCategoryFilter() {
            const filter = document.getElementById('categoryFilter');
            filter.classList.toggle('hidden');
        }

        // ì²´í¬ë¦¬ìŠ¤íŠ¸ í•„í„°ë§
        function filterChecklists() {
            const checkboxes = document.querySelectorAll('#categoryFilter input[type="checkbox"]');
            const selectedCategories = Array.from(checkboxes)
                .filter(cb => cb.checked)
                .map(cb => cb.value);

            const listContainer = document.getElementById('checklistList');
            const items = listContainer.getElementsByClassName('checklist-item');
            
            Array.from(items).forEach(item => {
                const category = item.dataset.category;
                if (selectedCategories.includes('all') || selectedCategories.includes(category)) {
                    item.classList.remove('hidden');
                } else {
                    item.classList.add('hidden');
                }
            });
        }

        // ì²´í¬ë¦¬ìŠ¤íŠ¸ ëª©ë¡ ë Œë”ë§
        function renderChecklistList() {
            const listContainer = document.getElementById('checklistList');
            
            console.log('Rendering checklist list, checklists count:', checklists.length);
            
            if (checklists.length === 0) {
                listContainer.innerHTML = '<div class="text-center text-gray-500 dark:text-gray-400 py-4">ì²´í¬ë¦¬ìŠ¤íŠ¸ê°€ ì—†ìŠµë‹ˆë‹¤.</div>';
                return;
            }
            
            listContainer.innerHTML = checklists.map(checklist => {
                const truncatedTitle = checklist.n.length > 15 ? checklist.n.substring(0, 15) + '...' : checklist.n;
                return `
                <div class="checklist-item flex items-center p-2 bg-gray-50 rounded cursor-pointer hover:bg-gray-100 ${currentChecklistId === checklist.id ? 'bg-blue-100 dark:bg-blue-900' : ''} dark:bg-gray-700 dark:hover:bg-gray-600"
                     onclick="selectChecklist(${checklist.id})"
                     data-category="${checklist.c}">
                    <div class="flex-1 flex items-center gap-2 min-w-0">
                        <span class="flex-shrink-0 px-2 py-0.5 text-xs rounded-full bg-gray-200 dark:bg-gray-600 text-gray-600 dark:text-gray-300">${checklist.c}</span>
                        <span class="truncate dark:text-gray-100 flex-1 min-w-0" title="${checklist.n}">${truncatedTitle}</span>
                    </div>
                </div>
            `}).join('');
        }

        // ì²´í¬ë¦¬ìŠ¤íŠ¸ ì„ íƒ
        function selectChecklist(id) {
            currentChecklistId = id;
            localStorage.setItem(STORAGE_KEYS.LAST_VIEWED, id);
            
            const checklist = checklists.find(c => c.id === id);
            if (checklist) {
                document.getElementById('checklistActions').classList.remove('hidden');
                document.getElementById('statistics').classList.remove('hidden');
                document.getElementById('checklistTitle').value = checklist.n;
                
                const categorySelect = document.getElementById('editCategorySelect');
                categorySelect.value = checklist.c;
                
                // ìƒì„±/ìˆ˜ì • ì‹œê° í‘œì‹œ
                const createdAt = new Date(checklist.ct);
                const updatedAt = new Date(checklist.ut);
                
                const createdKST = createdAt.toLocaleString('ko-KR', {
                    timeZone: 'Asia/Seoul',
                    year: 'numeric',
                    month: '2-digit',
                    day: '2-digit',
                    hour: '2-digit',
                    minute: '2-digit',
                    second: '2-digit',
                    hour12: false
                });
                
                const updatedKST = updatedAt.toLocaleString('ko-KR', {
                    timeZone: 'Asia/Seoul',
                    year: 'numeric',
                    month: '2-digit',
                    day: '2-digit',
                    hour: '2-digit',
                    minute: '2-digit',
                    second: '2-digit',
                    hour12: false
                });
                
                document.getElementById('checklistInfo').innerHTML = `
                    ìƒì„±: ${createdKST} | 
                    ìˆ˜ì •: ${updatedKST}
                `;

                renderChecklistContent(checklist);
                updateStatistics(checklist);
                renderChecklistList();
            }
        }

        // í˜„ì¬ ì²´í¬ë¦¬ìŠ¤íŠ¸ ì—…ë°ì´íŠ¸
        async function updateCurrentChecklist() {
            if (!currentChecklistId || !supabase) return;
            
            const newName = document.getElementById('checklistTitle').value;
            const newCategory = document.getElementById('editCategorySelect').value;
            const checklist = checklists.find(c => c.id === currentChecklistId);
            
            if (checklist) {
                checklist.n = newName;
                checklist.c = newCategory;
                checklist.ut = new Date().toISOString();
                
                try {
                    showSyncStatus('syncing', 'ì €ì¥ ì¤‘...');
                    await saveChecklistToSupabase(checklist);
                    showSyncStatus('success', 'ì €ì¥ë¨');
                    setTimeout(() => hideSyncStatus(), 1000);
                    
                    renderChecklistList();
                    selectChecklist(currentChecklistId);
                    updateCategoryCheckboxes();
                } catch (error) {
                    console.error('ì—…ë°ì´íŠ¸ ì‹¤íŒ¨:', error);
                    showSyncStatus('error', 'ì €ì¥ ì‹¤íŒ¨');
                    setTimeout(() => hideSyncStatus(), 3000);
                }
            }
        }

        // í˜„ì¬ ì²´í¬ë¦¬ìŠ¤íŠ¸ ì‚­ì œ
        async function deleteCurrentChecklist() {
            if (!currentChecklistId || !supabase) return;
            
            if (confirm('ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                try {
                    showSyncStatus('syncing', 'ì‚­ì œ ì¤‘...');
                    const { error } = await supabase
                        .from('checklists')
                        .delete()
                        .eq('id', currentChecklistId)
                        .eq('teacher_id', teacherId)
                        .eq('user_id', userId);
                    
                    if (error) throw error;
                    
                    showSyncStatus('success', 'ì‚­ì œë¨');
                    setTimeout(() => hideSyncStatus(), 1000);
                    
                    checklists = checklists.filter(c => c.id !== currentChecklistId);
                    
                    currentChecklistId = null;
                    document.getElementById('checklistActions').classList.add('hidden');
                    document.getElementById('statistics').classList.add('hidden');
                    document.getElementById('checklistContent').innerHTML = '';
                    document.getElementById('checklistTitle').value = '';
                    document.getElementById('checklistInfo').innerHTML = '';
                    
                    renderChecklistList();
                    updateCategoryCheckboxes();
                } catch (error) {
                    console.error('ì‚­ì œ ì‹¤íŒ¨:', error);
                    showSyncStatus('error', 'ì‚­ì œ ì‹¤íŒ¨');
                    setTimeout(() => hideSyncStatus(), 3000);
                }
            }
        }

        // ì™„ë£Œ ìˆœìœ„ ê³„ì‚°
        function getCompletionRanking(checklist) {
            return checklist.t
                .map((time, index) => ({ index, time }))
                .filter(item => item.time !== null)
                .sort((a, b) => new Date(a.time) - new Date(b.time))
                .reduce((acc, item, idx) => {
                    acc[item.index] = idx + 1;
                    return acc;
                }, {});
        }

        // ìƒíƒœ ë³€ê²½
        async function changeStatus(checklistId, studentIndex) {
            if (!supabase) return;

            const checklist = checklists.find(c => c.id === checklistId);
            if (checklist) {
                const currentStatusId = checklist.s[studentIndex];
                const statusKeys = Object.values(STATUS);
                const currentIndex = statusKeys.findIndex(status => status.id === currentStatusId);
                const nextIndex = (currentIndex + 1) % statusKeys.length;
                const nextStatus = statusKeys[nextIndex];
                
                checklist.s[studentIndex] = nextStatus.id;
                
                // ì™„ë£Œ ìƒíƒœë¡œ ë³€ê²½ë  ë•Œ ì‹œê°„ ê¸°ë¡
                if (nextStatus.id === 1) {
                    checklist.t[studentIndex] = new Date().toISOString();
                } else if (currentStatusId === 1) {
                    checklist.t[studentIndex] = null;
                }
                
                checklist.ut = new Date().toISOString();
                
                try {
                    await saveChecklistToSupabase(checklist);
                    renderChecklistContent(checklist);
                    updateStatistics(checklist);
                } catch (error) {
                    console.error('ìƒíƒœ ë³€ê²½ ì‹¤íŒ¨:', error);
                    showSyncStatus('error', 'ì €ì¥ ì‹¤íŒ¨');
                    setTimeout(() => hideSyncStatus(), 3000);
                }
            }
        }

        // í†µê³„ ì—…ë°ì´íŠ¸
        function updateStatistics(checklist) {
            const total = checklist.s.length;
            const counts = { 0: 0, 1: 0, 2: 0, 3: 0, 4: 0 };

            checklist.s.forEach(statusId => {
                counts[statusId]++;
            });

            const statusMapping = {
                0: { countId: 'incompleteCount', percentId: 'incompletePercent', barId: 'incompleteBar' },
                1: { countId: 'completedCount', percentId: 'completedPercent', barId: 'completedBar' },
                2: { countId: 'inProgressCount', percentId: 'inProgressPercent', barId: 'inProgressBar' },
                3: { countId: 'resubmitCount', percentId: 'resubmitPercent', barId: 'resubmitBar' },
                4: { countId: 'deadlineCount', percentId: 'deadlinePercent', barId: 'deadlineBar' }
            };

            Object.entries(counts).forEach(([statusId, count]) => {
                const percent = total > 0 ? ((count / total) * 100).toFixed(1) : '0.0';
                const { countId, percentId, barId } = statusMapping[statusId];
                
                document.getElementById(countId).textContent = count;
                document.getElementById(percentId).textContent = percent;
                document.getElementById(barId).style.width = `${percent}%`;
            });

            // ì™„ë£Œ ìˆœìœ„ í‘œì‹œ
            const completionOrder = checklist.t
                .map((time, index) => ({ index, time }))
                .filter(item => item.time !== null)
                .sort((a, b) => new Date(a.time) - new Date(b.time))
                .slice(0, 5);

            const statisticsSection = document.getElementById('statistics');
            const existingRanking = statisticsSection.querySelector('.ranking-section');
            if (existingRanking) {
                existingRanking.remove();
            }

            if (completionOrder.length > 0) {
                const rankingHtml = `
                    <div class="ranking-section mt-4 p-3 bg-gray-50 dark:bg-gray-700 rounded-lg">
                        <h4 class="text-sm font-semibold dark:text-gray-100 mb-2">ğŸ† ì™„ë£Œ ìˆœìœ„ (ìƒìœ„ 5ëª…)</h4>
                        <div class="space-y-1">
                            ${completionOrder.map((item, index) => {
                                const completionTime = new Date(item.time);
                                const koreanTime = completionTime.toLocaleString('ko-KR', {
                                    timeZone: 'Asia/Seoul',
                                    hour: '2-digit',
                                    minute: '2-digit',
                                    second: '2-digit',
                                    hour12: false
                                });
                                
                                return `
                                <div class="flex items-center justify-between text-sm">
                                    <span class="dark:text-gray-100">
                                        ${index + 1}ìœ„: ${item.index + 1}ë²ˆ
                                    </span>
                                    <span class="text-gray-500 dark:text-gray-400">
                                        ${koreanTime}
                                    </span>
                                </div>
                            `}).join('')}
                        </div>
                    </div>
                `;
                statisticsSection.insertAdjacentHTML('beforeend', rankingHtml);
            }
        }

        // ì²´í¬ë¦¬ìŠ¤íŠ¸ ë‚´ìš© ë Œë”ë§ (ê°œì„ ëœ ë²„ì „)
        function renderChecklistContent(checklist) {
            const contentContainer = document.getElementById('checklistContent');
            
            // ì™„ë£Œ ìˆœìœ„ ê³„ì‚°
            const rankings = getCompletionRanking(checklist);
            
            contentContainer.innerHTML = checklist.s.map((statusId, index) => {
                const status = getStatusById(statusId);
                const ranking = rankings[index];
                const studentNumber = index + 1;
                
                return `
                    <div class="student-card bg-white dark:bg-gray-700 rounded-lg shadow-md relative">
                        ${ranking ? `<div class="ranking-badge">${ranking}</div>` : ''}
                        <div class="student-number">
                            ${studentNumber}ë²ˆ
                        </div>
                        <button class="status-btn ${status.color} text-white w-full"
                                onclick="changeStatus(${checklist.id}, ${index})"
                                title="${studentNumber}ë²ˆ í•™ìƒ - ${status.text}">
                            ${status.text}
                        </button>
                    </div>
                `;
            }).join('');
        }

        // ë‹¤í¬ëª¨ë“œ í† ê¸€
        function toggleDarkMode() {
            isDarkMode = !isDarkMode;
            if (isDarkMode) {
                document.documentElement.classList.add('dark');
                document.getElementById('darkModeIcon').textContent = 'â˜€ï¸';
            } else {
                document.documentElement.classList.remove('dark');
                document.getElementById('darkModeIcon').textContent = 'ğŸŒ™';
            }
            localStorage.setItem(STORAGE_KEYS.DARK_MODE, isDarkMode);
        }

        // ì‹œê³„ ì—…ë°ì´íŠ¸
        function updateClock() {
            const now = new Date();
            document.getElementById('clock').textContent = now.toLocaleTimeString();
        }

        // ì´ˆê¸°í™”
        async function init() {
            // ë‹¤í¬ëª¨ë“œ ì„¤ì •
            if (isDarkMode) {
                document.documentElement.classList.add('dark');
                document.getElementById('darkModeIcon').textContent = 'â˜€ï¸';
            }

            // ì‹œê³„ ì‹œì‘
            updateClock();
            setInterval(updateClock, 1000);

            // ì €ì¥ëœ í•™ìƒ ìˆ˜ ë¶ˆëŸ¬ì˜¤ê¸°
            const savedCount = localStorage.getItem(STORAGE_KEYS.STUDENT_COUNT);
            if (savedCount) {
                document.getElementById('studentCount').value = savedCount;
            }

            // Supabase ì´ˆê¸°í™”
            await initSupabase();
        }

        // í˜ì´ì§€ ë¡œë“œ ì‹œ ì´ˆê¸°í™”
        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>