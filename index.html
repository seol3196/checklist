<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>체크리스트 앱</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        dark: {
                            bg: '#1a1a1a',
                            card: '#2d2d2d',
                            text: '#e5e5e5',
                            border: '#404040'
                        }
                    }
                }
            }
        }
    </script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script>
        // Supabase 스크립트 로드 확인
        window.addEventListener('load', () => {
            console.log('🔍 Supabase 스크립트 로드 상태:', !!window.supabase);
        });
    </script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard@v1.3.9/dist/web/variable/pretendardvariable.min.css">
    <style>
        body {
            font-family: 'Pretendard Variable', -apple-system, BlinkMacSystemFont, system-ui, Roboto, 'Helvetica Neue', 'Segoe UI', 'Apple SD Gothic Neo', 'Noto Sans KR', 'Malgun Gothic', 'Apple Color Emoji', 'Segoe UI Emoji', 'Segoe UI Symbol', sans-serif;
            transition: background-color 0.3s, color 0.3s;
        }
        .student-card {
            min-width: 80px;
            transition: all 0.2s ease;
            border: 2px solid transparent;
            position: relative;
        }
        .student-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            border-color: rgba(59, 130, 246, 0.3);
        }
        .student-number {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            font-weight: bold;
            font-size: 0.9rem;
            padding: 8px 12px;
            border-radius: 8px 8px 0 0;
            text-align: center;
            min-height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            text-shadow: 0 1px 2px rgba(0,0,0,0.2);
        }
        .dark .student-number {
            background: linear-gradient(135deg, #8B5CF6 0%, #06B6D4 100%);
        }
        .status-btn {
            min-height: 80px;
            transition: all 0.2s ease;
            font-weight: 600;
            font-size: 0.9rem;
            border-radius: 0 0 8px 8px;
            border: none;
            cursor: pointer;
            position: relative;
            overflow: hidden;
        }
        .status-btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
            transition: left 0.5s;
        }
        .status-btn:hover::before {
            left: 100%;
        }
        .status-btn:active {
            transform: scale(0.98);
        }
        .icon-btn {
            @apply p-2 rounded hover:bg-gray-100 dark:hover:bg-gray-600 transition-colors;
        }
        .main-title {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            text-shadow: 0 2px 4px rgba(0,0,0,0.1);
            position: relative;
        }
        .dark .main-title {
            background: linear-gradient(135deg, #8B5CF6 0%, #06B6D4 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        .title-badge {
            background: linear-gradient(135deg, #667eea20, #764ba240);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255,255,255,0.2);
        }
        .dark .title-badge {
            background: linear-gradient(135deg, #8B5CF620, #06B6D440);
            border: 1px solid rgba(255,255,255,0.1);
        }
        .sync-status {
            @apply text-xs px-2 py-1 rounded-full;
        }
        .sync-success { @apply bg-green-100 text-green-800 dark:bg-green-900 dark:text-green-300; }
        .sync-error { @apply bg-red-100 text-red-800 dark:bg-red-900 dark:text-red-300; }
        .sync-syncing { @apply bg-blue-100 text-blue-800 dark:bg-blue-900 dark:text-blue-300; }
        .loading {
            @apply opacity-50 pointer-events-none;
        }
        .ranking-badge {
            position: absolute;
            top: -8px;
            right: -8px;
            background: linear-gradient(135deg, #fbbf24, #f59e0b);
            color: white;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.7rem;
            font-weight: bold;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }
        .student-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
            gap: 16px;
            padding: 8px;
        }
        @media (max-width: 640px) {
            .student-grid {
                grid-template-columns: repeat(auto-fill, minmax(80px, 1fr));
                gap: 8px;
            }
        }
        /* 전체화면 모드 스타일 */
        .fullscreen-mode .student-card {
            min-width: 110px; /* 100px에서 110px로 증가 */
        }
        .fullscreen-mode .student-number {
            font-size: 1.32rem; /* 1.2rem에서 1.32rem으로 증가 */
            padding: 14px 18px; /* 12px 16px에서 증가 */
            min-height: 55px; /* 50px에서 55px로 증가 */
        }
        .fullscreen-mode .status-btn {
            min-height: 110px; /* 100px에서 110px로 증가 */
            font-size: 1.32rem; /* 1.2rem에서 1.32rem으로 증가 */
            font-weight: 700;
        }
        .fullscreen-mode .ranking-badge {
            width: 33px; /* 30px에서 33px로 증가 */
            height: 33px; /* 30px에서 33px로 증가 */
            font-size: 1rem; /* 0.9rem에서 1rem으로 증가 */
            top: -11px;
            right: -11px;
        }
        .fullscreen-mode .student-grid {
            grid-template-columns: repeat(auto-fill, minmax(145px, 1fr)); /* 130px에서 145px로 증가 */
            gap: 22px; /* 20px에서 22px로 증가 */
            padding: 18px; /* 16px에서 18px로 증가 */
        }
        .fullscreen-mode .icon-btn {
            font-size: 1.55rem; /* 1.4rem에서 1.55rem으로 증가 */
            padding: 12px; /* 10px에서 12px로 증가 */
        }
        .fullscreen-mode #checklistTitle {
            font-size: 2rem; /* 1.8rem에서 2rem으로 증가 */
        }
        .fullscreen-mode #editCategorySelect {
            font-size: 1.32rem; /* 1.2rem에서 1.32rem으로 증가 */
            padding: 9px 14px; /* 8px 12px에서 증가 */
        }
        /* 통계 섹션도 크게 */
        .fullscreen-mode #statistics h3 {
            font-size: 1.32rem;
        }
        .fullscreen-mode #statistics .text-sm {
            font-size: 1.1rem;
        }
    </style>
</head>
<body class="bg-gray-100 dark:bg-gray-900 min-h-screen">
    <!-- 교사 로그인 모달 -->
    <div id="configModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50" style="display: none;">
        <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-xl max-w-md w-full mx-4">
            <h2 class="text-xl font-bold mb-4 dark:text-white">교사 로그인</h2>
            <div class="text-sm text-gray-600 dark:text-gray-400 mb-4">
                <p>등록된 교사 아이디로 로그인하세요.</p>
                <p class="mt-2 text-xs">⚠️ 교사 로그인 없이는 사용할 수 없습니다.</p>
            </div>
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium mb-2 dark:text-white">교사 아이디</label>
                    <input type="text" id="teacherIdInput" 
                           placeholder="교사 아이디를 입력하세요" 
                           class="w-full p-2 border rounded dark:bg-gray-700 dark:border-gray-600 dark:text-white"
                           onkeypress="if(event.key==='Enter') teacherLogin()">
                </div>
                <div class="flex gap-2">
                    <button onclick="teacherLogin()" 
                            class="flex-1 bg-blue-500 text-white p-2 rounded hover:bg-blue-600 transition-colors">
                        로그인
                    </button>
                    <button onclick="resetUserId()" 
                            class="px-4 bg-gray-500 text-white p-2 rounded hover:bg-gray-600 transition-colors text-sm">
                        ID 초기화
                    </button>
                </div>
                <!-- 교사 로그인 모달 내에 추가 -->
                <button onclick="googleLogin()" 
                        class="flex-1 bg-red-500 text-white p-2 rounded hover:bg-red-600 transition-colors mt-2">
                    <img src="https://www.svgrepo.com/show/475656/google-color.svg" style="width:20px;display:inline;margin-right:8px;vertical-align:middle;">
                    구글로 로그인
                </button>
            </div>
        </div>
    </div>
    
    <!-- 학생 업로드 모달 -->
    <div id="studentUploadModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-xl max-w-md w-full mx-4">
            <h2 class="text-xl font-bold mb-4 dark:text-white">📂 학생 정보 관리</h2>
            
            <div class="space-y-4">
                <!-- 단계 1: CSV 양식 다운로드 -->
                <div class="p-3 bg-blue-50 dark:bg-blue-900 rounded-lg">
                    <h3 class="text-sm font-semibold text-blue-800 dark:text-blue-200 mb-2">1️⃣ CSV 양식 다운로드</h3>
                    <button onclick="downloadCSVTemplate()" 
                            class="w-full bg-blue-500 text-white p-2 rounded hover:bg-blue-600 transition-colors text-sm">
                        📥 CSV 양식 다운로드
                    </button>
                    <p class="text-xs text-blue-600 dark:text-blue-300 mt-1">학생번호, 학생이름 순으로 입력하세요</p>
                </div>

                <!-- 단계 2: CSV 파일 업로드 -->
                <div class="p-3 bg-green-50 dark:bg-green-900 rounded-lg">
                    <h3 class="text-sm font-semibold text-green-800 dark:text-green-200 mb-2">2️⃣ 학생 정보 업로드</h3>
                    <input type="file" id="csvFileInput" accept=".csv" 
                           class="w-full p-2 border rounded dark:bg-gray-700 dark:border-gray-600 dark:text-white text-sm">
                    <button onclick="uploadStudentCSV()" 
                            class="w-full bg-green-500 text-white p-2 rounded hover:bg-green-600 transition-colors text-sm mt-2">
                        📤 업로드
                    </button>
                </div>

                <!-- 업로드된 학생 정보 미리보기 -->
                <div id="studentPreview" class="hidden p-3 bg-gray-50 dark:bg-gray-700 rounded-lg">
                    <h3 class="text-sm font-semibold dark:text-gray-100 mb-2">👥 업로드된 학생 정보</h3>
                    <div id="studentPreviewList" class="text-xs max-h-32 overflow-y-auto"></div>
                    <button onclick="saveStudentData()" 
                            class="w-full bg-purple-500 text-white p-2 rounded hover:bg-purple-600 transition-colors text-sm mt-2">
                        💾 저장
                    </button>
                </div>
            </div>

            <div class="flex gap-2 mt-4">
                <button onclick="closeStudentUploadModal()" 
                        class="flex-1 bg-gray-500 text-white p-2 rounded hover:bg-gray-600 transition-colors">
                    취소
                </button>
            </div>
        </div>
    </div>

    <!-- 모둠 체크리스트 모달 -->
    <div id="groupChecklistModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-xl max-w-md w-full mx-4">
            <h2 class="text-xl font-bold mb-4 dark:text-white">👨‍👩‍👧‍👦 모둠 체크리스트 생성</h2>
            
            <div class="space-y-4">
                <div class="p-3 bg-purple-50 dark:bg-purple-900 rounded-lg">
                    <h3 class="text-sm font-semibold text-purple-800 dark:text-purple-200 mb-2">모둠 정보 입력</h3>
                    <div class="mb-3">
                        <label class="block text-sm font-medium mb-1 dark:text-gray-300">모둠 개수</label>
                        <input type="number" id="groupCountInput" min="1" max="20" value="6" 
                            class="w-full p-2 border rounded dark:bg-gray-700 dark:border-gray-600 dark:text-white">
                    </div>
                    <div class="mb-3">
                        <label class="block text-sm font-medium mb-1 dark:text-gray-300">카테고리 선택</label>
                        <select id="groupCategorySelect" class="w-full p-2 border rounded dark:bg-gray-700 dark:border-gray-600 dark:text-gray-100">
                            <option value="일반">🗒️ 일반</option>
                            <option value="국어">📒 국어</option>
                            <option value="수학">🧮 수학</option>
                            <option value="사회">👥 사회</option>
                            <option value="과학">🔬 과학</option>
                            <option value="영어">🇺🇸 영어</option>
                            <option value="도덕">🤝 도덕</option>
                            <option value="실과">🧶 실과</option>
                            <option value="음악">🎵 음악</option>
                            <option value="미술">🎨 미술</option>
                            <option value="체육">🏃 체육</option>
                            <option value="창체">👥 창체</option>
                            <option value="아침활동">🌞 아침활동</option>
                            <option value="독서">🤓 독서</option>
                            <option value="기타">🤔 기타</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium mb-1 dark:text-gray-300">체크리스트 이름</label>
                        <input type="text" id="groupChecklistName" placeholder="모둠 활동 체크리스트" 
                            class="w-full p-2 border rounded dark:bg-gray-700 dark:border-gray-600 dark:text-white">
                    </div>
                </div>
            </div>

            <div class="flex gap-2 mt-4">
                <button onclick="closeGroupChecklistModal()" 
                        class="flex-1 bg-gray-500 text-white p-2 rounded hover:bg-gray-600 transition-colors">
                    취소
                </button>
                <button onclick="createGroupChecklist()" 
                        class="flex-1 bg-purple-500 text-white p-2 rounded hover:bg-purple-600 transition-colors">
                    확인
                </button>
            </div>
        </div>
    </div>

    <div class="container mx-auto p-4">
        <div class="flex justify-end mb-4">
            <div class="flex items-center gap-4">
                <div id="syncStatus" class="sync-status hidden">동기화 중...</div>
                <div id="teacherInfo" class="text-sm text-gray-600 dark:text-gray-400"></div>
                <span class="clock text-gray-900 dark:text-white" id="clock"></span>
                <button class="flex items-center gap-2 px-3 py-2 rounded border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-800 hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors text-gray-900 dark:text-white" 
                        onclick="toggleDarkMode()">
                    <span id="darkModeIcon">🌙</span>
                    <span>다크모드</span>
                </button>
                <button onclick="showConfig()" 
                        class="flex items-center gap-2 px-3 py-2 rounded border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-800 hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors text-gray-900 dark:text-white">
                    👨‍🏫 교사 변경/로그아웃
                </button>
            </div>
        </div>
        
        <div id="mainContainer" class="flex gap-4">
            <!-- 좌측 체크리스트 목록 -->
            <div id="leftContainer" class="w-1/4 bg-white dark:bg-gray-800 rounded-lg shadow p-4">
                <h2 class="text-xl font-bold mb-4 dark:text-gray-100">Checklist</h2>
                
                <!-- 학생 관리 섹션 -->
                <div class="mb-4 p-3 bg-gray-50 dark:bg-gray-700 rounded-lg">
                    <h3 class="font-semibold dark:text-gray-100 mb-2">👥 학생 관리</h3>
                    <div id="studentManagement">
                        <div id="noStudents" class="text-center py-4">
                            <p class="text-sm text-gray-500 dark:text-gray-400 mb-3">학생 정보가 없습니다.</p>
                            <button onclick="showStudentUploadModal()" 
                                    class="w-full bg-green-500 text-white p-2 rounded hover:bg-green-600 transition-colors text-sm">
                                📂 학생 추가
                            </button>
                        </div>
                        <div id="hasStudents" class="hidden">
                            <div class="flex items-center justify-between mb-2">
                                <span class="text-sm dark:text-gray-100">등록된 학생: <span id="studentCountDisplay">0</span>명</span>
                                <button onclick="showStudentUploadModal()" 
                                        class="text-xs px-2 py-1 bg-gray-500 text-white rounded hover:bg-gray-600 transition-colors">
                                    수정
                                </button>
                            </div>
                            <div id="studentList" class="text-xs text-gray-600 dark:text-gray-400 max-h-20 overflow-y-auto"></div>
                        </div>
                    </div>
                </div>

                <!-- 체크리스트 생성 섹션 -->
                <div class="mb-4">
                    <h3 class="font-semibold dark:text-gray-100 mb-2">📋 체크리스트 생성</h3>
                    <select id="categorySelect" class="w-full p-2 border rounded-full mb-2 bg-white dark:bg-gray-700 dark:border-gray-600 dark:text-gray-100">
                        <option value="일반">🗒️ 일반</option>
                        <option value="국어">📒 국어</option>
                        <option value="수학">🧮 수학</option>
                        <option value="사회">👥 사회</option>
                        <option value="과학">🔬 과학</option>
                        <option value="영어">🇺🇸 영어</option>
                        <option value="도덕">🤝 도덕</option>
                        <option value="실과">🧶 실과</option>
                        <option value="음악">🎵 음악</option>
                        <option value="미술">🎨 미술</option>
                        <option value="체육">🏃 체육</option>
                        <option value="창체">👥 창체</option>
                        <option value="아침활동">🌞 아침활동</option>
                        <option value="독서">🤓 독서</option>
                        <option value="기타">🤔 기타</option>
                    </select>
                    <button id="createChecklist" 
                            class="w-full bg-blue-500 text-white p-2 rounded hover:bg-blue-600 flex items-center justify-center gap-2 transition-colors disabled:bg-gray-400 disabled:cursor-not-allowed mb-2"
                            onclick="createChecklist()" disabled>
                        ➕ 체크리스트 추가
                    </button>
                    <button id="createGroupChecklist" 
                            class="w-full bg-purple-500 text-white p-2 rounded hover:bg-purple-600 flex items-center justify-center gap-2 transition-colors disabled:bg-gray-400 disabled:cursor-not-allowed"
                            onclick="showGroupChecklistModal()" disabled>
                        👨‍👩‍👧‍👦 모둠 체크리스트 추가
                    </button>
                    <p class="text-xs text-gray-500 dark:text-gray-400 mt-1 text-center">학생 정보를 먼저 등록해주세요</p>
                </div>
                <div class="mb-4">
                    <div class="flex items-center justify-between mb-2">
                        <h3 class="font-semibold dark:text-gray-100">목록</h3>
                        <button onclick="toggleCategoryFilter()" class="icon-btn dark:text-white">
                            🔍
                        </button>
                    </div>
                    <div id="categoryFilter" class="hidden space-y-1">
                        <label class="flex items-center dark:text-white">
                            <input type="checkbox" value="all" checked class="mr-2" onchange="filterChecklists()">
                            전체
                        </label>
                        <div id="categoryCheckboxes" class="space-y-1 dark:text-white"></div>
                    </div>
                </div>
                <div id="checklistList" class="space-y-2"></div>
                <div class="text-center text-xs text-gray-400 dark:text-gray-500 mt-4">
                    <div id="storageInfo" class="mt-1">☁️ Supabase</div>
                </div>
            </div>

            <!-- 우측 체크리스트 내용 -->
            <div id="rightContainer" class="w-3/4 bg-white dark:bg-gray-800 rounded-lg shadow p-4">
                <div id="noConnection" class="text-center py-8 text-gray-500 dark:text-gray-400">
                    <div class="text-4xl mb-4">👨‍🏫</div>
                    <div class="text-lg font-semibold mb-2">교사 로그인이 필요합니다</div>
                    <div class="text-sm">교사 변경 버튼을 클릭하여 로그인하세요.</div>
                </div>
                
                <div id="mainContent" class="hidden">
                    <div class="flex justify-between items-center mb-4">
                        <div class="flex-1">
                            <div class="flex items-center gap-2">
                                <select id="editCategorySelect" 
                                        class="p-2 border rounded-full bg-white dark:bg-gray-700 dark:border-gray-600 dark:text-gray-100" 
                                        onchange="updateCurrentChecklist()">
                                    <option value="일반">🗒️ 일반</option>
                                    <option value="국어">📒 국어</option>
                                    <option value="수학">🧮 수학</option>
                                    <option value="사회">👥 사회</option>
                                    <option value="과학">🔬 과학</option>
                                    <option value="영어">🇺🇸 영어</option>
                                    <option value="도덕">🤝 도덕</option>
                                    <option value="실과">🧶 실과</option>
                                    <option value="음악">🎵 음악</option>
                                    <option value="미술">🎨 미술</option>
                                    <option value="체육">🏃 체육</option>
                                    <option value="창체">👥 창체</option>
                                    <option value="아침활동">🌞 아침활동</option>
                                    <option value="독서">🤓 독서</option>
                                    <option value="기타">🤔 기타</option>
                                </select>
                                <input type="text" id="checklistTitle" 
                                       class="flex-1 text-xl font-bold bg-transparent border-b border-transparent hover:border-gray-300 focus:border-blue-500 focus:outline-none px-1 dark:text-gray-100 dark:border-gray-600" 
                                       onchange="updateCurrentChecklist()">
                            </div>
                            <div id="checklistInfo" class="text-sm text-gray-400 dark:text-gray-500 mt-1"></div>
                        </div>
                        <div class="flex">
                            <button id="fullscreenBtn" onclick="toggleFullscreen()" 
                                    class="icon-btn mr-2 text-blue-500 hover:bg-blue-100 dark:hover:bg-blue-900" title="전체화면">
                                🔍
                            </button>
                            <div id="checklistActions" class="hidden">
                                <button onclick="deleteCurrentChecklist()" 
                                        class="icon-btn text-red-500 hover:bg-red-100 dark:hover:bg-red-900">
                                    🗑️
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <div id="checklistContent" class="student-grid mb-6"></div>
                    
                    <!-- 통계 섹션 -->
                    <div id="statistics" class="border-t border-gray-200 dark:border-gray-600 pt-4 hidden">
                        <h3 class="text-lg font-semibold mb-3 dark:text-gray-100">상태별 통계</h3>
                        <div class="grid grid-cols-5 gap-4 mb-4">
                            <div class="text-center">
                                <div class="bg-green-500 text-white p-2 rounded mb-1">완료</div>
                                <div class="text-sm dark:text-gray-100">
                                    <span id="completedCount">0</span><span id="unitText">명</span>
                                    (<span id="completedPercent">0.0</span>%)
                                </div>
                            </div>
                            <div class="text-center">
                                <div class="bg-yellow-500 text-white p-2 rounded mb-1">진행중</div>
                                <div class="text-sm dark:text-gray-100">
                                    <span id="inProgressCount">0</span><span id="unitText2">명</span>
                                    (<span id="inProgressPercent">0.0</span>%)
                                </div>
                            </div>
                            <div class="text-center">
                                <div class="bg-orange-500 text-white p-2 rounded mb-1">재제출</div>
                                <div class="text-sm dark:text-gray-100">
                                    <span id="resubmitCount">0</span><span id="unitText3">명</span>
                                    (<span id="resubmitPercent">0.0</span>%)
                                </div>
                            </div>
                            <div class="text-center">
                                <div class="bg-gray-500 text-white p-2 rounded mb-1">미완료</div>
                                <div class="text-sm dark:text-gray-100">
                                    <span id="incompleteCount">0</span><span id="unitText4">명</span>
                                    (<span id="incompletePercent">0.0</span>%)
                                </div>
                            </div>
                            <div class="text-center">
                                <div class="bg-red-500 text-white p-2 rounded mb-1">미제출마감</div>
                                <div class="text-sm dark:text-gray-100">
                                    <span id="deadlineCount">0</span><span id="unitText5">명</span>
                                    (<span id="deadlinePercent">0.0</span>%)
                                </div>
                            </div>
                        </div>
                        <!-- 프로그레스 바 -->
                        <div class="mt-4">
                            <div class="flex h-6 rounded-full overflow-hidden">
                                <div id="completedBar" class="bg-green-500 transition-all duration-500" style="width: 0%"></div>
                                <div id="inProgressBar" class="bg-yellow-500 transition-all duration-500" style="width: 0%"></div>
                                <div id="resubmitBar" class="bg-orange-500 transition-all duration-500" style="width: 0%"></div>
                                <div id="incompleteBar" class="bg-gray-500 transition-all duration-500" style="width: 100%"></div>
                                <div id="deadlineBar" class="bg-red-500 transition-all duration-500" style="width: 0%"></div>
                            </div>
                            <div class="flex justify-between mt-2 text-xs text-gray-500 dark:text-gray-400">
                                <span>0%</span>
                                <span>100%</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // 상태 상수 정의
        const STATUS = {
            INCOMPLETE: { id: 0, color: 'bg-gray-500', text: '미완료' },
            COMPLETED: { id: 1, color: 'bg-green-500', text: '완료' },
            IN_PROGRESS: { id: 2, color: 'bg-yellow-500', text: '진행중' },
            RESUBMIT: { id: 3, color: 'bg-orange-500', text: '재제출' },
            DEADLINE_PASSED: { id: 4, color: 'bg-red-500', text: '미제출마감' }
        };

        // 전체화면 관련 변수
        let isFullscreen = false;
        let originalLayout = {};

        // 전체화면 토글 함수
        function toggleFullscreen() {
            const checklistContainer = document.getElementById('rightContainer');
            const leftContainer = document.getElementById('leftContainer');
            const mainContainer = document.getElementById('mainContainer');
            const fullscreenBtn = document.getElementById('fullscreenBtn');
            
            // 요소가 존재하는지 확인
            if (!checklistContainer || !leftContainer || !mainContainer || !fullscreenBtn) {
                console.error("전체화면 전환에 필요한 요소를 찾을 수 없습니다.");
                return; // 필요한 요소가 없으면 함수 실행 중단
            }
            
            if (!isFullscreen) {
                // 원래 레이아웃 저장
                originalLayout = {
                    checklistClassName: checklistContainer.className,
                    leftClassName: leftContainer.className,
                    mainClassName: mainContainer.className
                };
                
                // 전체화면 스타일 적용
                checklistContainer.className = 'w-full bg-white dark:bg-gray-800 rounded-lg shadow p-4';
                leftContainer.style.display = 'none';
                mainContainer.className = 'flex flex-col';
                fullscreenBtn.innerHTML = '⬅️';
                fullscreenBtn.title = '전체화면 해제';
                
                // 폰트 및 버튼 크기 키우기
                checklistContainer.classList.add('fullscreen-mode');
                
                isFullscreen = true;
            } else {
                // 원래 레이아웃으로 복원
                checklistContainer.className = originalLayout.checklistClassName || 'w-3/4 bg-white dark:bg-gray-800 rounded-lg shadow p-4';
                leftContainer.className = originalLayout.leftClassName || 'w-1/4 bg-white dark:bg-gray-800 rounded-lg shadow p-4';
                leftContainer.style.display = '';
                mainContainer.className = originalLayout.mainClassName || 'flex gap-4';
                fullscreenBtn.innerHTML = '🔍';
                fullscreenBtn.title = '전체화면';
                
                // 폰트 및 버튼 크기 원복
                checklistContainer.classList.remove('fullscreen-mode');
                
                isFullscreen = false;
            }
            
            // 현재 체크리스트 다시 렌더링 (레이아웃 변경 후 UI 업데이트)
            if (currentChecklistId) {
                const checklist = checklists.find(c => c.id === currentChecklistId);
                if (checklist) {
                    renderChecklistContent(checklist);
                    updateStatistics(checklist);
                }
            }
        }

        // 고정된 Supabase 설정
        const SUPABASE_CONFIG = {
            URL: 'https://prujjupqzvxbrybzjump.supabase.co', // 실제 Supabase 프로젝트 URL
            ANON_KEY: 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InBydWpqdXBxenZ4YnJ5YnpqdW1wIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDk3ODI1NDksImV4cCI6MjA2NTM1ODU0OX0.n9-c_IgKpvzy__YK5_b2cekOit_LW3AnK4cIz2iDOPU'
        };

        // 전역 변수
        let supabase = null;
        let userId = null;
        let teacherId = null;
        let checklists = [];
        let currentChecklistId = null;
        let isDarkMode = localStorage.getItem('darkMode') === 'true';
        let students = [];
        let uploadedStudents = [];

        // 로컬 스토리지 키
        const STORAGE_KEYS = {
            TEACHER_ID: 'teacherId',
            LAST_VIEWED: 'lastViewedChecklist',
            DARK_MODE: 'darkMode',
            STUDENT_COUNT: 'studentCount'
        };

        // 상태 ID를 텍스트로 변환하는 함수
        function getStatusById(id) {
            return Object.values(STATUS).find(status => status.id === id);
        }

        // 사용자 ID 생성
        // function generateUserId() {
        //     return 'default_user';
        // }

        // 동기화 상태 표시
        function showSyncStatus(type, message) {
            const statusEl = document.getElementById('syncStatus');
            statusEl.className = `sync-status sync-${type}`;
            statusEl.textContent = message;
            statusEl.classList.remove('hidden');
        }

        function hideSyncStatus() {
            document.getElementById('syncStatus').classList.add('hidden');
        }

        // 완전 로그아웃 및 초기화
        function resetUserId() {
            if (confirm('로그아웃 하시겠습니까?\n저장된 모든 정보가 삭제됩니다.')) {
                // 구글 로그아웃 추가
                if (supabase) {
                    supabase.auth.signOut();
                }
                // localStorage.removeItem(STORAGE_KEYS.USER_ID); // 제거
                localStorage.removeItem(STORAGE_KEYS.TEACHER_ID);
                localStorage.removeItem(STORAGE_KEYS.LAST_VIEWED);
                // localStorage.removeItem(STORAGE_KEYS.STUDENT_COUNT); // 이제 사용되지 않음
                // 전역 변수 초기화
                teacherId = null;
                // userId = null; // 제거
                checklists = [];
                currentChecklistId = null;
                students = [];
                uploadedStudents = [];
                alert('로그아웃되었습니다. 페이지를 새로고침합니다.');
                location.reload();
            }
        }

        // 교사 ID 검증
        async function validateTeacherId(inputTeacherId) {
            console.log('Validating teacher ID:', inputTeacherId);
            
            if (!supabase) {
                console.log('Supabase not initialized');
                return false;
            }
            
            try {
                const { data, error } = await supabase
                    .from('teachers')
                    .select('teacher_id, name')
                    .eq('teacher_id', inputTeacherId)
                    .single();
                
                console.log('Teacher validation result:', { data, error });
                
                if (error || !data) {
                    console.log('Teacher validation failed:', error);
                    return false;
                }
                
                console.log('Teacher validation success:', data);
                return data;
            } catch (error) {
                console.error('교사 ID 검증 실패:', error);
                return false;
            }
        }

        // 교사 로그인 (로컬스토리지 저장 강화)
        async function teacherLogin() {
            console.log('🔍 teacherLogin 시작');
            const inputTeacherId = document.getElementById('teacherIdInput').value.trim();
            console.log('🔍 입력된 교사 ID:', inputTeacherId);

            if (!inputTeacherId) {
                console.log('❌ 교사 ID 입력 없음');
                alert('교사 아이디를 입력해주세요.');
                return;
            }

            try {
                showSyncStatus('syncing', '로그인 중...');
                
                // 고정된 Supabase 설정으로 클라이언트 생성
                if (!supabase) {
                    console.log('🔍 Supabase 클라이언트 생성');
                    supabase = window.supabase.createClient(SUPABASE_CONFIG.URL, SUPABASE_CONFIG.ANON_KEY);
                }
                
                // 교사 ID 검증
                console.log('🔍 교사 ID 검증 시도');
                const teacherData = await validateTeacherId(inputTeacherId);
                console.log('🔍 교사 ID 검증 결과:', teacherData);

                if (!teacherData) {
                    console.log('❌ 교사 ID 검증 실패');
                    throw new Error('등록되지 않은 교사 아이디입니다. 관리자에게 문의하세요.');
                }

                // 🔥 중요: 교사 ID를 로컬스토리지에 확실히 저장
                console.log('🔍 로컬스토리지에 저장 시도');
                localStorage.setItem(STORAGE_KEYS.TEACHER_ID, inputTeacherId);
                teacherId = inputTeacherId;
                
                // userId 관련 코드 모두 제거
                console.log('✅ 로컬스토리지 저장 완료:', {
                    teacherId: localStorage.getItem(STORAGE_KEYS.TEACHER_ID)
                });

                // UI 업데이트
                document.getElementById('configModal').style.display = 'none';
                document.getElementById('noConnection').classList.add('hidden');
                document.getElementById('mainContent').classList.remove('hidden');
                
                // 교사 정보 표시
                document.getElementById('teacherInfo').textContent = `👨‍🏫 ${teacherData.name || teacherData.teacher_id}`;
                
                // 데이터 로드
                console.log('🔍 체크리스트 로드 시도');
                await loadChecklists();
                console.log('✅ 체크리스트 로드 성공');
                
                showSyncStatus('success', `${teacherData.name || teacherData.teacher_id}님 환영합니다!`);
                setTimeout(() => hideSyncStatus(), 3000);
            } catch (error) {
                console.error('❌ 로그인 실패:', error);
                console.error('❌ 에러 상세:', {
                    message: error.message,
                    stack: error.stack,
                    code: error.code
                });
                alert('로그인 실패:\n\n' + error.message);
                showSyncStatus('error', '로그인 실패');
                setTimeout(() => hideSyncStatus(), 3000);
            }
        }

        // 설정 모달 표시 (저장된 ID 자동 입력)
        function showConfig() {
            const savedTeacherId = localStorage.getItem(STORAGE_KEYS.TEACHER_ID) || '';
            document.getElementById('teacherIdInput').value = savedTeacherId;
            document.getElementById('configModal').style.display = 'flex';
            
            // 입력 필드에 포커스
            setTimeout(() => {
                document.getElementById('teacherIdInput').focus();
                if (savedTeacherId) {
                    document.getElementById('teacherIdInput').select(); // 기존 ID 선택 상태
                }
            }, 100);
        }

        // Supabase 초기화 (자동 로그인 개선)
        async function initSupabase() {
            try {
                console.log('🔍 initSupabase 시작');
                console.log('🔍 현재 시간:', new Date().toISOString());
                console.log('🔍 window.location:', window.location.href);
                console.log('🔍 document.readyState:', document.readyState);
                console.log('🔍 window.supabase 상태:', !!window.supabase);
                console.log('🔍 SUPABASE_CONFIG 상태:', SUPABASE_CONFIG);
                console.log('🔍 localStorage 전체 내용:', {
                    teacherId: localStorage.getItem(STORAGE_KEYS.TEACHER_ID),
                    lastViewed: localStorage.getItem(STORAGE_KEYS.LAST_VIEWED),
                    darkMode: localStorage.getItem(STORAGE_KEYS.DARK_MODE)
                });
                const savedTeacherId = localStorage.getItem(STORAGE_KEYS.TEACHER_ID);
                console.log('🔍 저장된 교사 ID:', savedTeacherId);
                console.log('🔍 저장된 교사 ID 타입:', typeof savedTeacherId);
                console.log('🔍 저장된 교사 ID 길이:', savedTeacherId ? savedTeacherId.length : 0);
                // 고정된 Supabase 설정으로 클라이언트 생성
                supabase = window.supabase.createClient(SUPABASE_CONFIG.URL, SUPABASE_CONFIG.ANON_KEY);
                console.log('🔍 Supabase 클라이언트 생성됨');
                if (savedTeacherId && savedTeacherId.trim() !== '') {
                    console.log('✅ 자동 로그인 시도 - 저장된 교사 ID 발견');
                    // 교사 ID가 저장되어 있으면 바로 로그인 처리
                    teacherId = savedTeacherId;
                    // userId 관련 코드 모두 제거
                    console.log('🔍 로그인 정보:', {
                        teacherId,
                        savedTeacherId
                    });
                    // UI 즉시 업데이트
                    document.getElementById('configModal').style.display = 'none';
                    document.getElementById('noConnection').classList.add('hidden');
                    document.getElementById('mainContent').classList.remove('hidden');
                    // 교사 정보 표시
                    document.getElementById('teacherInfo').textContent = `👨‍🏫 ${teacherId}`;
                    // 데이터 로드 시도
                    try {
                        console.log('🔍 체크리스트 로드 시도');
                        showSyncStatus('syncing', '자동 로그인 중...');
                        await loadChecklists();
                        console.log('✅ 체크리스트 로드 성공');
                        // 학생 데이터도 로드
                        console.log('🔍 학생 데이터 로드 시도');
                        await loadStudents();
                        console.log('✅ 학생 데이터 로드 성공');
                        showSyncStatus('success', `${teacherId}님 환영합니다! (자동 로그인)`);
                        setTimeout(() => hideSyncStatus(), 3000);
                    } catch (error) {
                        console.error('❌ 자동 로그인 데이터 로드 실패:', error);
                        console.error('❌ 에러 상세:', {
                            message: error.message,
                            stack: error.stack,
                            code: error.code
                        });
                        showSyncStatus('error', '일부 데이터 로드 실패 (로그인은 유지됨)');
                        setTimeout(() => hideSyncStatus(), 3000);
                    }
                } else {
                    console.log('❌ 자동 로그인 실패 - 저장된 교사 ID 없음');
                    console.log('🔍 로그인 모달 표시');
                    document.getElementById('configModal').style.display = 'flex';
                    document.getElementById('noConnection').classList.remove('hidden');
                    document.getElementById('mainContent').classList.add('hidden');
                }
            } catch (error) {
                console.error('❌ initSupabase 실행 중 오류:', error);
                console.error('❌ 에러 상세:', {
                    message: error.message,
                    stack: error.stack,
                    code: error.code
                });
                throw error; // 상위 함수에서 처리할 수 있도록 에러를 다시 던짐
            }
        }

        // 체크리스트 로드
        async function loadChecklists() {
            if (!supabase) {
                console.log('Supabase not initialized');
                return;
            }

            try {
                showSyncStatus('syncing', '데이터 로드 중...');
                
                console.log('Loading checklists for teacher:', teacherId);
                
                const { data, error } = await supabase
                    .from('checklists')
                    .select('*')
                    .eq('teacher_id', teacherId)
                    .order('created_at', { ascending: false });

                console.log('Supabase response:', { data, error });

                if (error) {
                    console.error('Supabase load error:', error);
                    throw error;
                }

                if (!data) {
                    console.log('No data returned from Supabase');
                    checklists = [];
                } else {
                    console.log('Raw data from Supabase:', data);
                    
                    checklists = data.map(item => ({
                        id: item.id,
                        n: item.name,
                        c: item.category,
                        sc: item.student_count,
                        s: item.statuses,
                        ct: item.created_at,
                        ut: item.updated_at,
                        t: item.completion_times || Array(item.student_count).fill(null),
                        isDeadline: item.is_deadline || false,
                        isGroupChecklist: item.is_group_checklist || false // 모둠 체크리스트 여부
                    }));
                    
                    console.log('Processed checklists:', checklists);
                }

                hideSyncStatus();
                renderChecklistList();
                updateCategoryCheckboxes();
                
                // 마지막으로 본 체크리스트 선택
                const lastViewedId = localStorage.getItem(STORAGE_KEYS.LAST_VIEWED);
                if (lastViewedId && checklists.some(c => c.id == lastViewedId)) {
                    selectChecklist(parseInt(lastViewedId));
                } else if (checklists.length > 0) {
                    selectChecklist(checklists[0].id);
                }
                
            } catch (error) {
                console.error('체크리스트 로드 실패:', error);
                showSyncStatus('error', '로드 실패: ' + error.message);
                setTimeout(() => hideSyncStatus(), 5000);
                
                checklists = [];
                renderChecklistList();
                updateCategoryCheckboxes();
            }
        }

        // Supabase에 체크리스트 저장
        async function saveChecklistToSupabase(checklist) {
            if (!supabase) return;

            try {
                const checklistData = {
                    id: checklist.id,
                    teacher_id: teacherId,
                    name: checklist.n,
                    category: checklist.c,
                    student_count: checklist.sc,
                    statuses: checklist.s,
                    completion_times: checklist.t || Array(checklist.sc).fill(null),
                    created_at: checklist.ct,
                    updated_at: new Date().toISOString(),
                    is_deadline: checklist.isDeadline,
                    is_group_checklist: checklist.isGroupChecklist // is_group_checklist 필드 추가
                };

                console.log('Saving to Supabase:', checklistData);

                const { data, error } = await supabase
                    .from('checklists')
                    .upsert(checklistData, { 
                        onConflict: 'id',
                        ignoreDuplicates: false 
                    });

                if (error) {
                    console.error('Supabase error details:', error);
                    throw error;
                }

                console.log('Successfully saved to Supabase:', data);
            } catch (error) {
                console.error('Supabase 저장 실패:', error);
                throw error;
            }
        }

        // 체크리스트 생성
        async function createChecklist() {
            if (!supabase) {
                alert('Supabase에 연결되지 않았습니다. 설정을 확인해주세요.');
                return;
            }

            if (students.length === 0) {
                alert('학생 정보를 먼저 등록해주세요.');
                return;
            }

            const category = document.getElementById('categorySelect').value;
            const studentCount = students.length;
            
            const now = new Date().toISOString();
            const checklist = {
                id: Date.now(),
                n: `${category} 체크리스트 ${checklists.length + 1}`,
                c: category,
                sc: studentCount,
                s: Array(studentCount).fill(0),
                ct: now,
                ut: now,
                t: Array(studentCount).fill(null),
                student_names: students.map(s => s.student_name),
                isDeadline: false, // 기본값: 마감 전
                isGroupChecklist: false // 일반 체크리스트
            };

            checklists.unshift(checklist);
            
            try {
                showSyncStatus('syncing', '저장 중...');
                await saveChecklistToSupabase(checklist);
                showSyncStatus('success', '저장됨');
                setTimeout(() => hideSyncStatus(), 1000);
                
                renderChecklistList();
                selectChecklist(checklist.id);
                updateCategoryCheckboxes();
                
            } catch (error) {
                console.error('체크리스트 생성 실패:', error);
                showSyncStatus('error', '저장 실패');
                setTimeout(() => hideSyncStatus(), 3000);
                checklists.shift();
                renderChecklistList();
            }
        }

        // 카테고리 체크박스 업데이트
        function updateCategoryCheckboxes() {
            const container = document.getElementById('categoryCheckboxes');
            const categories = [...new Set(checklists.map(c => c.c))];
            container.innerHTML = categories.map(category => `
                <label class="flex items-center">
                    <input type="checkbox" value="${category}" checked 
                           class="mr-2" onchange="filterChecklists()">
                    ${category}
                </label>
            `).join('');
        }

        // 카테고리 필터 토글
        function toggleCategoryFilter() {
            const filter = document.getElementById('categoryFilter');
            filter.classList.toggle('hidden');
        }

        // 체크리스트 필터링
        function filterChecklists() {
            const checkboxes = document.querySelectorAll('#categoryFilter input[type="checkbox"]');
            const selectedCategories = Array.from(checkboxes)
                .filter(cb => cb.checked)
                .map(cb => cb.value);

            const listContainer = document.getElementById('checklistList');
            const items = listContainer.getElementsByClassName('checklist-item');
            
            Array.from(items).forEach(item => {
                const category = item.dataset.category;
                if (selectedCategories.includes('all') || selectedCategories.includes(category)) {
                    item.classList.remove('hidden');
                } else {
                    item.classList.add('hidden');
                }
            });
        }

        // 체크리스트 목록 렌더링
        function renderChecklistList() {
            const listContainer = document.getElementById('checklistList');
            
            console.log('Rendering checklist list, checklists count:', checklists.length);
            
            if (checklists.length === 0) {
                listContainer.innerHTML = '<div class="text-center text-gray-500 dark:text-gray-400 py-4">체크리스트가 없습니다.</div>';
                return;
            }
            
            listContainer.innerHTML = checklists.map(checklist => {
                const truncatedTitle = checklist.n.length > 15 ? checklist.n.substring(0, 15) + '...' : checklist.n;
                const deadlineIcon = checklist.isDeadline ? 
                    '<span title="마감됨" class="text-xs mr-1 bg-red-100 text-red-800 dark:bg-red-900 dark:text-red-300 px-1.5 py-0.5 rounded-full">🔒</span>' : 
                    '';
                // 모둠 체크리스트일 경우 아이콘 추가
                const groupIcon = checklist.isGroupChecklist ? 
                    '<span title="모둠 체크리스트" class="text-xs mr-1 bg-purple-100 text-purple-800 dark:bg-purple-900 dark:text-purple-300 px-1.5 py-0.5 rounded-full">👨‍👩‍👧‍👦</span>' : 
                    '';
                return `
                <div class="checklist-item flex items-center p-2 bg-gray-50 rounded cursor-pointer hover:bg-gray-100 ${currentChecklistId === checklist.id ? 'bg-blue-100 dark:bg-blue-900' : ''} dark:bg-gray-700 dark:hover:bg-gray-600"
                     onclick="selectChecklist(${checklist.id})"
                     data-category="${checklist.c}">
                    <div class="flex-1 flex items-center gap-2 min-w-0">
                        <span class="flex-shrink-0 px-2 py-0.5 text-xs rounded-full bg-gray-200 dark:bg-gray-600 text-gray-600 dark:text-gray-300">${checklist.c}</span>
                        <span class="truncate dark:text-gray-100 flex-1 min-w-0" title="${checklist.n}">
                            ${deadlineIcon}${groupIcon}${truncatedTitle}
                        </span>
                    </div>
                </div>
            `}).join('');
        }

        // 체크리스트 선택
        function selectChecklist(id) {
            console.log('🔍 selectChecklist 시작:', id);
            currentChecklistId = id;
            localStorage.setItem(STORAGE_KEYS.LAST_VIEWED, id);
            
            const checklist = checklists.find(c => c.id === id);
            if (checklist) {
                console.log('🔍 선택된 체크리스트:', checklist);
                document.getElementById('checklistActions').classList.remove('hidden');
                document.getElementById('statistics').classList.remove('hidden');
                document.getElementById('checklistTitle').value = checklist.n;
                
                const categorySelect = document.getElementById('editCategorySelect');
                categorySelect.value = checklist.c;
                
                // 생성/수정 시각 표시
                const createdAt = new Date(checklist.ct);
                const updatedAt = new Date(checklist.ut);
                
                const createdKST = createdAt.toLocaleString('ko-KR', {
                    timeZone: 'Asia/Seoul',
                    year: 'numeric',
                    month: '2-digit',
                    day: '2-digit',
                    hour: '2-digit',
                    minute: '2-digit',
                    second: '2-digit',
                    hour12: false
                });
                
                const updatedKST = updatedAt.toLocaleString('ko-KR', {
                    timeZone: 'Asia/Seoul',
                    year: 'numeric',
                    month: '2-digit',
                    day: '2-digit',
                    hour: '2-digit',
                    minute: '2-digit',
                    second: '2-digit',
                    hour12: false
                });
                
                // 마감 상태 표시 추가
                const deadlineStatus = checklist.isDeadline ? 
                    `<span class="ml-2 px-1.5 py-0.5 text-xs rounded-full bg-red-100 text-red-800 dark:bg-red-900 dark:text-red-300">마감됨</span>` : 
                    `<span class="ml-2 px-1.5 py-0.5 text-xs rounded-full bg-green-100 text-green-800 dark:bg-green-900 dark:text-green-300">진행중</span>`;
                
                document.getElementById('checklistInfo').innerHTML = `
                    생성: ${createdKST} | 
                    수정: ${updatedKST}
                    ${deadlineStatus}
                `;

                // 학생 데이터가 없으면 로드 시도
                if (students.length === 0) {
                    console.log('🔍 학생 데이터 없음, 로드 시도');
                    loadStudents().then(() => {
                        console.log('🔍 학생 데이터 로드 후 체크리스트 렌더링');
                        renderChecklistContent(checklist);
                        updateStatistics(checklist);
                    });
                } else {
                    console.log('🔍 기존 학생 데이터로 체크리스트 렌더링');
                    renderChecklistContent(checklist);
                    updateStatistics(checklist);
                }
                
                renderChecklistList();
            }
        }

        // 현재 체크리스트 업데이트
        async function updateCurrentChecklist() {
            if (!currentChecklistId || !supabase) return;
            
            const newName = document.getElementById('checklistTitle').value;
            const newCategory = document.getElementById('editCategorySelect').value;
            const checklist = checklists.find(c => c.id === currentChecklistId);
            
            if (checklist) {
                checklist.n = newName;
                checklist.c = newCategory;
                checklist.ut = new Date().toISOString();
                
                // 즉시 UI 업데이트 추가
                renderChecklistContent(checklist);
                updateStatistics(checklist);
                
                try {
                    showSyncStatus('syncing', '저장 중...');
                    await saveChecklistToSupabase(checklist);
                    showSyncStatus('success', '저장됨');
                    setTimeout(() => hideSyncStatus(), 1000);
                    
                    renderChecklistList();
                    selectChecklist(currentChecklistId);
                    updateCategoryCheckboxes();
                } catch (error) {
                    console.error('업데이트 실패:', error);
                    showSyncStatus('error', '저장 실패');
                    setTimeout(() => hideSyncStatus(), 3000);
                }
            }
        }

        // 현재 체크리스트 삭제
        async function deleteCurrentChecklist() {
            if (!currentChecklistId || !supabase) return;
            
            if (confirm('정말 삭제하시겠습니까?')) {
                try {
                    showSyncStatus('syncing', '삭제 중...');
                    const { error } = await supabase
                        .from('checklists')
                        .delete()
                        .eq('id', currentChecklistId)
                        .eq('teacher_id', teacherId);
                    
                    if (error) throw error;
                    
                    showSyncStatus('success', '삭제됨');
                    setTimeout(() => hideSyncStatus(), 1000);
                    
                    checklists = checklists.filter(c => c.id !== currentChecklistId);
                    
                    currentChecklistId = null;
                    document.getElementById('checklistActions').classList.add('hidden');
                    document.getElementById('statistics').classList.add('hidden');
                    document.getElementById('checklistContent').innerHTML = '';
                    document.getElementById('checklistTitle').value = '';
                    document.getElementById('checklistInfo').innerHTML = '';
                    
                    renderChecklistList();
                    updateCategoryCheckboxes();
                } catch (error) {
                    console.error('삭제 실패:', error);
                    showSyncStatus('error', '삭제 실패');
                    setTimeout(() => hideSyncStatus(), 3000);
                }
            }
        }

        // 완료 순위 계산
        function getCompletionRanking(checklist) {
            return checklist.t
                .map((time, index) => ({ index, time }))
                .filter(item => item.time !== null)
                .sort((a, b) => new Date(a.time) - new Date(b.time))
                .reduce((acc, item, idx) => {
                    acc[item.index] = idx + 1;
                    return acc;
                }, {});
        }

        // 상태 변경
        async function changeStatus(checklistId, studentIndex) {
            if (!supabase) return;

            const checklist = checklists.find(c => c.id === checklistId);
            if (checklist) {
                const currentStatusId = checklist.s[studentIndex];
                let nextStatusId;
                
                // 마감 전/후에 따라 다른 상태 변경 로직 적용
                if (checklist.isDeadline) {
                    // 마감 후: 모든 상태 사용 가능 (완료, 진행중, 재제출, 미완료, 미제출마감)
                    const statusKeys = Object.values(STATUS);
                    const currentIndex = statusKeys.findIndex(status => status.id === currentStatusId);
                    const nextIndex = (currentIndex + 1) % statusKeys.length;
                    nextStatusId = statusKeys[nextIndex].id;
                } else {
                    // 마감 전: 완료(1)와 미완료(0) 상태만 토글
                    nextStatusId = currentStatusId === 0 ? 1 : 0;
                }
                
                checklist.s[studentIndex] = nextStatusId;
                
                // 완료 상태로 변경될 때 시간 기록
                if (nextStatusId === 1) {
                    checklist.t[studentIndex] = new Date().toISOString();
                } else if (currentStatusId === 1) {
                    checklist.t[studentIndex] = null;
                }
                
                checklist.ut = new Date().toISOString();
                
                try {
                    await saveChecklistToSupabase(checklist);
                    renderChecklistContent(checklist);
                    updateStatistics(checklist);
                } catch (error) {
                    console.error('상태 변경 실패:', error);
                    showSyncStatus('error', '저장 실패');
                    setTimeout(() => hideSyncStatus(), 3000);
                }
            }
        }

        // 통계 업데이트 (개선된 버전)
        function updateStatistics(checklist) {
            const total = checklist.s.length;
            const counts = { 0: 0, 1: 0, 2: 0, 3: 0, 4: 0 };

            checklist.s.forEach(statusId => {
                counts[statusId]++;
            });

            // 모둠 체크리스트 여부에 따라 단위 설정
            const unitText = checklist.isGroupChecklist ? '모둠' : '명';
            document.querySelectorAll('[id^="unitText"]').forEach(el => {
                el.textContent = unitText;
            });

            const statusMapping = {
                0: { countId: 'incompleteCount', percentId: 'incompletePercent', barId: 'incompleteBar' },
                1: { countId: 'completedCount', percentId: 'completedPercent', barId: 'completedBar' },
                2: { countId: 'inProgressCount', percentId: 'inProgressPercent', barId: 'inProgressBar' },
                3: { countId: 'resubmitCount', percentId: 'resubmitPercent', barId: 'resubmitBar' },
                4: { countId: 'deadlineCount', percentId: 'deadlinePercent', barId: 'deadlineBar' }
            };

            Object.entries(counts).forEach(([statusId, count]) => {
                const percent = total > 0 ? ((count / total) * 100).toFixed(1) : '0.0';
                const { countId, percentId, barId } = statusMapping[statusId];
                
                document.getElementById(countId).textContent = count;
                document.getElementById(percentId).textContent = percent;
                document.getElementById(barId).style.width = `${percent}%`;
            });

            // 완료 순위 표시
            const completionOrder = checklist.t
                .map((time, index) => ({ index, time }))
                .filter(item => item.time !== null)
                .sort((a, b) => new Date(a.time) - new Date(b.time))
                .slice(0, 5);

            const statisticsSection = document.getElementById('statistics');
            const existingRanking = statisticsSection.querySelector('.ranking-section');
            if (existingRanking) {
                existingRanking.remove();
            }

            if (completionOrder.length > 0) {
                // 모둠 체크리스트인지 확인
                const isGroupChecklist = checklist.isGroupChecklist;
                
                const rankingHtml = `
                    <div class="ranking-section mt-4 p-3 bg-gray-50 dark:bg-gray-700 rounded-lg">
                        <h4 class="text-sm font-semibold dark:text-gray-100 mb-2">🏆 완료 순위 (상위 5개)</h4>
                        <div class="space-y-1">
                            ${completionOrder.map((item, idx) => {
                                let displayText = '';
                                
                                if (isGroupChecklist) {
                                    // 모둠 체크리스트인 경우 모둠 형식으로 표시
                                    const groupNumber = item.index + 1;
                                    displayText = `${groupNumber}모둠`;
                                } else {
                                    // 일반 체크리스트인 경우 기존 형식대로 표시
                                    const studentInfo = students[item.index] || { 
                                        student_number: item.index + 1, 
                                        student_name: `학생 ${item.index + 1}` 
                                    };
                                    displayText = `${studentInfo.student_number}번 ${studentInfo.student_name}`;
                                }
                                
                                const completionTime = new Date(item.time);
                                const koreanTime = completionTime.toLocaleString('ko-KR', {
                                    timeZone: 'Asia/Seoul',
                                    hour: '2-digit',
                                    minute: '2-digit',
                                    second: '2-digit',
                                    hour12: false
                                });

                                return `
                                <div class="flex items-center justify-between text-sm">
                                    <span class="dark:text-gray-100">
                                        ${idx + 1}위: ${displayText}
                                    </span>
                                    <span class="text-gray-500 dark:text-gray-400">
                                        ${koreanTime}
                                    </span>
                                </div>
                            `}).join('')}
                        </div>
                    </div>
                `;
                statisticsSection.insertAdjacentHTML('beforeend', rankingHtml);
            }
        }

        // 체크리스트 내용 렌더링 함수 수정 (기존 함수 대체)
        function renderChecklistContent(checklist) {
            const contentContainer = document.getElementById('checklistContent');
            
            // 모둠 체크리스트 여부를 isGroupChecklist로만 판단
            if (checklist.isGroupChecklist) {
                renderGroupChecklistContent(checklist, contentContainer);
            } else {
                renderStudentChecklistContent(checklist, contentContainer);
            }
            
            // 마감 버튼 추가 - 기존 문제 해결을 위해 완전히 교체
            const deadlineButtonContainer = document.getElementById('checklistActions');
            
            // 마감 상태에 따라 버튼 텍스트 변경
            const deadlineButtonText = checklist.isDeadline ? '마감 해제' : '마감하기';
            const deadlineButtonIcon = checklist.isDeadline ? '🔓' : '🔒';
            const deadlineButtonClass = checklist.isDeadline ? 'bg-green-100 text-green-800 dark:bg-green-900 dark:text-green-300' : 'bg-blue-100 text-blue-800 dark:bg-blue-900 dark:text-blue-300';
            
            // 삭제 버튼을 포함한 모든 내용을 새로 설정
            deadlineButtonContainer.innerHTML = `
                <button onclick="toggleDeadline(${checklist.id})" 
                        class="icon-btn mr-2 ${deadlineButtonClass}" title="${deadlineButtonText}">
                    ${deadlineButtonIcon}
                </button>
                <button onclick="deleteCurrentChecklist()" 
                        class="icon-btn text-red-500 hover:bg-red-100 dark:hover:bg-red-900">
                    🗑️
                </button>
            `;

            // 전체화면 버튼의 상태를 유지
            document.getElementById('fullscreenBtn').innerHTML = isFullscreen ? '⬅️' : '🔍';
            document.getElementById('fullscreenBtn').title = isFullscreen ? '전체화면 해제' : '전체화면';
        }

        // 학생 체크리스트 렌더링 (기존 renderChecklistContent 함수의 내용)
        function renderStudentChecklistContent(checklist, contentContainer) {
            // 완료 순위 계산
            const rankings = getCompletionRanking(checklist);
            // 체크리스트의 학생 수와 실제 등록된 학생 수가 다른 경우 처리
            const maxStudents = Math.min(students.length, checklist.s.length);
            // 학생 목록이 없으면 메시지 표시
            if (maxStudents === 0) {
                contentContainer.innerHTML = `
                    <div class="text-center py-8 text-gray-500 dark:text-gray-400">
                        <div class="text-3xl mb-4">🤷‍♂️</div>
                        <div class="text-lg font-semibold mb-2">등록된 학생이 없습니다.</div>
                        <div class="text-sm">좌측 "학생 추가" 버튼을 클릭하여 학생 목록을 설정해주세요.</div>
                    </div>
                `;
                return;
            }
            contentContainer.innerHTML = students.slice(0, maxStudents).map((student, index) => {
                const status = getStatusById(checklist.s[index]);
                if (!status) {
                    console.warn(`Invalid status ID: ${checklist.s[index]} at index ${index}`);
                    return '';
                }
                const ranking = rankings[index];
                const studentNumber = student.student_number;
                const studentName = student.student_name;
                return `
                    <div class="student-card bg-white dark:bg-gray-700 rounded-lg shadow-md relative">
                        ${ranking ? `<div class="ranking-badge">${ranking}</div>` : ''}
                        <div class="student-number" title="${studentName}">
                            ${studentNumber}번 <br> ${studentName}
                        </div>
                        <button class="status-btn ${status.color} text-white w-full"
                                onclick="changeStatus(${checklist.id}, ${index})"
                                title="${studentNumber}번 ${studentName} - ${status.text}">
                            ${status.text}
                        </button>
                    </div>
                `;
            }).join('');
        }

        // 모둠 체크리스트 렌더링
        function renderGroupChecklistContent(checklist, contentContainer) {
            // 완료 순위 계산
            const rankings = getCompletionRanking(checklist);
            
            contentContainer.innerHTML = Array.from({length: checklist.sc}, (_, index) => {
                const status = getStatusById(checklist.s[index]);
                const ranking = rankings[index];
                const groupNumber = index + 1;

                return `
                    <div class="student-card bg-white dark:bg-gray-700 rounded-lg shadow-md relative">
                        ${ranking ? `<div class="ranking-badge">${ranking}</div>` : ''}
                        <div class="student-number" title="${groupNumber}모둠">
                            ${groupNumber}모둠
                        </div>
                        <button class="status-btn ${status.color} text-white w-full"
                                onclick="changeStatus(${checklist.id}, ${index})"
                                title="${groupNumber}모둠 - ${status.text}">
                            ${status.text}
                        </button>
                    </div>
                `;
            }).join('');
        }

        // 마감 상태 토글 함수
        async function toggleDeadline(checklistId) {
            if (!supabase) return;

            const checklist = checklists.find(c => c.id === checklistId);
            if (checklist) {
                // 상태 변경
                checklist.isDeadline = !checklist.isDeadline;
                checklist.ut = new Date().toISOString();
                
                try {
                    showSyncStatus('syncing', '마감 상태 변경 중...');
                    // 서버에 마감 상태 저장
                    await saveChecklistToSupabase(checklist);
                    showSyncStatus('success', checklist.isDeadline ? '마감 완료' : '마감 해제');
                    setTimeout(() => hideSyncStatus(), 1000);
                    
                    renderChecklistContent(checklist);
                } catch (error) {
                    console.error('마감 상태 변경 실패:', error);
                    checklist.isDeadline = !checklist.isDeadline; // 실패 시 원래 상태로 되돌림
                    showSyncStatus('error', '마감 상태 변경 실패');
                    setTimeout(() => hideSyncStatus(), 3000);
                }
            }
        }

        // 다크모드 토글
        function toggleDarkMode() {
            isDarkMode = !isDarkMode;
            if (isDarkMode) {
                document.documentElement.classList.add('dark');
                document.getElementById('darkModeIcon').textContent = '☀️';
            } else {
                document.documentElement.classList.remove('dark');
                document.getElementById('darkModeIcon').textContent = '🌙';
            }
            localStorage.setItem(STORAGE_KEYS.DARK_MODE, isDarkMode);
        }

        // 시계 업데이트
        function updateClock() {
            const now = new Date();
            document.getElementById('clock').textContent = now.toLocaleTimeString();
        }

        // 초기화
        async function init() {
            try {
                console.log('🔍 init 함수 시작');
                
                // 다크모드 설정
                if (isDarkMode) {
                    console.log('🔍 다크모드 적용');
                    document.documentElement.classList.add('dark');
                    document.getElementById('darkModeIcon').textContent = '☀️';
                }

                // 시계 시작
                console.log('🔍 시계 초기화');
                updateClock();
                setInterval(updateClock, 1000);

                // 저장된 학생 수 불러오기
                const savedCount = localStorage.getItem(STORAGE_KEYS.STUDENT_COUNT);
                if (savedCount) {
                    console.log('🔍 저장된 학생 수:', savedCount);
                    document.getElementById('studentCountDisplay').textContent = savedCount;
                }

                // Supabase 초기화
                console.log('🔍 Supabase 초기화 시작');
                await initSupabase();
                console.log('🔍 Supabase 초기화 완료');
            } catch (error) {
                console.error('❌ 초기화 중 오류 발생:', error);
                console.error('❌ 에러 상세:', {
                    message: error.message,
                    stack: error.stack,
                    code: error.code
                });
            }
        }

        // 페이지 로드 시 초기화
        document.addEventListener('DOMContentLoaded', async () => {
            cleanUpOAuthParams();
            console.log('🔍 DOMContentLoaded 이벤트 발생');
            console.log('🔍 window.supabase 상태:', !!window.supabase);
            console.log('🔍 SUPABASE_CONFIG 상태:', SUPABASE_CONFIG);
            init().catch(error => {
                console.error('❌ init 함수 실행 중 오류:', error);
            });
            if (!supabase) {
                supabase = window.supabase.createClient(SUPABASE_CONFIG.URL, SUPABASE_CONFIG.ANON_KEY);
            }
            const { data: { session } } = await supabase.auth.getSession();
            if (session) {
                // 이미 로그인된 경우
                // session.user.email 등으로 사용자 정보 사용 가능
                // teacherId = session.user.email; 등으로 활용 가능
            }
            await handleGoogleLoginResult();
        });

        // 학생 관련 함수들
        async function loadStudents() {
            console.log('🔍 loadStudents 시작');
            console.log('🔍 현재 상태:', {
                supabase: !!supabase,
                teacherId,
                students: students.length
            });

            if (!supabase || !teacherId) {
                console.log('❌ 학생 로드 실패 - Supabase 또는 teacherId 없음:', {
                    supabase: !!supabase,
                    teacherId
                });
                students = [];
                updateStudentDisplay();
                return;
            }

            try {
                showSyncStatus('syncing', '학생 목록 로드 중...');
                console.log('🔍 Supabase 쿼리 실행:', {
                    table: 'students',
                    teacher_id: teacherId
                });

                const { data, error } = await supabase
                    .from('students')
                    .select('*')
                    .eq('teacher_id', teacherId)
                    .order('student_number', { ascending: true });

                console.log('🔍 Supabase 응답:', { data, error });

                if (error) {
                    if (error.code === 'PGRST116' || error.message.includes('relation "students" does not exist')) {
                        console.warn('❌ Supabase "students" 테이블이 존재하지 않음');
                        students = [];
                        updateStudentDisplay();
                        hideSyncStatus();
                        return;
                    }
                    throw error;
                }

                students = data || [];
                console.log('✅ 학생 데이터 로드 성공:', {
                    count: students.length,
                    firstStudent: students[0],
                    lastStudent: students[students.length - 1]
                });

                updateStudentDisplay();
                hideSyncStatus();
            } catch (error) {
                console.error('❌ 학생 정보 로드 실패:', error);
                console.error('❌ 에러 상세:', {
                    message: error.message,
                    stack: error.stack,
                    code: error.code
                });
                showSyncStatus('error', '학생 목록 로드 실패: ' + error.message);
                setTimeout(() => hideSyncStatus(), 5000);
                students = [];
                updateStudentDisplay();
            }
        }

        function updateStudentDisplay() {
            const noStudents = document.getElementById('noStudents');
            const hasStudents = document.getElementById('hasStudents');
            const createButton = document.getElementById('createChecklist');
            const createGroupButton = document.getElementById('createGroupChecklist');
            
            if (students.length === 0) {
                noStudents.classList.remove('hidden');
                hasStudents.classList.add('hidden');
                createButton.disabled = true;
                createGroupButton.disabled = true;
            } else {
                noStudents.classList.add('hidden');
                hasStudents.classList.remove('hidden');
                createButton.disabled = false;
                createGroupButton.disabled = false;
                
                document.getElementById('studentCountDisplay').textContent = students.length;
                document.getElementById('studentList').innerHTML = students
                    .slice(0, 5)
                    .map(s => `${s.student_number}. ${s.student_name}`)
                    .join(', ') + (students.length > 5 ? '...' : '');
            }
        }

        function downloadCSVTemplate() {
            // ANSI(EUC-KR) 인코딩을 위한 한글 CSV 내용
            const csvContent = "학생번호,학생이름\n1,홍길동\n2,김철수\n3,이영희";
            
            // EUC-KR 인코딩으로 변환 (엑셀 호환)
            const blob = new Blob(['\uFEFF' + csvContent], { 
                type: 'text/csv;charset=utf-8;' 
            });
            
            const link = document.createElement('a');
            
            if (link.download !== undefined) {
                const url = URL.createObjectURL(blob);
                link.setAttribute('href', url);
                link.setAttribute('download', '학생명단_양식.csv');
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            }
        }

        function uploadStudentCSV() {
            const fileInput = document.getElementById('csvFileInput');
            const file = fileInput.files[0];
            
            if (!file) {
                alert('CSV 파일을 선택해주세요.');
                return;
            }

            // 먼저 ANSI(EUC-KR) 인코딩으로 시도
            tryParseWithEncoding(file, 'EUC-KR', function(success, results) {
                if (success) {
                    console.log('🔍 EUC-KR 인코딩으로 성공');
                    processCSVResults(results);
                } else {
                    // EUC-KR이 실패하면 UTF-8로 시도
                    console.log('🔍 EUC-KR 실패, UTF-8로 재시도');
                    tryParseWithEncoding(file, 'UTF-8', function(success, results) {
                        if (success) {
                            console.log('🔍 UTF-8 인코딩으로 성공');
                            processCSVResults(results);
                        } else {
                            alert('CSV 파일을 읽을 수 없습니다. 파일 형식을 확인해주세요.');
                        }
                    });
                }
            });
        }

        // 특정 인코딩으로 파일 읽기 시도
        function tryParseWithEncoding(file, encoding, callback) {
            const reader = new FileReader();
            
            reader.onload = function(e) {
                try {
                    const csvText = e.target.result;
                    console.log(`🔍 ${encoding} 인코딩으로 읽은 텍스트:`, csvText.substring(0, 100));
                    
                    Papa.parse(csvText, {
                        header: true,
                        skipEmptyLines: true,
                        dynamicTyping: false,
                        complete: function(results) {
                            if (results.errors.length > 0) {
                                console.error(`${encoding} 파싱 오류:`, results.errors);
                                callback(false, null);
                                return;
                            }
                            
                            // 한글이 제대로 파싱되었는지 확인
                            const hasKorean = results.data.some(row => 
                                Object.values(row).some(value => 
                                    typeof value === 'string' && /[가-힣]/.test(value)
                                )
                            );
                            
                            console.log(`🔍 ${encoding} 한글 감지:`, hasKorean);
                            console.log(`🔍 ${encoding} 첫 번째 행:`, results.data[0]);
                            
                            callback(true, results);
                        },
                        error: function(error) {
                            console.error(`${encoding} 파싱 오류:`, error);
                            callback(false, null);
                        }
                    });
                } catch (error) {
                    console.error(`${encoding} 읽기 오류:`, error);
                    callback(false, null);
                }
            };
            
            reader.onerror = function() {
                console.error(`${encoding} 파일 읽기 실패`);
                callback(false, null);
            };
            
            // 인코딩에 따라 다르게 읽기
            if (encoding === 'EUC-KR') {
                reader.readAsText(file, 'EUC-KR');
            } else {
                reader.readAsText(file, 'UTF-8');
            }
        }

        // CSV 결과 처리
        function processCSVResults(results) {
            console.log('🔍 CSV 파싱 결과:', results);
            console.log('🔍 첫 번째 행 데이터:', results.data[0]);
            console.log('🔍 헤더들:', Object.keys(results.data[0] || {}));
            
            // 헤더 정리 함수 (공백, 특수문자 제거)
            function cleanHeader(header) {
                return header.replace(/[\s\uFEFF\xA0]/g, '').toLowerCase();
            }

            // 가능한 모든 헤더 조합 확인
            const parsedStudents = results.data
                .filter(row => {
                    // 모든 키를 정리해서 확인
                    const cleanKeys = Object.keys(row).map(key => ({
                        original: key,
                        clean: cleanHeader(key)
                    }));
                    
                    // 학생번호 찾기
                    const numberKey = cleanKeys.find(k => 
                        k.clean.includes('번호') || 
                        k.clean.includes('number') || 
                        k.clean === '학생번호' ||
                        k.clean === '번호'
                    )?.original;
                    
                    // 학생이름 찾기
                    const nameKey = cleanKeys.find(k => 
                        k.clean.includes('이름') || 
                        k.clean.includes('name') || 
                        k.clean === '학생이름' ||
                        k.clean === '이름'
                    )?.original;
                    
                    return numberKey && nameKey && row[numberKey] && row[nameKey];
                })
                .map(row => {
                    const cleanKeys = Object.keys(row).map(key => ({
                        original: key,
                        clean: cleanHeader(key)
                    }));
                    
                    const numberKey = cleanKeys.find(k => 
                        k.clean.includes('번호') || 
                        k.clean.includes('number') || 
                        k.clean === '학생번호' ||
                        k.clean === '번호'
                    )?.original;
                    
                    const nameKey = cleanKeys.find(k => 
                        k.clean.includes('이름') || 
                        k.clean.includes('name') || 
                        k.clean === '학생이름' ||
                        k.clean === '이름'
                    )?.original;
                    
                    const studentNumber = parseInt(String(row[numberKey]).trim());
                    const studentName = String(row[nameKey]).trim();
                    
                    return {
                        student_number: studentNumber,
                        student_name: studentName
                    };
                })
                .filter(student => !isNaN(student.student_number) && student.student_name && student.student_name !== '');

            console.log('🔍 최종 처리된 학생 데이터:', parsedStudents);

            if (parsedStudents.length === 0) {
                alert(`유효한 학생 정보가 없습니다.\n\n현재 감지된 헤더: ${Object.keys(results.data[0] || {}).join(', ')}\n\n올바른 형식:\n학생번호,학생이름\n1,홍길동\n2,김철수`);
                return;
            }

            const duplicates = parsedStudents.filter((student, index, arr) => 
                arr.findIndex(s => s.student_number === student.student_number) !== index
            );
            
            if (duplicates.length > 0) {
                alert('중복된 학생번호가 있습니다: ' + duplicates.map(s => s.student_number).join(', '));
                return;
            }

            uploadedStudents = parsedStudents.sort((a, b) => a.student_number - b.student_number);
            
            document.getElementById('studentPreview').classList.remove('hidden');
            document.getElementById('studentPreviewList').innerHTML = uploadedStudents
                .map(s => `<div>${s.student_number}. ${s.student_name}</div>`)
                .join('');
        }

        function showStudentUploadModal() {
            document.getElementById('studentUploadModal').classList.remove('hidden');
            document.getElementById('studentPreview').classList.add('hidden');
            document.getElementById('csvFileInput').value = '';
            uploadedStudents = [];
        }

        function closeStudentUploadModal() {
            document.getElementById('studentUploadModal').classList.add('hidden');
            uploadedStudents = [];
        }

        async function saveStudentData() {
            if (uploadedStudents.length === 0) {
                alert('저장할 학생 정보가 없습니다.');
                return;
            }

            if (!supabase || !teacherId) {
                alert('로그인 상태를 확인해주세요.');
                return;
            }

            try {
                showSyncStatus('syncing', '학생 정보 저장 중...');

                try {
                    const { error: deleteError } = await supabase
                        .from('students')
                        .delete()
                        .eq('teacher_id', teacherId);

                    if (deleteError && !deleteError.message.includes('relation "students" does not exist')) {
                        throw deleteError;
                    }
                } catch (deleteError) {
                    console.log('Delete error (table may not exist):', deleteError);
                }

                const studentsToSave = uploadedStudents.map(student => ({
                    id: Date.now() + student.student_number,
                    teacher_id: teacherId,
                    student_number: student.student_number,
                    student_name: student.student_name,
                    created_at: new Date().toISOString(),
                    updated_at: new Date().toISOString()
                }));

                const { error: insertError } = await supabase
                    .from('students')
                    .insert(studentsToSave);

                if (insertError) {
                    if (insertError.message.includes('relation "students" does not exist')) {
                        alert('Supabase에서 students 테이블을 먼저 생성해주세요.\n\n관리자에게 문의하세요.');
                        return;
                    }
                    throw insertError;
                }

                students = studentsToSave;
                updateStudentDisplay();
                closeStudentUploadModal();
                
                showSyncStatus('success', `${students.length}명의 학생 정보가 저장되었습니다!`);
                setTimeout(() => hideSyncStatus(), 3000);

            } catch (error) {
                console.error('학생 정보 저장 실패:', error);
                showSyncStatus('error', '저장 실패: ' + error.message);
                setTimeout(() => hideSyncStatus(), 3000);
            }
        }

        // 모둠 체크리스트 모달 표시
        function showGroupChecklistModal() {
            document.getElementById('groupChecklistModal').classList.remove('hidden');
            document.getElementById('groupCountInput').value = '6';
            document.getElementById('groupChecklistName').value = '';
            setTimeout(() => {
                document.getElementById('groupChecklistName').focus();
            }, 100);
        }

        // 모둠 체크리스트 모달 닫기
        function closeGroupChecklistModal() {
            document.getElementById('groupChecklistModal').classList.add('hidden');
        }

        // 모둠 체크리스트 생성
        async function createGroupChecklist() {
            if (!supabase) {
                alert('Supabase에 연결되지 않았습니다. 설정을 확인해주세요.');
                return;
            }

            const groupCount = parseInt(document.getElementById('groupCountInput').value);
            const checklistName = document.getElementById('groupChecklistName').value.trim() || `모둠 체크리스트 ${checklists.length + 1}`;
            const category = document.getElementById('groupCategorySelect').value; // 모둠 전용 카테고리 선택기 사용
            
            if (groupCount <= 0 || groupCount > 20) {
                alert('모둠 개수는 1~20개 사이로 입력해주세요.');
                return;
            }
            
            const now = new Date().toISOString();
            const checklist = {
                id: Date.now(),
                n: checklistName,
                c: category, // 선택한 카테고리 사용
                sc: groupCount, // 모둠 개수
                s: Array(groupCount).fill(0),
                ct: now,
                ut: now,
                t: Array(groupCount).fill(null),
                isDeadline: false,
                isGroupChecklist: true // 모둠 체크리스트 표시
            };

            checklists.unshift(checklist);
            
            try {
                showSyncStatus('syncing', '저장 중...');
                await saveChecklistToSupabase(checklist);
                showSyncStatus('success', '저장됨');
                setTimeout(() => hideSyncStatus(), 1000);
                
                renderChecklistList();
                selectChecklist(checklist.id);
                updateCategoryCheckboxes();
                closeGroupChecklistModal();
                
            } catch (error) {
                console.error('모둠 체크리스트 생성 실패:', error);
                showSyncStatus('error', '저장 실패');
                setTimeout(() => hideSyncStatus(), 3000);
                checklists.shift();
                renderChecklistList();
            }
        }

        async function googleLogin() {
            if (!supabase) {
                supabase = window.supabase.createClient(SUPABASE_CONFIG.URL, SUPABASE_CONFIG.ANON_KEY);
            }
            
            try {
                console.log('🔍 구글 로그인 시작');
                const { data, error } = await supabase.auth.signInWithOAuth({
                    provider: 'google',
                    options: {
                        redirectTo: 'https://euphonious-pixie-336fea.netlify.app/',
                        queryParams: {
                            access_type: 'offline',
                            prompt: 'consent',
                        }
                    }
                });
                
                if (error) {
                    console.error('구글 로그인 오류:', error);
                    alert('구글 로그인 실패: ' + error.message);
                } else {
                    console.log('✅ 구글 로그인 요청 성공:', data);
                }
            } catch (error) {
                console.error('구글 로그인 예외:', error);
                alert('구글 로그인 중 오류가 발생했습니다.');
            }
        }

        // 페이지 로드 시(또는 로그인 후) 세션 및 사용자 정보 확인
        async function handleGoogleLoginResult() {
            // 로컬스토리지에 이미 교사 ID가 있으면 구글 로그인 처리하지 않음
            const savedTeacherId = localStorage.getItem(STORAGE_KEYS.TEACHER_ID);
            if (savedTeacherId && savedTeacherId.trim() !== '') {
                console.log('로컬 교사 ID가 있으므로 구글 로그인 무시:', savedTeacherId);
                return;
            }
            if (!supabase) {
                supabase = window.supabase.createClient(SUPABASE_CONFIG.URL, SUPABASE_CONFIG.ANON_KEY);
            }
            const { data: { session }, error } = await supabase.auth.getSession();
            if (error) {
                console.error('세션 정보 가져오기 오류:', error);
                return;
            }
            if (session && session.user) {
                // 사용자 정보 활용 예시
                const user = session.user;
                console.log('구글 로그인 성공! 사용자 정보:', user);

                // 예시: 이메일을 teacherId로 사용
                teacherId = user.email;
                localStorage.setItem(STORAGE_KEYS.TEACHER_ID, teacherId);

                // UI 업데이트 및 데이터 로드
                document.getElementById('configModal').style.display = 'none';
                document.getElementById('noConnection').classList.add('hidden');
                document.getElementById('mainContent').classList.remove('hidden');
                document.getElementById('teacherInfo').textContent = `👨‍🏫 ${user.email}`;

                // 체크리스트 및 학생 데이터 로드
                await loadChecklists();
                await loadStudents();
            }
        }

        function cleanUpOAuthParams() {
            if (window.location.search.includes('code=') || window.location.search.includes('access_token=')) {
                // 현재 URL에서 쿼리스트링 제거
                window.history.replaceState({}, document.title, window.location.pathname);
            }
        }
    </script>
</body>
</html>