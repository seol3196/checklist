<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì²´í¬ë¦¬ìŠ¤íŠ¸ ì•±</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        dark: {
                            bg: '#1a1a1a',
                            card: '#2d2d2d',
                            text: '#e5e5e5',
                            border: '#404040'
                        }
                    }
                }
            }
        }
    </script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script>
        // Supabase ìŠ¤í¬ë¦½íŠ¸ ë¡œë“œ í™•ì¸
        window.addEventListener('load', () => {
            console.log('ğŸ” Supabase ìŠ¤í¬ë¦½íŠ¸ ë¡œë“œ ìƒíƒœ:', !!window.supabase);
        });
    </script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard@v1.3.9/dist/web/variable/pretendardvariable.min.css">
    <style>
        body {
            font-family: 'Pretendard Variable', -apple-system, BlinkMacSystemFont, system-ui, Roboto, 'Helvetica Neue', 'Segoe UI', 'Apple SD Gothic Neo', 'Noto Sans KR', 'Malgun Gothic', 'Apple Color Emoji', 'Segoe UI Emoji', 'Segoe UI Symbol', sans-serif;
            transition: background-color 0.3s, color 0.3s;
        }
        .student-card {
            min-width: 80px;
            transition: all 0.2s ease;
            border: 2px solid transparent;
            position: relative;
        }
        .student-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            border-color: rgba(59, 130, 246, 0.3);
        }
        .student-number {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            font-weight: bold;
            font-size: 0.9rem;
            padding: 8px 12px;
            border-radius: 8px 8px 0 0;
            text-align: center;
            min-height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            text-shadow: 0 1px 2px rgba(0,0,0,0.2);
        }
        .dark .student-number {
            background: linear-gradient(135deg, #8B5CF6 0%, #06B6D4 100%);
        }
        .status-btn {
            min-height: 80px;
            transition: all 0.2s ease;
            font-weight: 600;
            font-size: 0.9rem;
            border-radius: 0 0 8px 8px;
            border: none;
            cursor: pointer;
            position: relative;
            overflow: hidden;
        }
        .status-btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
            transition: left 0.5s;
        }
        .status-btn:hover::before {
            left: 100%;
        }
        .status-btn:active {
            transform: scale(0.98);
        }
        .icon-btn {
            @apply p-2 rounded hover:bg-gray-100 dark:hover:bg-gray-600 transition-colors;
        }
        .main-title {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            text-shadow: 0 2px 4px rgba(0,0,0,0.1);
            position: relative;
        }
        .dark .main-title {
            background: linear-gradient(135deg, #8B5CF6 0%, #06B6D4 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        .title-badge {
            background: linear-gradient(135deg, #667eea20, #764ba240);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255,255,255,0.2);
        }
        .dark .title-badge {
            background: linear-gradient(135deg, #8B5CF620, #06B6D440);
            border: 1px solid rgba(255,255,255,0.1);
        }
        .sync-status {
            @apply text-xs px-2 py-1 rounded-full;
        }
        .sync-success { @apply bg-green-100 text-green-800 dark:bg-green-900 dark:text-green-300; }
        .sync-error { @apply bg-red-100 text-red-800 dark:bg-red-900 dark:text-red-300; }
        .sync-syncing { @apply bg-blue-100 text-blue-800 dark:bg-blue-900 dark:text-blue-300; }
        .loading {
            @apply opacity-50 pointer-events-none;
        }
        .ranking-badge {
            position: absolute;
            top: -8px;
            right: -8px;
            background: linear-gradient(135deg, #fbbf24, #f59e0b);
            color: white;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.7rem;
            font-weight: bold;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }
        .student-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
            gap: 16px;
            padding: 8px;
        }
        @media (max-width: 640px) {
            .student-grid {
                grid-template-columns: repeat(auto-fill, minmax(80px, 1fr));
                gap: 8px;
            }
        }
        /* ì „ì²´í™”ë©´ ëª¨ë“œ ìŠ¤íƒ€ì¼ */
        .fullscreen-mode .student-card {
            min-width: 110px; /* 100pxì—ì„œ 110pxë¡œ ì¦ê°€ */
        }
        .fullscreen-mode .student-number {
            font-size: 1.32rem; /* 1.2remì—ì„œ 1.32remìœ¼ë¡œ ì¦ê°€ */
            padding: 14px 18px; /* 12px 16pxì—ì„œ ì¦ê°€ */
            min-height: 55px; /* 50pxì—ì„œ 55pxë¡œ ì¦ê°€ */
        }
        .fullscreen-mode .status-btn {
            min-height: 110px; /* 100pxì—ì„œ 110pxë¡œ ì¦ê°€ */
            font-size: 1.32rem; /* 1.2remì—ì„œ 1.32remìœ¼ë¡œ ì¦ê°€ */
            font-weight: 700;
        }
        .fullscreen-mode .ranking-badge {
            width: 33px; /* 30pxì—ì„œ 33pxë¡œ ì¦ê°€ */
            height: 33px; /* 30pxì—ì„œ 33pxë¡œ ì¦ê°€ */
            font-size: 1rem; /* 0.9remì—ì„œ 1remìœ¼ë¡œ ì¦ê°€ */
            top: -11px;
            right: -11px;
        }
        .fullscreen-mode .student-grid {
            grid-template-columns: repeat(auto-fill, minmax(145px, 1fr)); /* 130pxì—ì„œ 145pxë¡œ ì¦ê°€ */
            gap: 22px; /* 20pxì—ì„œ 22pxë¡œ ì¦ê°€ */
            padding: 18px; /* 16pxì—ì„œ 18pxë¡œ ì¦ê°€ */
        }
        .fullscreen-mode .icon-btn {
            font-size: 1.55rem; /* 1.4remì—ì„œ 1.55remìœ¼ë¡œ ì¦ê°€ */
            padding: 12px; /* 10pxì—ì„œ 12pxë¡œ ì¦ê°€ */
        }
        .fullscreen-mode #checklistTitle {
            font-size: 2rem; /* 1.8remì—ì„œ 2remìœ¼ë¡œ ì¦ê°€ */
        }
        .fullscreen-mode #editCategorySelect {
            font-size: 1.32rem; /* 1.2remì—ì„œ 1.32remìœ¼ë¡œ ì¦ê°€ */
            padding: 9px 14px; /* 8px 12pxì—ì„œ ì¦ê°€ */
        }
        /* í†µê³„ ì„¹ì…˜ë„ í¬ê²Œ */
        .fullscreen-mode #statistics h3 {
            font-size: 1.32rem;
        }
        .fullscreen-mode #statistics .text-sm {
            font-size: 1.1rem;
        }
    </style>
</head>
<body class="bg-gray-100 dark:bg-gray-900 min-h-screen">
    <!-- êµì‚¬ ë¡œê·¸ì¸ ëª¨ë‹¬ -->
    <div id="configModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50" style="display: none;">
        <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-xl max-w-md w-full mx-4">
            <h2 class="text-xl font-bold mb-4 dark:text-white">êµì‚¬ ë¡œê·¸ì¸</h2>
            <div class="text-sm text-gray-600 dark:text-gray-400 mb-4">
                <p>ë“±ë¡ëœ êµì‚¬ ì•„ì´ë””ë¡œ ë¡œê·¸ì¸í•˜ì„¸ìš”.</p>
                <p class="mt-2 text-xs">âš ï¸ êµì‚¬ ë¡œê·¸ì¸ ì—†ì´ëŠ” ì‚¬ìš©í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</p>
            </div>
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium mb-2 dark:text-white">êµì‚¬ ì•„ì´ë””</label>
                    <input type="text" id="teacherIdInput" 
                           placeholder="êµì‚¬ ì•„ì´ë””ë¥¼ ì…ë ¥í•˜ì„¸ìš”" 
                           class="w-full p-2 border rounded dark:bg-gray-700 dark:border-gray-600 dark:text-white"
                           onkeypress="if(event.key==='Enter') teacherLogin()">
                </div>
                <div class="flex gap-2">
                    <button onclick="teacherLogin()" 
                            class="flex-1 bg-blue-500 text-white p-2 rounded hover:bg-blue-600 transition-colors">
                        ë¡œê·¸ì¸
                    </button>
                    <button onclick="resetUserId()" 
                            class="px-4 bg-gray-500 text-white p-2 rounded hover:bg-gray-600 transition-colors text-sm">
                        ID ì´ˆê¸°í™”
                    </button>
                </div>
                <!-- êµì‚¬ ë¡œê·¸ì¸ ëª¨ë‹¬ ë‚´ì— ì¶”ê°€ -->
                <button onclick="googleLogin()" 
                        class="flex-1 bg-red-500 text-white p-2 rounded hover:bg-red-600 transition-colors mt-2">
                    <img src="https://www.svgrepo.com/show/475656/google-color.svg" style="width:20px;display:inline;margin-right:8px;vertical-align:middle;">
                    êµ¬ê¸€ë¡œ ë¡œê·¸ì¸
                </button>
            </div>
        </div>
    </div>
    
    <!-- í•™ìƒ ì—…ë¡œë“œ ëª¨ë‹¬ -->
    <div id="studentUploadModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-xl max-w-md w-full mx-4">
            <h2 class="text-xl font-bold mb-4 dark:text-white">ğŸ“‚ í•™ìƒ ì •ë³´ ê´€ë¦¬</h2>
            
            <div class="space-y-4">
                <!-- ë‹¨ê³„ 1: CSV ì–‘ì‹ ë‹¤ìš´ë¡œë“œ -->
                <div class="p-3 bg-blue-50 dark:bg-blue-900 rounded-lg">
                    <h3 class="text-sm font-semibold text-blue-800 dark:text-blue-200 mb-2">1ï¸âƒ£ CSV ì–‘ì‹ ë‹¤ìš´ë¡œë“œ</h3>
                    <button onclick="downloadCSVTemplate()" 
                            class="w-full bg-blue-500 text-white p-2 rounded hover:bg-blue-600 transition-colors text-sm">
                        ğŸ“¥ CSV ì–‘ì‹ ë‹¤ìš´ë¡œë“œ
                    </button>
                    <p class="text-xs text-blue-600 dark:text-blue-300 mt-1">í•™ìƒë²ˆí˜¸, í•™ìƒì´ë¦„ ìˆœìœ¼ë¡œ ì…ë ¥í•˜ì„¸ìš”</p>
                </div>

                <!-- ë‹¨ê³„ 2: CSV íŒŒì¼ ì—…ë¡œë“œ -->
                <div class="p-3 bg-green-50 dark:bg-green-900 rounded-lg">
                    <h3 class="text-sm font-semibold text-green-800 dark:text-green-200 mb-2">2ï¸âƒ£ í•™ìƒ ì •ë³´ ì—…ë¡œë“œ</h3>
                    <input type="file" id="csvFileInput" accept=".csv" 
                           class="w-full p-2 border rounded dark:bg-gray-700 dark:border-gray-600 dark:text-white text-sm">
                    <button onclick="uploadStudentCSV()" 
                            class="w-full bg-green-500 text-white p-2 rounded hover:bg-green-600 transition-colors text-sm mt-2">
                        ğŸ“¤ ì—…ë¡œë“œ
                    </button>
                </div>

                <!-- ì—…ë¡œë“œëœ í•™ìƒ ì •ë³´ ë¯¸ë¦¬ë³´ê¸° -->
                <div id="studentPreview" class="hidden p-3 bg-gray-50 dark:bg-gray-700 rounded-lg">
                    <h3 class="text-sm font-semibold dark:text-gray-100 mb-2">ğŸ‘¥ ì—…ë¡œë“œëœ í•™ìƒ ì •ë³´</h3>
                    <div id="studentPreviewList" class="text-xs max-h-32 overflow-y-auto"></div>
                    <button onclick="saveStudentData()" 
                            class="w-full bg-purple-500 text-white p-2 rounded hover:bg-purple-600 transition-colors text-sm mt-2">
                        ğŸ’¾ ì €ì¥
                    </button>
                </div>
            </div>

            <div class="flex gap-2 mt-4">
                <button onclick="closeStudentUploadModal()" 
                        class="flex-1 bg-gray-500 text-white p-2 rounded hover:bg-gray-600 transition-colors">
                    ì·¨ì†Œ
                </button>
            </div>
        </div>
    </div>

    <!-- ëª¨ë‘  ì²´í¬ë¦¬ìŠ¤íŠ¸ ëª¨ë‹¬ -->
    <div id="groupChecklistModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-xl max-w-md w-full mx-4">
            <h2 class="text-xl font-bold mb-4 dark:text-white">ğŸ‘¨â€ğŸ‘©â€ğŸ‘§â€ğŸ‘¦ ëª¨ë‘  ì²´í¬ë¦¬ìŠ¤íŠ¸ ìƒì„±</h2>
            
            <div class="space-y-4">
                <div class="p-3 bg-purple-50 dark:bg-purple-900 rounded-lg">
                    <h3 class="text-sm font-semibold text-purple-800 dark:text-purple-200 mb-2">ëª¨ë‘  ì •ë³´ ì…ë ¥</h3>
                    <div class="mb-3">
                        <label class="block text-sm font-medium mb-1 dark:text-gray-300">ëª¨ë‘  ê°œìˆ˜</label>
                        <input type="number" id="groupCountInput" min="1" max="20" value="6" 
                            class="w-full p-2 border rounded dark:bg-gray-700 dark:border-gray-600 dark:text-white">
                    </div>
                    <div class="mb-3">
                        <label class="block text-sm font-medium mb-1 dark:text-gray-300">ì¹´í…Œê³ ë¦¬ ì„ íƒ</label>
                        <select id="groupCategorySelect" class="w-full p-2 border rounded dark:bg-gray-700 dark:border-gray-600 dark:text-gray-100">
                            <option value="ì¼ë°˜">ğŸ—’ï¸ ì¼ë°˜</option>
                            <option value="êµ­ì–´">ğŸ“’ êµ­ì–´</option>
                            <option value="ìˆ˜í•™">ğŸ§® ìˆ˜í•™</option>
                            <option value="ì‚¬íšŒ">ğŸ‘¥ ì‚¬íšŒ</option>
                            <option value="ê³¼í•™">ğŸ”¬ ê³¼í•™</option>
                            <option value="ì˜ì–´">ğŸ‡ºğŸ‡¸ ì˜ì–´</option>
                            <option value="ë„ë•">ğŸ¤ ë„ë•</option>
                            <option value="ì‹¤ê³¼">ğŸ§¶ ì‹¤ê³¼</option>
                            <option value="ìŒì•…">ğŸµ ìŒì•…</option>
                            <option value="ë¯¸ìˆ ">ğŸ¨ ë¯¸ìˆ </option>
                            <option value="ì²´ìœ¡">ğŸƒ ì²´ìœ¡</option>
                            <option value="ì°½ì²´">ğŸ‘¥ ì°½ì²´</option>
                            <option value="ì•„ì¹¨í™œë™">ğŸŒ ì•„ì¹¨í™œë™</option>
                            <option value="ë…ì„œ">ğŸ¤“ ë…ì„œ</option>
                            <option value="ê¸°íƒ€">ğŸ¤” ê¸°íƒ€</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium mb-1 dark:text-gray-300">ì²´í¬ë¦¬ìŠ¤íŠ¸ ì´ë¦„</label>
                        <input type="text" id="groupChecklistName" placeholder="ëª¨ë‘  í™œë™ ì²´í¬ë¦¬ìŠ¤íŠ¸" 
                            class="w-full p-2 border rounded dark:bg-gray-700 dark:border-gray-600 dark:text-white">
                    </div>
                </div>
            </div>

            <div class="flex gap-2 mt-4">
                <button onclick="closeGroupChecklistModal()" 
                        class="flex-1 bg-gray-500 text-white p-2 rounded hover:bg-gray-600 transition-colors">
                    ì·¨ì†Œ
                </button>
                <button onclick="createGroupChecklist()" 
                        class="flex-1 bg-purple-500 text-white p-2 rounded hover:bg-purple-600 transition-colors">
                    í™•ì¸
                </button>
            </div>
        </div>
    </div>

    <div class="container mx-auto p-4">
        <div class="flex justify-end mb-4">
            <div class="flex items-center gap-4">
                <div id="syncStatus" class="sync-status hidden">ë™ê¸°í™” ì¤‘...</div>
                <div id="teacherInfo" class="text-sm text-gray-600 dark:text-gray-400"></div>
                <span class="clock text-gray-900 dark:text-white" id="clock"></span>
                <button class="flex items-center gap-2 px-3 py-2 rounded border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-800 hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors text-gray-900 dark:text-white" 
                        onclick="toggleDarkMode()">
                    <span id="darkModeIcon">ğŸŒ™</span>
                    <span>ë‹¤í¬ëª¨ë“œ</span>
                </button>
                <button onclick="showConfig()" 
                        class="flex items-center gap-2 px-3 py-2 rounded border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-800 hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors text-gray-900 dark:text-white">
                    ğŸ‘¨â€ğŸ« êµì‚¬ ë³€ê²½/ë¡œê·¸ì•„ì›ƒ
                </button>
            </div>
        </div>
        
        <div id="mainContainer" class="flex gap-4">
            <!-- ì¢Œì¸¡ ì²´í¬ë¦¬ìŠ¤íŠ¸ ëª©ë¡ -->
            <div id="leftContainer" class="w-1/4 bg-white dark:bg-gray-800 rounded-lg shadow p-4">
                <h2 class="text-xl font-bold mb-4 dark:text-gray-100">Checklist</h2>
                
                <!-- í•™ìƒ ê´€ë¦¬ ì„¹ì…˜ -->
                <div class="mb-4 p-3 bg-gray-50 dark:bg-gray-700 rounded-lg">
                    <h3 class="font-semibold dark:text-gray-100 mb-2">ğŸ‘¥ í•™ìƒ ê´€ë¦¬</h3>
                    <div id="studentManagement">
                        <div id="noStudents" class="text-center py-4">
                            <p class="text-sm text-gray-500 dark:text-gray-400 mb-3">í•™ìƒ ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤.</p>
                            <button onclick="showStudentUploadModal()" 
                                    class="w-full bg-green-500 text-white p-2 rounded hover:bg-green-600 transition-colors text-sm">
                                ğŸ“‚ í•™ìƒ ì¶”ê°€
                            </button>
                        </div>
                        <div id="hasStudents" class="hidden">
                            <div class="flex items-center justify-between mb-2">
                                <span class="text-sm dark:text-gray-100">ë“±ë¡ëœ í•™ìƒ: <span id="studentCountDisplay">0</span>ëª…</span>
                                <button onclick="showStudentUploadModal()" 
                                        class="text-xs px-2 py-1 bg-gray-500 text-white rounded hover:bg-gray-600 transition-colors">
                                    ìˆ˜ì •
                                </button>
                            </div>
                            <div id="studentList" class="text-xs text-gray-600 dark:text-gray-400 max-h-20 overflow-y-auto"></div>
                        </div>
                    </div>
                </div>

                <!-- ì²´í¬ë¦¬ìŠ¤íŠ¸ ìƒì„± ì„¹ì…˜ -->
                <div class="mb-4">
                    <h3 class="font-semibold dark:text-gray-100 mb-2">ğŸ“‹ ì²´í¬ë¦¬ìŠ¤íŠ¸ ìƒì„±</h3>
                    <select id="categorySelect" class="w-full p-2 border rounded-full mb-2 bg-white dark:bg-gray-700 dark:border-gray-600 dark:text-gray-100">
                        <option value="ì¼ë°˜">ğŸ—’ï¸ ì¼ë°˜</option>
                        <option value="êµ­ì–´">ğŸ“’ êµ­ì–´</option>
                        <option value="ìˆ˜í•™">ğŸ§® ìˆ˜í•™</option>
                        <option value="ì‚¬íšŒ">ğŸ‘¥ ì‚¬íšŒ</option>
                        <option value="ê³¼í•™">ğŸ”¬ ê³¼í•™</option>
                        <option value="ì˜ì–´">ğŸ‡ºğŸ‡¸ ì˜ì–´</option>
                        <option value="ë„ë•">ğŸ¤ ë„ë•</option>
                        <option value="ì‹¤ê³¼">ğŸ§¶ ì‹¤ê³¼</option>
                        <option value="ìŒì•…">ğŸµ ìŒì•…</option>
                        <option value="ë¯¸ìˆ ">ğŸ¨ ë¯¸ìˆ </option>
                        <option value="ì²´ìœ¡">ğŸƒ ì²´ìœ¡</option>
                        <option value="ì°½ì²´">ğŸ‘¥ ì°½ì²´</option>
                        <option value="ì•„ì¹¨í™œë™">ğŸŒ ì•„ì¹¨í™œë™</option>
                        <option value="ë…ì„œ">ğŸ¤“ ë…ì„œ</option>
                        <option value="ê¸°íƒ€">ğŸ¤” ê¸°íƒ€</option>
                    </select>
                    <button id="createChecklist" 
                            class="w-full bg-blue-500 text-white p-2 rounded hover:bg-blue-600 flex items-center justify-center gap-2 transition-colors disabled:bg-gray-400 disabled:cursor-not-allowed mb-2"
                            onclick="createChecklist()" disabled>
                        â• ì²´í¬ë¦¬ìŠ¤íŠ¸ ì¶”ê°€
                    </button>
                    <button id="createGroupChecklist" 
                            class="w-full bg-purple-500 text-white p-2 rounded hover:bg-purple-600 flex items-center justify-center gap-2 transition-colors disabled:bg-gray-400 disabled:cursor-not-allowed"
                            onclick="showGroupChecklistModal()" disabled>
                        ğŸ‘¨â€ğŸ‘©â€ğŸ‘§â€ğŸ‘¦ ëª¨ë‘  ì²´í¬ë¦¬ìŠ¤íŠ¸ ì¶”ê°€
                    </button>
                    <p class="text-xs text-gray-500 dark:text-gray-400 mt-1 text-center">í•™ìƒ ì •ë³´ë¥¼ ë¨¼ì € ë“±ë¡í•´ì£¼ì„¸ìš”</p>
                </div>
                <div class="mb-4">
                    <div class="flex items-center justify-between mb-2">
                        <h3 class="font-semibold dark:text-gray-100">ëª©ë¡</h3>
                        <button onclick="toggleCategoryFilter()" class="icon-btn dark:text-white">
                            ğŸ”
                        </button>
                    </div>
                    <div id="categoryFilter" class="hidden space-y-1">
                        <label class="flex items-center dark:text-white">
                            <input type="checkbox" value="all" checked class="mr-2" onchange="filterChecklists()">
                            ì „ì²´
                        </label>
                        <div id="categoryCheckboxes" class="space-y-1 dark:text-white"></div>
                    </div>
                </div>
                <div id="checklistList" class="space-y-2"></div>
                <div class="text-center text-xs text-gray-400 dark:text-gray-500 mt-4">
                    <div id="storageInfo" class="mt-1">â˜ï¸ Supabase</div>
                </div>
            </div>

            <!-- ìš°ì¸¡ ì²´í¬ë¦¬ìŠ¤íŠ¸ ë‚´ìš© -->
            <div id="rightContainer" class="w-3/4 bg-white dark:bg-gray-800 rounded-lg shadow p-4">
                <div id="noConnection" class="text-center py-8 text-gray-500 dark:text-gray-400">
                    <div class="text-4xl mb-4">ğŸ‘¨â€ğŸ«</div>
                    <div class="text-lg font-semibold mb-2">êµì‚¬ ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤</div>
                    <div class="text-sm">êµì‚¬ ë³€ê²½ ë²„íŠ¼ì„ í´ë¦­í•˜ì—¬ ë¡œê·¸ì¸í•˜ì„¸ìš”.</div>
                </div>
                
                <div id="mainContent" class="hidden">
                    <div class="flex justify-between items-center mb-4">
                        <div class="flex-1">
                            <div class="flex items-center gap-2">
                                <select id="editCategorySelect" 
                                        class="p-2 border rounded-full bg-white dark:bg-gray-700 dark:border-gray-600 dark:text-gray-100" 
                                        onchange="updateCurrentChecklist()">
                                    <option value="ì¼ë°˜">ğŸ—’ï¸ ì¼ë°˜</option>
                                    <option value="êµ­ì–´">ğŸ“’ êµ­ì–´</option>
                                    <option value="ìˆ˜í•™">ğŸ§® ìˆ˜í•™</option>
                                    <option value="ì‚¬íšŒ">ğŸ‘¥ ì‚¬íšŒ</option>
                                    <option value="ê³¼í•™">ğŸ”¬ ê³¼í•™</option>
                                    <option value="ì˜ì–´">ğŸ‡ºğŸ‡¸ ì˜ì–´</option>
                                    <option value="ë„ë•">ğŸ¤ ë„ë•</option>
                                    <option value="ì‹¤ê³¼">ğŸ§¶ ì‹¤ê³¼</option>
                                    <option value="ìŒì•…">ğŸµ ìŒì•…</option>
                                    <option value="ë¯¸ìˆ ">ğŸ¨ ë¯¸ìˆ </option>
                                    <option value="ì²´ìœ¡">ğŸƒ ì²´ìœ¡</option>
                                    <option value="ì°½ì²´">ğŸ‘¥ ì°½ì²´</option>
                                    <option value="ì•„ì¹¨í™œë™">ğŸŒ ì•„ì¹¨í™œë™</option>
                                    <option value="ë…ì„œ">ğŸ¤“ ë…ì„œ</option>
                                    <option value="ê¸°íƒ€">ğŸ¤” ê¸°íƒ€</option>
                                </select>
                                <input type="text" id="checklistTitle" 
                                       class="flex-1 text-xl font-bold bg-transparent border-b border-transparent hover:border-gray-300 focus:border-blue-500 focus:outline-none px-1 dark:text-gray-100 dark:border-gray-600" 
                                       onchange="updateCurrentChecklist()">
                            </div>
                            <div id="checklistInfo" class="text-sm text-gray-400 dark:text-gray-500 mt-1"></div>
                        </div>
                        <div class="flex">
                            <button id="fullscreenBtn" onclick="toggleFullscreen()" 
                                    class="icon-btn mr-2 text-blue-500 hover:bg-blue-100 dark:hover:bg-blue-900" title="ì „ì²´í™”ë©´">
                                ğŸ”
                            </button>
                            <div id="checklistActions" class="hidden">
                                <button onclick="deleteCurrentChecklist()" 
                                        class="icon-btn text-red-500 hover:bg-red-100 dark:hover:bg-red-900">
                                    ğŸ—‘ï¸
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <div id="checklistContent" class="student-grid mb-6"></div>
                    
                    <!-- í†µê³„ ì„¹ì…˜ -->
                    <div id="statistics" class="border-t border-gray-200 dark:border-gray-600 pt-4 hidden">
                        <h3 class="text-lg font-semibold mb-3 dark:text-gray-100">ìƒíƒœë³„ í†µê³„</h3>
                        <div class="grid grid-cols-5 gap-4 mb-4">
                            <div class="text-center">
                                <div class="bg-green-500 text-white p-2 rounded mb-1">ì™„ë£Œ</div>
                                <div class="text-sm dark:text-gray-100">
                                    <span id="completedCount">0</span><span id="unitText">ëª…</span>
                                    (<span id="completedPercent">0.0</span>%)
                                </div>
                            </div>
                            <div class="text-center">
                                <div class="bg-yellow-500 text-white p-2 rounded mb-1">ì§„í–‰ì¤‘</div>
                                <div class="text-sm dark:text-gray-100">
                                    <span id="inProgressCount">0</span><span id="unitText2">ëª…</span>
                                    (<span id="inProgressPercent">0.0</span>%)
                                </div>
                            </div>
                            <div class="text-center">
                                <div class="bg-orange-500 text-white p-2 rounded mb-1">ì¬ì œì¶œ</div>
                                <div class="text-sm dark:text-gray-100">
                                    <span id="resubmitCount">0</span><span id="unitText3">ëª…</span>
                                    (<span id="resubmitPercent">0.0</span>%)
                                </div>
                            </div>
                            <div class="text-center">
                                <div class="bg-gray-500 text-white p-2 rounded mb-1">ë¯¸ì™„ë£Œ</div>
                                <div class="text-sm dark:text-gray-100">
                                    <span id="incompleteCount">0</span><span id="unitText4">ëª…</span>
                                    (<span id="incompletePercent">0.0</span>%)
                                </div>
                            </div>
                            <div class="text-center">
                                <div class="bg-red-500 text-white p-2 rounded mb-1">ë¯¸ì œì¶œë§ˆê°</div>
                                <div class="text-sm dark:text-gray-100">
                                    <span id="deadlineCount">0</span><span id="unitText5">ëª…</span>
                                    (<span id="deadlinePercent">0.0</span>%)
                                </div>
                            </div>
                        </div>
                        <!-- í”„ë¡œê·¸ë ˆìŠ¤ ë°” -->
                        <div class="mt-4">
                            <div class="flex h-6 rounded-full overflow-hidden">
                                <div id="completedBar" class="bg-green-500 transition-all duration-500" style="width: 0%"></div>
                                <div id="inProgressBar" class="bg-yellow-500 transition-all duration-500" style="width: 0%"></div>
                                <div id="resubmitBar" class="bg-orange-500 transition-all duration-500" style="width: 0%"></div>
                                <div id="incompleteBar" class="bg-gray-500 transition-all duration-500" style="width: 100%"></div>
                                <div id="deadlineBar" class="bg-red-500 transition-all duration-500" style="width: 0%"></div>
                            </div>
                            <div class="flex justify-between mt-2 text-xs text-gray-500 dark:text-gray-400">
                                <span>0%</span>
                                <span>100%</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ìƒíƒœ ìƒìˆ˜ ì •ì˜
        const STATUS = {
            INCOMPLETE: { id: 0, color: 'bg-gray-500', text: 'ë¯¸ì™„ë£Œ' },
            COMPLETED: { id: 1, color: 'bg-green-500', text: 'ì™„ë£Œ' },
            IN_PROGRESS: { id: 2, color: 'bg-yellow-500', text: 'ì§„í–‰ì¤‘' },
            RESUBMIT: { id: 3, color: 'bg-orange-500', text: 'ì¬ì œì¶œ' },
            DEADLINE_PASSED: { id: 4, color: 'bg-red-500', text: 'ë¯¸ì œì¶œë§ˆê°' }
        };

        // ì „ì²´í™”ë©´ ê´€ë ¨ ë³€ìˆ˜
        let isFullscreen = false;
        let originalLayout = {};

        // ì „ì²´í™”ë©´ í† ê¸€ í•¨ìˆ˜
        function toggleFullscreen() {
            const checklistContainer = document.getElementById('rightContainer');
            const leftContainer = document.getElementById('leftContainer');
            const mainContainer = document.getElementById('mainContainer');
            const fullscreenBtn = document.getElementById('fullscreenBtn');
            
            // ìš”ì†Œê°€ ì¡´ì¬í•˜ëŠ”ì§€ í™•ì¸
            if (!checklistContainer || !leftContainer || !mainContainer || !fullscreenBtn) {
                console.error("ì „ì²´í™”ë©´ ì „í™˜ì— í•„ìš”í•œ ìš”ì†Œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
                return; // í•„ìš”í•œ ìš”ì†Œê°€ ì—†ìœ¼ë©´ í•¨ìˆ˜ ì‹¤í–‰ ì¤‘ë‹¨
            }
            
            if (!isFullscreen) {
                // ì›ë˜ ë ˆì´ì•„ì›ƒ ì €ì¥
                originalLayout = {
                    checklistClassName: checklistContainer.className,
                    leftClassName: leftContainer.className,
                    mainClassName: mainContainer.className
                };
                
                // ì „ì²´í™”ë©´ ìŠ¤íƒ€ì¼ ì ìš©
                checklistContainer.className = 'w-full bg-white dark:bg-gray-800 rounded-lg shadow p-4';
                leftContainer.style.display = 'none';
                mainContainer.className = 'flex flex-col';
                fullscreenBtn.innerHTML = 'â¬…ï¸';
                fullscreenBtn.title = 'ì „ì²´í™”ë©´ í•´ì œ';
                
                // í°íŠ¸ ë° ë²„íŠ¼ í¬ê¸° í‚¤ìš°ê¸°
                checklistContainer.classList.add('fullscreen-mode');
                
                isFullscreen = true;
            } else {
                // ì›ë˜ ë ˆì´ì•„ì›ƒìœ¼ë¡œ ë³µì›
                checklistContainer.className = originalLayout.checklistClassName || 'w-3/4 bg-white dark:bg-gray-800 rounded-lg shadow p-4';
                leftContainer.className = originalLayout.leftClassName || 'w-1/4 bg-white dark:bg-gray-800 rounded-lg shadow p-4';
                leftContainer.style.display = '';
                mainContainer.className = originalLayout.mainClassName || 'flex gap-4';
                fullscreenBtn.innerHTML = 'ğŸ”';
                fullscreenBtn.title = 'ì „ì²´í™”ë©´';
                
                // í°íŠ¸ ë° ë²„íŠ¼ í¬ê¸° ì›ë³µ
                checklistContainer.classList.remove('fullscreen-mode');
                
                isFullscreen = false;
            }
            
            // í˜„ì¬ ì²´í¬ë¦¬ìŠ¤íŠ¸ ë‹¤ì‹œ ë Œë”ë§ (ë ˆì´ì•„ì›ƒ ë³€ê²½ í›„ UI ì—…ë°ì´íŠ¸)
            if (currentChecklistId) {
                const checklist = checklists.find(c => c.id === currentChecklistId);
                if (checklist) {
                    renderChecklistContent(checklist);
                    updateStatistics(checklist);
                }
            }
        }

        // ê³ ì •ëœ Supabase ì„¤ì •
        const SUPABASE_CONFIG = {
            URL: 'https://prujjupqzvxbrybzjump.supabase.co', // ì‹¤ì œ Supabase í”„ë¡œì íŠ¸ URL
            ANON_KEY: 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InBydWpqdXBxenZ4YnJ5YnpqdW1wIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDk3ODI1NDksImV4cCI6MjA2NTM1ODU0OX0.n9-c_IgKpvzy__YK5_b2cekOit_LW3AnK4cIz2iDOPU'
        };

        // ì „ì—­ ë³€ìˆ˜
        let supabase = null;
        let userId = null;
        let teacherId = null;
        let checklists = [];
        let currentChecklistId = null;
        let isDarkMode = localStorage.getItem('darkMode') === 'true';
        let students = [];
        let uploadedStudents = [];

        // ë¡œì»¬ ìŠ¤í† ë¦¬ì§€ í‚¤
        const STORAGE_KEYS = {
            TEACHER_ID: 'teacherId',
            LAST_VIEWED: 'lastViewedChecklist',
            DARK_MODE: 'darkMode',
            STUDENT_COUNT: 'studentCount'
        };

        // ìƒíƒœ IDë¥¼ í…ìŠ¤íŠ¸ë¡œ ë³€í™˜í•˜ëŠ” í•¨ìˆ˜
        function getStatusById(id) {
            return Object.values(STATUS).find(status => status.id === id);
        }

        // ì‚¬ìš©ì ID ìƒì„±
        // function generateUserId() {
        //     return 'default_user';
        // }

        // ë™ê¸°í™” ìƒíƒœ í‘œì‹œ
        function showSyncStatus(type, message) {
            const statusEl = document.getElementById('syncStatus');
            statusEl.className = `sync-status sync-${type}`;
            statusEl.textContent = message;
            statusEl.classList.remove('hidden');
        }

        function hideSyncStatus() {
            document.getElementById('syncStatus').classList.add('hidden');
        }

        // ì™„ì „ ë¡œê·¸ì•„ì›ƒ ë° ì´ˆê¸°í™”
        function resetUserId() {
            if (confirm('ë¡œê·¸ì•„ì›ƒ í•˜ì‹œê² ìŠµë‹ˆê¹Œ?\nì €ì¥ëœ ëª¨ë“  ì •ë³´ê°€ ì‚­ì œë©ë‹ˆë‹¤.')) {
                // êµ¬ê¸€ ë¡œê·¸ì•„ì›ƒ ì¶”ê°€
                if (supabase) {
                    supabase.auth.signOut();
                }
                // localStorage.removeItem(STORAGE_KEYS.USER_ID); // ì œê±°
                localStorage.removeItem(STORAGE_KEYS.TEACHER_ID);
                localStorage.removeItem(STORAGE_KEYS.LAST_VIEWED);
                // localStorage.removeItem(STORAGE_KEYS.STUDENT_COUNT); // ì´ì œ ì‚¬ìš©ë˜ì§€ ì•ŠìŒ
                // ì „ì—­ ë³€ìˆ˜ ì´ˆê¸°í™”
                teacherId = null;
                // userId = null; // ì œê±°
                checklists = [];
                currentChecklistId = null;
                students = [];
                uploadedStudents = [];
                alert('ë¡œê·¸ì•„ì›ƒë˜ì—ˆìŠµë‹ˆë‹¤. í˜ì´ì§€ë¥¼ ìƒˆë¡œê³ ì¹¨í•©ë‹ˆë‹¤.');
                location.reload();
            }
        }

        // êµì‚¬ ID ê²€ì¦
        async function validateTeacherId(inputTeacherId) {
            console.log('Validating teacher ID:', inputTeacherId);
            
            if (!supabase) {
                console.log('Supabase not initialized');
                return false;
            }
            
            try {
                const { data, error } = await supabase
                    .from('teachers')
                    .select('teacher_id, name')
                    .eq('teacher_id', inputTeacherId)
                    .single();
                
                console.log('Teacher validation result:', { data, error });
                
                if (error || !data) {
                    console.log('Teacher validation failed:', error);
                    return false;
                }
                
                console.log('Teacher validation success:', data);
                return data;
            } catch (error) {
                console.error('êµì‚¬ ID ê²€ì¦ ì‹¤íŒ¨:', error);
                return false;
            }
        }

        // êµì‚¬ ë¡œê·¸ì¸ (ë¡œì»¬ìŠ¤í† ë¦¬ì§€ ì €ì¥ ê°•í™”)
        async function teacherLogin() {
            console.log('ğŸ” teacherLogin ì‹œì‘');
            const inputTeacherId = document.getElementById('teacherIdInput').value.trim();
            console.log('ğŸ” ì…ë ¥ëœ êµì‚¬ ID:', inputTeacherId);

            if (!inputTeacherId) {
                console.log('âŒ êµì‚¬ ID ì…ë ¥ ì—†ìŒ');
                alert('êµì‚¬ ì•„ì´ë””ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                return;
            }

            try {
                showSyncStatus('syncing', 'ë¡œê·¸ì¸ ì¤‘...');
                
                // ê³ ì •ëœ Supabase ì„¤ì •ìœ¼ë¡œ í´ë¼ì´ì–¸íŠ¸ ìƒì„±
                if (!supabase) {
                    console.log('ğŸ” Supabase í´ë¼ì´ì–¸íŠ¸ ìƒì„±');
                    supabase = window.supabase.createClient(SUPABASE_CONFIG.URL, SUPABASE_CONFIG.ANON_KEY);
                }
                
                // êµì‚¬ ID ê²€ì¦
                console.log('ğŸ” êµì‚¬ ID ê²€ì¦ ì‹œë„');
                const teacherData = await validateTeacherId(inputTeacherId);
                console.log('ğŸ” êµì‚¬ ID ê²€ì¦ ê²°ê³¼:', teacherData);

                if (!teacherData) {
                    console.log('âŒ êµì‚¬ ID ê²€ì¦ ì‹¤íŒ¨');
                    throw new Error('ë“±ë¡ë˜ì§€ ì•Šì€ êµì‚¬ ì•„ì´ë””ì…ë‹ˆë‹¤. ê´€ë¦¬ìì—ê²Œ ë¬¸ì˜í•˜ì„¸ìš”.');
                }

                // ğŸ”¥ ì¤‘ìš”: êµì‚¬ IDë¥¼ ë¡œì»¬ìŠ¤í† ë¦¬ì§€ì— í™•ì‹¤íˆ ì €ì¥
                console.log('ğŸ” ë¡œì»¬ìŠ¤í† ë¦¬ì§€ì— ì €ì¥ ì‹œë„');
                localStorage.setItem(STORAGE_KEYS.TEACHER_ID, inputTeacherId);
                teacherId = inputTeacherId;
                
                // userId ê´€ë ¨ ì½”ë“œ ëª¨ë‘ ì œê±°
                console.log('âœ… ë¡œì»¬ìŠ¤í† ë¦¬ì§€ ì €ì¥ ì™„ë£Œ:', {
                    teacherId: localStorage.getItem(STORAGE_KEYS.TEACHER_ID)
                });

                // UI ì—…ë°ì´íŠ¸
                document.getElementById('configModal').style.display = 'none';
                document.getElementById('noConnection').classList.add('hidden');
                document.getElementById('mainContent').classList.remove('hidden');
                
                // êµì‚¬ ì •ë³´ í‘œì‹œ
                document.getElementById('teacherInfo').textContent = `ğŸ‘¨â€ğŸ« ${teacherData.name || teacherData.teacher_id}`;
                
                // ë°ì´í„° ë¡œë“œ
                console.log('ğŸ” ì²´í¬ë¦¬ìŠ¤íŠ¸ ë¡œë“œ ì‹œë„');
                await loadChecklists();
                console.log('âœ… ì²´í¬ë¦¬ìŠ¤íŠ¸ ë¡œë“œ ì„±ê³µ');
                
                showSyncStatus('success', `${teacherData.name || teacherData.teacher_id}ë‹˜ í™˜ì˜í•©ë‹ˆë‹¤!`);
                setTimeout(() => hideSyncStatus(), 3000);
            } catch (error) {
                console.error('âŒ ë¡œê·¸ì¸ ì‹¤íŒ¨:', error);
                console.error('âŒ ì—ëŸ¬ ìƒì„¸:', {
                    message: error.message,
                    stack: error.stack,
                    code: error.code
                });
                alert('ë¡œê·¸ì¸ ì‹¤íŒ¨:\n\n' + error.message);
                showSyncStatus('error', 'ë¡œê·¸ì¸ ì‹¤íŒ¨');
                setTimeout(() => hideSyncStatus(), 3000);
            }
        }

        // ì„¤ì • ëª¨ë‹¬ í‘œì‹œ (ì €ì¥ëœ ID ìë™ ì…ë ¥)
        function showConfig() {
            const savedTeacherId = localStorage.getItem(STORAGE_KEYS.TEACHER_ID) || '';
            document.getElementById('teacherIdInput').value = savedTeacherId;
            document.getElementById('configModal').style.display = 'flex';
            
            // ì…ë ¥ í•„ë“œì— í¬ì»¤ìŠ¤
            setTimeout(() => {
                document.getElementById('teacherIdInput').focus();
                if (savedTeacherId) {
                    document.getElementById('teacherIdInput').select(); // ê¸°ì¡´ ID ì„ íƒ ìƒíƒœ
                }
            }, 100);
        }

        // Supabase ì´ˆê¸°í™” (ìë™ ë¡œê·¸ì¸ ê°œì„ )
        async function initSupabase() {
            try {
                console.log('ğŸ” initSupabase ì‹œì‘');
                console.log('ğŸ” í˜„ì¬ ì‹œê°„:', new Date().toISOString());
                console.log('ğŸ” window.location:', window.location.href);
                console.log('ğŸ” document.readyState:', document.readyState);
                console.log('ğŸ” window.supabase ìƒíƒœ:', !!window.supabase);
                console.log('ğŸ” SUPABASE_CONFIG ìƒíƒœ:', SUPABASE_CONFIG);
                console.log('ğŸ” localStorage ì „ì²´ ë‚´ìš©:', {
                    teacherId: localStorage.getItem(STORAGE_KEYS.TEACHER_ID),
                    lastViewed: localStorage.getItem(STORAGE_KEYS.LAST_VIEWED),
                    darkMode: localStorage.getItem(STORAGE_KEYS.DARK_MODE)
                });
                const savedTeacherId = localStorage.getItem(STORAGE_KEYS.TEACHER_ID);
                console.log('ğŸ” ì €ì¥ëœ êµì‚¬ ID:', savedTeacherId);
                console.log('ğŸ” ì €ì¥ëœ êµì‚¬ ID íƒ€ì…:', typeof savedTeacherId);
                console.log('ğŸ” ì €ì¥ëœ êµì‚¬ ID ê¸¸ì´:', savedTeacherId ? savedTeacherId.length : 0);
                // ê³ ì •ëœ Supabase ì„¤ì •ìœ¼ë¡œ í´ë¼ì´ì–¸íŠ¸ ìƒì„±
                supabase = window.supabase.createClient(SUPABASE_CONFIG.URL, SUPABASE_CONFIG.ANON_KEY);
                console.log('ğŸ” Supabase í´ë¼ì´ì–¸íŠ¸ ìƒì„±ë¨');
                if (savedTeacherId && savedTeacherId.trim() !== '') {
                    console.log('âœ… ìë™ ë¡œê·¸ì¸ ì‹œë„ - ì €ì¥ëœ êµì‚¬ ID ë°œê²¬');
                    // êµì‚¬ IDê°€ ì €ì¥ë˜ì–´ ìˆìœ¼ë©´ ë°”ë¡œ ë¡œê·¸ì¸ ì²˜ë¦¬
                    teacherId = savedTeacherId;
                    // userId ê´€ë ¨ ì½”ë“œ ëª¨ë‘ ì œê±°
                    console.log('ğŸ” ë¡œê·¸ì¸ ì •ë³´:', {
                        teacherId,
                        savedTeacherId
                    });
                    // UI ì¦‰ì‹œ ì—…ë°ì´íŠ¸
                    document.getElementById('configModal').style.display = 'none';
                    document.getElementById('noConnection').classList.add('hidden');
                    document.getElementById('mainContent').classList.remove('hidden');
                    // êµì‚¬ ì •ë³´ í‘œì‹œ
                    document.getElementById('teacherInfo').textContent = `ğŸ‘¨â€ğŸ« ${teacherId}`;
                    // ë°ì´í„° ë¡œë“œ ì‹œë„
                    try {
                        console.log('ğŸ” ì²´í¬ë¦¬ìŠ¤íŠ¸ ë¡œë“œ ì‹œë„');
                        showSyncStatus('syncing', 'ìë™ ë¡œê·¸ì¸ ì¤‘...');
                        await loadChecklists();
                        console.log('âœ… ì²´í¬ë¦¬ìŠ¤íŠ¸ ë¡œë“œ ì„±ê³µ');
                        // í•™ìƒ ë°ì´í„°ë„ ë¡œë“œ
                        console.log('ğŸ” í•™ìƒ ë°ì´í„° ë¡œë“œ ì‹œë„');
                        await loadStudents();
                        console.log('âœ… í•™ìƒ ë°ì´í„° ë¡œë“œ ì„±ê³µ');
                        showSyncStatus('success', `${teacherId}ë‹˜ í™˜ì˜í•©ë‹ˆë‹¤! (ìë™ ë¡œê·¸ì¸)`);
                        setTimeout(() => hideSyncStatus(), 3000);
                    } catch (error) {
                        console.error('âŒ ìë™ ë¡œê·¸ì¸ ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨:', error);
                        console.error('âŒ ì—ëŸ¬ ìƒì„¸:', {
                            message: error.message,
                            stack: error.stack,
                            code: error.code
                        });
                        showSyncStatus('error', 'ì¼ë¶€ ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨ (ë¡œê·¸ì¸ì€ ìœ ì§€ë¨)');
                        setTimeout(() => hideSyncStatus(), 3000);
                    }
                } else {
                    console.log('âŒ ìë™ ë¡œê·¸ì¸ ì‹¤íŒ¨ - ì €ì¥ëœ êµì‚¬ ID ì—†ìŒ');
                    console.log('ğŸ” ë¡œê·¸ì¸ ëª¨ë‹¬ í‘œì‹œ');
                    document.getElementById('configModal').style.display = 'flex';
                    document.getElementById('noConnection').classList.remove('hidden');
                    document.getElementById('mainContent').classList.add('hidden');
                }
            } catch (error) {
                console.error('âŒ initSupabase ì‹¤í–‰ ì¤‘ ì˜¤ë¥˜:', error);
                console.error('âŒ ì—ëŸ¬ ìƒì„¸:', {
                    message: error.message,
                    stack: error.stack,
                    code: error.code
                });
                throw error; // ìƒìœ„ í•¨ìˆ˜ì—ì„œ ì²˜ë¦¬í•  ìˆ˜ ìˆë„ë¡ ì—ëŸ¬ë¥¼ ë‹¤ì‹œ ë˜ì§
            }
        }

        // ì²´í¬ë¦¬ìŠ¤íŠ¸ ë¡œë“œ
        async function loadChecklists() {
            if (!supabase) {
                console.log('Supabase not initialized');
                return;
            }

            try {
                showSyncStatus('syncing', 'ë°ì´í„° ë¡œë“œ ì¤‘...');
                
                console.log('Loading checklists for teacher:', teacherId);
                
                const { data, error } = await supabase
                    .from('checklists')
                    .select('*')
                    .eq('teacher_id', teacherId)
                    .order('created_at', { ascending: false });

                console.log('Supabase response:', { data, error });

                if (error) {
                    console.error('Supabase load error:', error);
                    throw error;
                }

                if (!data) {
                    console.log('No data returned from Supabase');
                    checklists = [];
                } else {
                    console.log('Raw data from Supabase:', data);
                    
                    checklists = data.map(item => ({
                        id: item.id,
                        n: item.name,
                        c: item.category,
                        sc: item.student_count,
                        s: item.statuses,
                        ct: item.created_at,
                        ut: item.updated_at,
                        t: item.completion_times || Array(item.student_count).fill(null),
                        isDeadline: item.is_deadline || false,
                        isGroupChecklist: item.is_group_checklist || false // ëª¨ë‘  ì²´í¬ë¦¬ìŠ¤íŠ¸ ì—¬ë¶€
                    }));
                    
                    console.log('Processed checklists:', checklists);
                }

                hideSyncStatus();
                renderChecklistList();
                updateCategoryCheckboxes();
                
                // ë§ˆì§€ë§‰ìœ¼ë¡œ ë³¸ ì²´í¬ë¦¬ìŠ¤íŠ¸ ì„ íƒ
                const lastViewedId = localStorage.getItem(STORAGE_KEYS.LAST_VIEWED);
                if (lastViewedId && checklists.some(c => c.id == lastViewedId)) {
                    selectChecklist(parseInt(lastViewedId));
                } else if (checklists.length > 0) {
                    selectChecklist(checklists[0].id);
                }
                
            } catch (error) {
                console.error('ì²´í¬ë¦¬ìŠ¤íŠ¸ ë¡œë“œ ì‹¤íŒ¨:', error);
                showSyncStatus('error', 'ë¡œë“œ ì‹¤íŒ¨: ' + error.message);
                setTimeout(() => hideSyncStatus(), 5000);
                
                checklists = [];
                renderChecklistList();
                updateCategoryCheckboxes();
            }
        }

        // Supabaseì— ì²´í¬ë¦¬ìŠ¤íŠ¸ ì €ì¥
        async function saveChecklistToSupabase(checklist) {
            if (!supabase) return;

            try {
                const checklistData = {
                    id: checklist.id,
                    teacher_id: teacherId,
                    name: checklist.n,
                    category: checklist.c,
                    student_count: checklist.sc,
                    statuses: checklist.s,
                    completion_times: checklist.t || Array(checklist.sc).fill(null),
                    created_at: checklist.ct,
                    updated_at: new Date().toISOString(),
                    is_deadline: checklist.isDeadline,
                    is_group_checklist: checklist.isGroupChecklist // is_group_checklist í•„ë“œ ì¶”ê°€
                };

                console.log('Saving to Supabase:', checklistData);

                const { data, error } = await supabase
                    .from('checklists')
                    .upsert(checklistData, { 
                        onConflict: 'id',
                        ignoreDuplicates: false 
                    });

                if (error) {
                    console.error('Supabase error details:', error);
                    throw error;
                }

                console.log('Successfully saved to Supabase:', data);
            } catch (error) {
                console.error('Supabase ì €ì¥ ì‹¤íŒ¨:', error);
                throw error;
            }
        }

        // ì²´í¬ë¦¬ìŠ¤íŠ¸ ìƒì„±
        async function createChecklist() {
            if (!supabase) {
                alert('Supabaseì— ì—°ê²°ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. ì„¤ì •ì„ í™•ì¸í•´ì£¼ì„¸ìš”.');
                return;
            }

            if (students.length === 0) {
                alert('í•™ìƒ ì •ë³´ë¥¼ ë¨¼ì € ë“±ë¡í•´ì£¼ì„¸ìš”.');
                return;
            }

            const category = document.getElementById('categorySelect').value;
            const studentCount = students.length;
            
            const now = new Date().toISOString();
            const checklist = {
                id: Date.now(),
                n: `${category} ì²´í¬ë¦¬ìŠ¤íŠ¸ ${checklists.length + 1}`,
                c: category,
                sc: studentCount,
                s: Array(studentCount).fill(0),
                ct: now,
                ut: now,
                t: Array(studentCount).fill(null),
                student_names: students.map(s => s.student_name),
                isDeadline: false, // ê¸°ë³¸ê°’: ë§ˆê° ì „
                isGroupChecklist: false // ì¼ë°˜ ì²´í¬ë¦¬ìŠ¤íŠ¸
            };

            checklists.unshift(checklist);
            
            try {
                showSyncStatus('syncing', 'ì €ì¥ ì¤‘...');
                await saveChecklistToSupabase(checklist);
                showSyncStatus('success', 'ì €ì¥ë¨');
                setTimeout(() => hideSyncStatus(), 1000);
                
                renderChecklistList();
                selectChecklist(checklist.id);
                updateCategoryCheckboxes();
                
            } catch (error) {
                console.error('ì²´í¬ë¦¬ìŠ¤íŠ¸ ìƒì„± ì‹¤íŒ¨:', error);
                showSyncStatus('error', 'ì €ì¥ ì‹¤íŒ¨');
                setTimeout(() => hideSyncStatus(), 3000);
                checklists.shift();
                renderChecklistList();
            }
        }

        // ì¹´í…Œê³ ë¦¬ ì²´í¬ë°•ìŠ¤ ì—…ë°ì´íŠ¸
        function updateCategoryCheckboxes() {
            const container = document.getElementById('categoryCheckboxes');
            const categories = [...new Set(checklists.map(c => c.c))];
            container.innerHTML = categories.map(category => `
                <label class="flex items-center">
                    <input type="checkbox" value="${category}" checked 
                           class="mr-2" onchange="filterChecklists()">
                    ${category}
                </label>
            `).join('');
        }

        // ì¹´í…Œê³ ë¦¬ í•„í„° í† ê¸€
        function toggleCategoryFilter() {
            const filter = document.getElementById('categoryFilter');
            filter.classList.toggle('hidden');
        }

        // ì²´í¬ë¦¬ìŠ¤íŠ¸ í•„í„°ë§
        function filterChecklists() {
            const checkboxes = document.querySelectorAll('#categoryFilter input[type="checkbox"]');
            const selectedCategories = Array.from(checkboxes)
                .filter(cb => cb.checked)
                .map(cb => cb.value);

            const listContainer = document.getElementById('checklistList');
            const items = listContainer.getElementsByClassName('checklist-item');
            
            Array.from(items).forEach(item => {
                const category = item.dataset.category;
                if (selectedCategories.includes('all') || selectedCategories.includes(category)) {
                    item.classList.remove('hidden');
                } else {
                    item.classList.add('hidden');
                }
            });
        }

        // ì²´í¬ë¦¬ìŠ¤íŠ¸ ëª©ë¡ ë Œë”ë§
        function renderChecklistList() {
            const listContainer = document.getElementById('checklistList');
            
            console.log('Rendering checklist list, checklists count:', checklists.length);
            
            if (checklists.length === 0) {
                listContainer.innerHTML = '<div class="text-center text-gray-500 dark:text-gray-400 py-4">ì²´í¬ë¦¬ìŠ¤íŠ¸ê°€ ì—†ìŠµë‹ˆë‹¤.</div>';
                return;
            }
            
            listContainer.innerHTML = checklists.map(checklist => {
                const truncatedTitle = checklist.n.length > 15 ? checklist.n.substring(0, 15) + '...' : checklist.n;
                const deadlineIcon = checklist.isDeadline ? 
                    '<span title="ë§ˆê°ë¨" class="text-xs mr-1 bg-red-100 text-red-800 dark:bg-red-900 dark:text-red-300 px-1.5 py-0.5 rounded-full">ğŸ”’</span>' : 
                    '';
                // ëª¨ë‘  ì²´í¬ë¦¬ìŠ¤íŠ¸ì¼ ê²½ìš° ì•„ì´ì½˜ ì¶”ê°€
                const groupIcon = checklist.isGroupChecklist ? 
                    '<span title="ëª¨ë‘  ì²´í¬ë¦¬ìŠ¤íŠ¸" class="text-xs mr-1 bg-purple-100 text-purple-800 dark:bg-purple-900 dark:text-purple-300 px-1.5 py-0.5 rounded-full">ğŸ‘¨â€ğŸ‘©â€ğŸ‘§â€ğŸ‘¦</span>' : 
                    '';
                return `
                <div class="checklist-item flex items-center p-2 bg-gray-50 rounded cursor-pointer hover:bg-gray-100 ${currentChecklistId === checklist.id ? 'bg-blue-100 dark:bg-blue-900' : ''} dark:bg-gray-700 dark:hover:bg-gray-600"
                     onclick="selectChecklist(${checklist.id})"
                     data-category="${checklist.c}">
                    <div class="flex-1 flex items-center gap-2 min-w-0">
                        <span class="flex-shrink-0 px-2 py-0.5 text-xs rounded-full bg-gray-200 dark:bg-gray-600 text-gray-600 dark:text-gray-300">${checklist.c}</span>
                        <span class="truncate dark:text-gray-100 flex-1 min-w-0" title="${checklist.n}">
                            ${deadlineIcon}${groupIcon}${truncatedTitle}
                        </span>
                    </div>
                </div>
            `}).join('');
        }

        // ì²´í¬ë¦¬ìŠ¤íŠ¸ ì„ íƒ
        function selectChecklist(id) {
            console.log('ğŸ” selectChecklist ì‹œì‘:', id);
            currentChecklistId = id;
            localStorage.setItem(STORAGE_KEYS.LAST_VIEWED, id);
            
            const checklist = checklists.find(c => c.id === id);
            if (checklist) {
                console.log('ğŸ” ì„ íƒëœ ì²´í¬ë¦¬ìŠ¤íŠ¸:', checklist);
                document.getElementById('checklistActions').classList.remove('hidden');
                document.getElementById('statistics').classList.remove('hidden');
                document.getElementById('checklistTitle').value = checklist.n;
                
                const categorySelect = document.getElementById('editCategorySelect');
                categorySelect.value = checklist.c;
                
                // ìƒì„±/ìˆ˜ì • ì‹œê° í‘œì‹œ
                const createdAt = new Date(checklist.ct);
                const updatedAt = new Date(checklist.ut);
                
                const createdKST = createdAt.toLocaleString('ko-KR', {
                    timeZone: 'Asia/Seoul',
                    year: 'numeric',
                    month: '2-digit',
                    day: '2-digit',
                    hour: '2-digit',
                    minute: '2-digit',
                    second: '2-digit',
                    hour12: false
                });
                
                const updatedKST = updatedAt.toLocaleString('ko-KR', {
                    timeZone: 'Asia/Seoul',
                    year: 'numeric',
                    month: '2-digit',
                    day: '2-digit',
                    hour: '2-digit',
                    minute: '2-digit',
                    second: '2-digit',
                    hour12: false
                });
                
                // ë§ˆê° ìƒíƒœ í‘œì‹œ ì¶”ê°€
                const deadlineStatus = checklist.isDeadline ? 
                    `<span class="ml-2 px-1.5 py-0.5 text-xs rounded-full bg-red-100 text-red-800 dark:bg-red-900 dark:text-red-300">ë§ˆê°ë¨</span>` : 
                    `<span class="ml-2 px-1.5 py-0.5 text-xs rounded-full bg-green-100 text-green-800 dark:bg-green-900 dark:text-green-300">ì§„í–‰ì¤‘</span>`;
                
                document.getElementById('checklistInfo').innerHTML = `
                    ìƒì„±: ${createdKST} | 
                    ìˆ˜ì •: ${updatedKST}
                    ${deadlineStatus}
                `;

                // í•™ìƒ ë°ì´í„°ê°€ ì—†ìœ¼ë©´ ë¡œë“œ ì‹œë„
                if (students.length === 0) {
                    console.log('ğŸ” í•™ìƒ ë°ì´í„° ì—†ìŒ, ë¡œë“œ ì‹œë„');
                    loadStudents().then(() => {
                        console.log('ğŸ” í•™ìƒ ë°ì´í„° ë¡œë“œ í›„ ì²´í¬ë¦¬ìŠ¤íŠ¸ ë Œë”ë§');
                        renderChecklistContent(checklist);
                        updateStatistics(checklist);
                    });
                } else {
                    console.log('ğŸ” ê¸°ì¡´ í•™ìƒ ë°ì´í„°ë¡œ ì²´í¬ë¦¬ìŠ¤íŠ¸ ë Œë”ë§');
                    renderChecklistContent(checklist);
                    updateStatistics(checklist);
                }
                
                renderChecklistList();
            }
        }

        // í˜„ì¬ ì²´í¬ë¦¬ìŠ¤íŠ¸ ì—…ë°ì´íŠ¸
        async function updateCurrentChecklist() {
            if (!currentChecklistId || !supabase) return;
            
            const newName = document.getElementById('checklistTitle').value;
            const newCategory = document.getElementById('editCategorySelect').value;
            const checklist = checklists.find(c => c.id === currentChecklistId);
            
            if (checklist) {
                checklist.n = newName;
                checklist.c = newCategory;
                checklist.ut = new Date().toISOString();
                
                // ì¦‰ì‹œ UI ì—…ë°ì´íŠ¸ ì¶”ê°€
                renderChecklistContent(checklist);
                updateStatistics(checklist);
                
                try {
                    showSyncStatus('syncing', 'ì €ì¥ ì¤‘...');
                    await saveChecklistToSupabase(checklist);
                    showSyncStatus('success', 'ì €ì¥ë¨');
                    setTimeout(() => hideSyncStatus(), 1000);
                    
                    renderChecklistList();
                    selectChecklist(currentChecklistId);
                    updateCategoryCheckboxes();
                } catch (error) {
                    console.error('ì—…ë°ì´íŠ¸ ì‹¤íŒ¨:', error);
                    showSyncStatus('error', 'ì €ì¥ ì‹¤íŒ¨');
                    setTimeout(() => hideSyncStatus(), 3000);
                }
            }
        }

        // í˜„ì¬ ì²´í¬ë¦¬ìŠ¤íŠ¸ ì‚­ì œ
        async function deleteCurrentChecklist() {
            if (!currentChecklistId || !supabase) return;
            
            if (confirm('ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                try {
                    showSyncStatus('syncing', 'ì‚­ì œ ì¤‘...');
                    const { error } = await supabase
                        .from('checklists')
                        .delete()
                        .eq('id', currentChecklistId)
                        .eq('teacher_id', teacherId);
                    
                    if (error) throw error;
                    
                    showSyncStatus('success', 'ì‚­ì œë¨');
                    setTimeout(() => hideSyncStatus(), 1000);
                    
                    checklists = checklists.filter(c => c.id !== currentChecklistId);
                    
                    currentChecklistId = null;
                    document.getElementById('checklistActions').classList.add('hidden');
                    document.getElementById('statistics').classList.add('hidden');
                    document.getElementById('checklistContent').innerHTML = '';
                    document.getElementById('checklistTitle').value = '';
                    document.getElementById('checklistInfo').innerHTML = '';
                    
                    renderChecklistList();
                    updateCategoryCheckboxes();
                } catch (error) {
                    console.error('ì‚­ì œ ì‹¤íŒ¨:', error);
                    showSyncStatus('error', 'ì‚­ì œ ì‹¤íŒ¨');
                    setTimeout(() => hideSyncStatus(), 3000);
                }
            }
        }

        // ì™„ë£Œ ìˆœìœ„ ê³„ì‚°
        function getCompletionRanking(checklist) {
            return checklist.t
                .map((time, index) => ({ index, time }))
                .filter(item => item.time !== null)
                .sort((a, b) => new Date(a.time) - new Date(b.time))
                .reduce((acc, item, idx) => {
                    acc[item.index] = idx + 1;
                    return acc;
                }, {});
        }

        // ìƒíƒœ ë³€ê²½
        async function changeStatus(checklistId, studentIndex) {
            if (!supabase) return;

            const checklist = checklists.find(c => c.id === checklistId);
            if (checklist) {
                const currentStatusId = checklist.s[studentIndex];
                let nextStatusId;
                
                // ë§ˆê° ì „/í›„ì— ë”°ë¼ ë‹¤ë¥¸ ìƒíƒœ ë³€ê²½ ë¡œì§ ì ìš©
                if (checklist.isDeadline) {
                    // ë§ˆê° í›„: ëª¨ë“  ìƒíƒœ ì‚¬ìš© ê°€ëŠ¥ (ì™„ë£Œ, ì§„í–‰ì¤‘, ì¬ì œì¶œ, ë¯¸ì™„ë£Œ, ë¯¸ì œì¶œë§ˆê°)
                    const statusKeys = Object.values(STATUS);
                    const currentIndex = statusKeys.findIndex(status => status.id === currentStatusId);
                    const nextIndex = (currentIndex + 1) % statusKeys.length;
                    nextStatusId = statusKeys[nextIndex].id;
                } else {
                    // ë§ˆê° ì „: ì™„ë£Œ(1)ì™€ ë¯¸ì™„ë£Œ(0) ìƒíƒœë§Œ í† ê¸€
                    nextStatusId = currentStatusId === 0 ? 1 : 0;
                }
                
                checklist.s[studentIndex] = nextStatusId;
                
                // ì™„ë£Œ ìƒíƒœë¡œ ë³€ê²½ë  ë•Œ ì‹œê°„ ê¸°ë¡
                if (nextStatusId === 1) {
                    checklist.t[studentIndex] = new Date().toISOString();
                } else if (currentStatusId === 1) {
                    checklist.t[studentIndex] = null;
                }
                
                checklist.ut = new Date().toISOString();
                
                try {
                    await saveChecklistToSupabase(checklist);
                    renderChecklistContent(checklist);
                    updateStatistics(checklist);
                } catch (error) {
                    console.error('ìƒíƒœ ë³€ê²½ ì‹¤íŒ¨:', error);
                    showSyncStatus('error', 'ì €ì¥ ì‹¤íŒ¨');
                    setTimeout(() => hideSyncStatus(), 3000);
                }
            }
        }

        // í†µê³„ ì—…ë°ì´íŠ¸ (ê°œì„ ëœ ë²„ì „)
        function updateStatistics(checklist) {
            const total = checklist.s.length;
            const counts = { 0: 0, 1: 0, 2: 0, 3: 0, 4: 0 };

            checklist.s.forEach(statusId => {
                counts[statusId]++;
            });

            // ëª¨ë‘  ì²´í¬ë¦¬ìŠ¤íŠ¸ ì—¬ë¶€ì— ë”°ë¼ ë‹¨ìœ„ ì„¤ì •
            const unitText = checklist.isGroupChecklist ? 'ëª¨ë‘ ' : 'ëª…';
            document.querySelectorAll('[id^="unitText"]').forEach(el => {
                el.textContent = unitText;
            });

            const statusMapping = {
                0: { countId: 'incompleteCount', percentId: 'incompletePercent', barId: 'incompleteBar' },
                1: { countId: 'completedCount', percentId: 'completedPercent', barId: 'completedBar' },
                2: { countId: 'inProgressCount', percentId: 'inProgressPercent', barId: 'inProgressBar' },
                3: { countId: 'resubmitCount', percentId: 'resubmitPercent', barId: 'resubmitBar' },
                4: { countId: 'deadlineCount', percentId: 'deadlinePercent', barId: 'deadlineBar' }
            };

            Object.entries(counts).forEach(([statusId, count]) => {
                const percent = total > 0 ? ((count / total) * 100).toFixed(1) : '0.0';
                const { countId, percentId, barId } = statusMapping[statusId];
                
                document.getElementById(countId).textContent = count;
                document.getElementById(percentId).textContent = percent;
                document.getElementById(barId).style.width = `${percent}%`;
            });

            // ì™„ë£Œ ìˆœìœ„ í‘œì‹œ
            const completionOrder = checklist.t
                .map((time, index) => ({ index, time }))
                .filter(item => item.time !== null)
                .sort((a, b) => new Date(a.time) - new Date(b.time))
                .slice(0, 5);

            const statisticsSection = document.getElementById('statistics');
            const existingRanking = statisticsSection.querySelector('.ranking-section');
            if (existingRanking) {
                existingRanking.remove();
            }

            if (completionOrder.length > 0) {
                // ëª¨ë‘  ì²´í¬ë¦¬ìŠ¤íŠ¸ì¸ì§€ í™•ì¸
                const isGroupChecklist = checklist.isGroupChecklist;
                
                const rankingHtml = `
                    <div class="ranking-section mt-4 p-3 bg-gray-50 dark:bg-gray-700 rounded-lg">
                        <h4 class="text-sm font-semibold dark:text-gray-100 mb-2">ğŸ† ì™„ë£Œ ìˆœìœ„ (ìƒìœ„ 5ê°œ)</h4>
                        <div class="space-y-1">
                            ${completionOrder.map((item, idx) => {
                                let displayText = '';
                                
                                if (isGroupChecklist) {
                                    // ëª¨ë‘  ì²´í¬ë¦¬ìŠ¤íŠ¸ì¸ ê²½ìš° ëª¨ë‘  í˜•ì‹ìœ¼ë¡œ í‘œì‹œ
                                    const groupNumber = item.index + 1;
                                    displayText = `${groupNumber}ëª¨ë‘ `;
                                } else {
                                    // ì¼ë°˜ ì²´í¬ë¦¬ìŠ¤íŠ¸ì¸ ê²½ìš° ê¸°ì¡´ í˜•ì‹ëŒ€ë¡œ í‘œì‹œ
                                    const studentInfo = students[item.index] || { 
                                        student_number: item.index + 1, 
                                        student_name: `í•™ìƒ ${item.index + 1}` 
                                    };
                                    displayText = `${studentInfo.student_number}ë²ˆ ${studentInfo.student_name}`;
                                }
                                
                                const completionTime = new Date(item.time);
                                const koreanTime = completionTime.toLocaleString('ko-KR', {
                                    timeZone: 'Asia/Seoul',
                                    hour: '2-digit',
                                    minute: '2-digit',
                                    second: '2-digit',
                                    hour12: false
                                });

                                return `
                                <div class="flex items-center justify-between text-sm">
                                    <span class="dark:text-gray-100">
                                        ${idx + 1}ìœ„: ${displayText}
                                    </span>
                                    <span class="text-gray-500 dark:text-gray-400">
                                        ${koreanTime}
                                    </span>
                                </div>
                            `}).join('')}
                        </div>
                    </div>
                `;
                statisticsSection.insertAdjacentHTML('beforeend', rankingHtml);
            }
        }

        // ì²´í¬ë¦¬ìŠ¤íŠ¸ ë‚´ìš© ë Œë”ë§ í•¨ìˆ˜ ìˆ˜ì • (ê¸°ì¡´ í•¨ìˆ˜ ëŒ€ì²´)
        function renderChecklistContent(checklist) {
            const contentContainer = document.getElementById('checklistContent');
            
            // ëª¨ë‘  ì²´í¬ë¦¬ìŠ¤íŠ¸ ì—¬ë¶€ë¥¼ isGroupChecklistë¡œë§Œ íŒë‹¨
            if (checklist.isGroupChecklist) {
                renderGroupChecklistContent(checklist, contentContainer);
            } else {
                renderStudentChecklistContent(checklist, contentContainer);
            }
            
            // ë§ˆê° ë²„íŠ¼ ì¶”ê°€ - ê¸°ì¡´ ë¬¸ì œ í•´ê²°ì„ ìœ„í•´ ì™„ì „íˆ êµì²´
            const deadlineButtonContainer = document.getElementById('checklistActions');
            
            // ë§ˆê° ìƒíƒœì— ë”°ë¼ ë²„íŠ¼ í…ìŠ¤íŠ¸ ë³€ê²½
            const deadlineButtonText = checklist.isDeadline ? 'ë§ˆê° í•´ì œ' : 'ë§ˆê°í•˜ê¸°';
            const deadlineButtonIcon = checklist.isDeadline ? 'ğŸ”“' : 'ğŸ”’';
            const deadlineButtonClass = checklist.isDeadline ? 'bg-green-100 text-green-800 dark:bg-green-900 dark:text-green-300' : 'bg-blue-100 text-blue-800 dark:bg-blue-900 dark:text-blue-300';
            
            // ì‚­ì œ ë²„íŠ¼ì„ í¬í•¨í•œ ëª¨ë“  ë‚´ìš©ì„ ìƒˆë¡œ ì„¤ì •
            deadlineButtonContainer.innerHTML = `
                <button onclick="toggleDeadline(${checklist.id})" 
                        class="icon-btn mr-2 ${deadlineButtonClass}" title="${deadlineButtonText}">
                    ${deadlineButtonIcon}
                </button>
                <button onclick="deleteCurrentChecklist()" 
                        class="icon-btn text-red-500 hover:bg-red-100 dark:hover:bg-red-900">
                    ğŸ—‘ï¸
                </button>
            `;

            // ì „ì²´í™”ë©´ ë²„íŠ¼ì˜ ìƒíƒœë¥¼ ìœ ì§€
            document.getElementById('fullscreenBtn').innerHTML = isFullscreen ? 'â¬…ï¸' : 'ğŸ”';
            document.getElementById('fullscreenBtn').title = isFullscreen ? 'ì „ì²´í™”ë©´ í•´ì œ' : 'ì „ì²´í™”ë©´';
        }

        // í•™ìƒ ì²´í¬ë¦¬ìŠ¤íŠ¸ ë Œë”ë§ (ê¸°ì¡´ renderChecklistContent í•¨ìˆ˜ì˜ ë‚´ìš©)
        function renderStudentChecklistContent(checklist, contentContainer) {
            // ì™„ë£Œ ìˆœìœ„ ê³„ì‚°
            const rankings = getCompletionRanking(checklist);
            // ì²´í¬ë¦¬ìŠ¤íŠ¸ì˜ í•™ìƒ ìˆ˜ì™€ ì‹¤ì œ ë“±ë¡ëœ í•™ìƒ ìˆ˜ê°€ ë‹¤ë¥¸ ê²½ìš° ì²˜ë¦¬
            const maxStudents = Math.min(students.length, checklist.s.length);
            // í•™ìƒ ëª©ë¡ì´ ì—†ìœ¼ë©´ ë©”ì‹œì§€ í‘œì‹œ
            if (maxStudents === 0) {
                contentContainer.innerHTML = `
                    <div class="text-center py-8 text-gray-500 dark:text-gray-400">
                        <div class="text-3xl mb-4">ğŸ¤·â€â™‚ï¸</div>
                        <div class="text-lg font-semibold mb-2">ë“±ë¡ëœ í•™ìƒì´ ì—†ìŠµë‹ˆë‹¤.</div>
                        <div class="text-sm">ì¢Œì¸¡ "í•™ìƒ ì¶”ê°€" ë²„íŠ¼ì„ í´ë¦­í•˜ì—¬ í•™ìƒ ëª©ë¡ì„ ì„¤ì •í•´ì£¼ì„¸ìš”.</div>
                    </div>
                `;
                return;
            }
            contentContainer.innerHTML = students.slice(0, maxStudents).map((student, index) => {
                const status = getStatusById(checklist.s[index]);
                if (!status) {
                    console.warn(`Invalid status ID: ${checklist.s[index]} at index ${index}`);
                    return '';
                }
                const ranking = rankings[index];
                const studentNumber = student.student_number;
                const studentName = student.student_name;
                return `
                    <div class="student-card bg-white dark:bg-gray-700 rounded-lg shadow-md relative">
                        ${ranking ? `<div class="ranking-badge">${ranking}</div>` : ''}
                        <div class="student-number" title="${studentName}">
                            ${studentNumber}ë²ˆ <br> ${studentName}
                        </div>
                        <button class="status-btn ${status.color} text-white w-full"
                                onclick="changeStatus(${checklist.id}, ${index})"
                                title="${studentNumber}ë²ˆ ${studentName} - ${status.text}">
                            ${status.text}
                        </button>
                    </div>
                `;
            }).join('');
        }

        // ëª¨ë‘  ì²´í¬ë¦¬ìŠ¤íŠ¸ ë Œë”ë§
        function renderGroupChecklistContent(checklist, contentContainer) {
            // ì™„ë£Œ ìˆœìœ„ ê³„ì‚°
            const rankings = getCompletionRanking(checklist);
            
            contentContainer.innerHTML = Array.from({length: checklist.sc}, (_, index) => {
                const status = getStatusById(checklist.s[index]);
                const ranking = rankings[index];
                const groupNumber = index + 1;

                return `
                    <div class="student-card bg-white dark:bg-gray-700 rounded-lg shadow-md relative">
                        ${ranking ? `<div class="ranking-badge">${ranking}</div>` : ''}
                        <div class="student-number" title="${groupNumber}ëª¨ë‘ ">
                            ${groupNumber}ëª¨ë‘ 
                        </div>
                        <button class="status-btn ${status.color} text-white w-full"
                                onclick="changeStatus(${checklist.id}, ${index})"
                                title="${groupNumber}ëª¨ë‘  - ${status.text}">
                            ${status.text}
                        </button>
                    </div>
                `;
            }).join('');
        }

        // ë§ˆê° ìƒíƒœ í† ê¸€ í•¨ìˆ˜
        async function toggleDeadline(checklistId) {
            if (!supabase) return;

            const checklist = checklists.find(c => c.id === checklistId);
            if (checklist) {
                // ìƒíƒœ ë³€ê²½
                checklist.isDeadline = !checklist.isDeadline;
                checklist.ut = new Date().toISOString();
                
                try {
                    showSyncStatus('syncing', 'ë§ˆê° ìƒíƒœ ë³€ê²½ ì¤‘...');
                    // ì„œë²„ì— ë§ˆê° ìƒíƒœ ì €ì¥
                    await saveChecklistToSupabase(checklist);
                    showSyncStatus('success', checklist.isDeadline ? 'ë§ˆê° ì™„ë£Œ' : 'ë§ˆê° í•´ì œ');
                    setTimeout(() => hideSyncStatus(), 1000);
                    
                    renderChecklistContent(checklist);
                } catch (error) {
                    console.error('ë§ˆê° ìƒíƒœ ë³€ê²½ ì‹¤íŒ¨:', error);
                    checklist.isDeadline = !checklist.isDeadline; // ì‹¤íŒ¨ ì‹œ ì›ë˜ ìƒíƒœë¡œ ë˜ëŒë¦¼
                    showSyncStatus('error', 'ë§ˆê° ìƒíƒœ ë³€ê²½ ì‹¤íŒ¨');
                    setTimeout(() => hideSyncStatus(), 3000);
                }
            }
        }

        // ë‹¤í¬ëª¨ë“œ í† ê¸€
        function toggleDarkMode() {
            isDarkMode = !isDarkMode;
            if (isDarkMode) {
                document.documentElement.classList.add('dark');
                document.getElementById('darkModeIcon').textContent = 'â˜€ï¸';
            } else {
                document.documentElement.classList.remove('dark');
                document.getElementById('darkModeIcon').textContent = 'ğŸŒ™';
            }
            localStorage.setItem(STORAGE_KEYS.DARK_MODE, isDarkMode);
        }

        // ì‹œê³„ ì—…ë°ì´íŠ¸
        function updateClock() {
            const now = new Date();
            document.getElementById('clock').textContent = now.toLocaleTimeString();
        }

        // ì´ˆê¸°í™”
        async function init() {
            try {
                console.log('ğŸ” init í•¨ìˆ˜ ì‹œì‘');
                
                // ë‹¤í¬ëª¨ë“œ ì„¤ì •
                if (isDarkMode) {
                    console.log('ğŸ” ë‹¤í¬ëª¨ë“œ ì ìš©');
                    document.documentElement.classList.add('dark');
                    document.getElementById('darkModeIcon').textContent = 'â˜€ï¸';
                }

                // ì‹œê³„ ì‹œì‘
                console.log('ğŸ” ì‹œê³„ ì´ˆê¸°í™”');
                updateClock();
                setInterval(updateClock, 1000);

                // ì €ì¥ëœ í•™ìƒ ìˆ˜ ë¶ˆëŸ¬ì˜¤ê¸°
                const savedCount = localStorage.getItem(STORAGE_KEYS.STUDENT_COUNT);
                if (savedCount) {
                    console.log('ğŸ” ì €ì¥ëœ í•™ìƒ ìˆ˜:', savedCount);
                    document.getElementById('studentCountDisplay').textContent = savedCount;
                }

                // Supabase ì´ˆê¸°í™”
                console.log('ğŸ” Supabase ì´ˆê¸°í™” ì‹œì‘');
                await initSupabase();
                console.log('ğŸ” Supabase ì´ˆê¸°í™” ì™„ë£Œ');
            } catch (error) {
                console.error('âŒ ì´ˆê¸°í™” ì¤‘ ì˜¤ë¥˜ ë°œìƒ:', error);
                console.error('âŒ ì—ëŸ¬ ìƒì„¸:', {
                    message: error.message,
                    stack: error.stack,
                    code: error.code
                });
            }
        }

        // í˜ì´ì§€ ë¡œë“œ ì‹œ ì´ˆê¸°í™”
        document.addEventListener('DOMContentLoaded', async () => {
            cleanUpOAuthParams();
            console.log('ğŸ” DOMContentLoaded ì´ë²¤íŠ¸ ë°œìƒ');
            console.log('ğŸ” window.supabase ìƒíƒœ:', !!window.supabase);
            console.log('ğŸ” SUPABASE_CONFIG ìƒíƒœ:', SUPABASE_CONFIG);
            init().catch(error => {
                console.error('âŒ init í•¨ìˆ˜ ì‹¤í–‰ ì¤‘ ì˜¤ë¥˜:', error);
            });
            if (!supabase) {
                supabase = window.supabase.createClient(SUPABASE_CONFIG.URL, SUPABASE_CONFIG.ANON_KEY);
            }
            const { data: { session } } = await supabase.auth.getSession();
            if (session) {
                // ì´ë¯¸ ë¡œê·¸ì¸ëœ ê²½ìš°
                // session.user.email ë“±ìœ¼ë¡œ ì‚¬ìš©ì ì •ë³´ ì‚¬ìš© ê°€ëŠ¥
                // teacherId = session.user.email; ë“±ìœ¼ë¡œ í™œìš© ê°€ëŠ¥
            }
            await handleGoogleLoginResult();
        });

        // í•™ìƒ ê´€ë ¨ í•¨ìˆ˜ë“¤
        async function loadStudents() {
            console.log('ğŸ” loadStudents ì‹œì‘');
            console.log('ğŸ” í˜„ì¬ ìƒíƒœ:', {
                supabase: !!supabase,
                teacherId,
                students: students.length
            });

            if (!supabase || !teacherId) {
                console.log('âŒ í•™ìƒ ë¡œë“œ ì‹¤íŒ¨ - Supabase ë˜ëŠ” teacherId ì—†ìŒ:', {
                    supabase: !!supabase,
                    teacherId
                });
                students = [];
                updateStudentDisplay();
                return;
            }

            try {
                showSyncStatus('syncing', 'í•™ìƒ ëª©ë¡ ë¡œë“œ ì¤‘...');
                console.log('ğŸ” Supabase ì¿¼ë¦¬ ì‹¤í–‰:', {
                    table: 'students',
                    teacher_id: teacherId
                });

                const { data, error } = await supabase
                    .from('students')
                    .select('*')
                    .eq('teacher_id', teacherId)
                    .order('student_number', { ascending: true });

                console.log('ğŸ” Supabase ì‘ë‹µ:', { data, error });

                if (error) {
                    if (error.code === 'PGRST116' || error.message.includes('relation "students" does not exist')) {
                        console.warn('âŒ Supabase "students" í…Œì´ë¸”ì´ ì¡´ì¬í•˜ì§€ ì•ŠìŒ');
                        students = [];
                        updateStudentDisplay();
                        hideSyncStatus();
                        return;
                    }
                    throw error;
                }

                students = data || [];
                console.log('âœ… í•™ìƒ ë°ì´í„° ë¡œë“œ ì„±ê³µ:', {
                    count: students.length,
                    firstStudent: students[0],
                    lastStudent: students[students.length - 1]
                });

                updateStudentDisplay();
                hideSyncStatus();
            } catch (error) {
                console.error('âŒ í•™ìƒ ì •ë³´ ë¡œë“œ ì‹¤íŒ¨:', error);
                console.error('âŒ ì—ëŸ¬ ìƒì„¸:', {
                    message: error.message,
                    stack: error.stack,
                    code: error.code
                });
                showSyncStatus('error', 'í•™ìƒ ëª©ë¡ ë¡œë“œ ì‹¤íŒ¨: ' + error.message);
                setTimeout(() => hideSyncStatus(), 5000);
                students = [];
                updateStudentDisplay();
            }
        }

        function updateStudentDisplay() {
            const noStudents = document.getElementById('noStudents');
            const hasStudents = document.getElementById('hasStudents');
            const createButton = document.getElementById('createChecklist');
            const createGroupButton = document.getElementById('createGroupChecklist');
            
            if (students.length === 0) {
                noStudents.classList.remove('hidden');
                hasStudents.classList.add('hidden');
                createButton.disabled = true;
                createGroupButton.disabled = true;
            } else {
                noStudents.classList.add('hidden');
                hasStudents.classList.remove('hidden');
                createButton.disabled = false;
                createGroupButton.disabled = false;
                
                document.getElementById('studentCountDisplay').textContent = students.length;
                document.getElementById('studentList').innerHTML = students
                    .slice(0, 5)
                    .map(s => `${s.student_number}. ${s.student_name}`)
                    .join(', ') + (students.length > 5 ? '...' : '');
            }
        }

        function downloadCSVTemplate() {
            // ANSI(EUC-KR) ì¸ì½”ë”©ì„ ìœ„í•œ í•œê¸€ CSV ë‚´ìš©
            const csvContent = "í•™ìƒë²ˆí˜¸,í•™ìƒì´ë¦„\n1,í™ê¸¸ë™\n2,ê¹€ì² ìˆ˜\n3,ì´ì˜í¬";
            
            // EUC-KR ì¸ì½”ë”©ìœ¼ë¡œ ë³€í™˜ (ì—‘ì…€ í˜¸í™˜)
            const blob = new Blob(['\uFEFF' + csvContent], { 
                type: 'text/csv;charset=utf-8;' 
            });
            
            const link = document.createElement('a');
            
            if (link.download !== undefined) {
                const url = URL.createObjectURL(blob);
                link.setAttribute('href', url);
                link.setAttribute('download', 'í•™ìƒëª…ë‹¨_ì–‘ì‹.csv');
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            }
        }

        function uploadStudentCSV() {
            const fileInput = document.getElementById('csvFileInput');
            const file = fileInput.files[0];
            
            if (!file) {
                alert('CSV íŒŒì¼ì„ ì„ íƒí•´ì£¼ì„¸ìš”.');
                return;
            }

            // ë¨¼ì € ANSI(EUC-KR) ì¸ì½”ë”©ìœ¼ë¡œ ì‹œë„
            tryParseWithEncoding(file, 'EUC-KR', function(success, results) {
                if (success) {
                    console.log('ğŸ” EUC-KR ì¸ì½”ë”©ìœ¼ë¡œ ì„±ê³µ');
                    processCSVResults(results);
                } else {
                    // EUC-KRì´ ì‹¤íŒ¨í•˜ë©´ UTF-8ë¡œ ì‹œë„
                    console.log('ğŸ” EUC-KR ì‹¤íŒ¨, UTF-8ë¡œ ì¬ì‹œë„');
                    tryParseWithEncoding(file, 'UTF-8', function(success, results) {
                        if (success) {
                            console.log('ğŸ” UTF-8 ì¸ì½”ë”©ìœ¼ë¡œ ì„±ê³µ');
                            processCSVResults(results);
                        } else {
                            alert('CSV íŒŒì¼ì„ ì½ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. íŒŒì¼ í˜•ì‹ì„ í™•ì¸í•´ì£¼ì„¸ìš”.');
                        }
                    });
                }
            });
        }

        // íŠ¹ì • ì¸ì½”ë”©ìœ¼ë¡œ íŒŒì¼ ì½ê¸° ì‹œë„
        function tryParseWithEncoding(file, encoding, callback) {
            const reader = new FileReader();
            
            reader.onload = function(e) {
                try {
                    const csvText = e.target.result;
                    console.log(`ğŸ” ${encoding} ì¸ì½”ë”©ìœ¼ë¡œ ì½ì€ í…ìŠ¤íŠ¸:`, csvText.substring(0, 100));
                    
                    Papa.parse(csvText, {
                        header: true,
                        skipEmptyLines: true,
                        dynamicTyping: false,
                        complete: function(results) {
                            if (results.errors.length > 0) {
                                console.error(`${encoding} íŒŒì‹± ì˜¤ë¥˜:`, results.errors);
                                callback(false, null);
                                return;
                            }
                            
                            // í•œê¸€ì´ ì œëŒ€ë¡œ íŒŒì‹±ë˜ì—ˆëŠ”ì§€ í™•ì¸
                            const hasKorean = results.data.some(row => 
                                Object.values(row).some(value => 
                                    typeof value === 'string' && /[ê°€-í£]/.test(value)
                                )
                            );
                            
                            console.log(`ğŸ” ${encoding} í•œê¸€ ê°ì§€:`, hasKorean);
                            console.log(`ğŸ” ${encoding} ì²« ë²ˆì§¸ í–‰:`, results.data[0]);
                            
                            callback(true, results);
                        },
                        error: function(error) {
                            console.error(`${encoding} íŒŒì‹± ì˜¤ë¥˜:`, error);
                            callback(false, null);
                        }
                    });
                } catch (error) {
                    console.error(`${encoding} ì½ê¸° ì˜¤ë¥˜:`, error);
                    callback(false, null);
                }
            };
            
            reader.onerror = function() {
                console.error(`${encoding} íŒŒì¼ ì½ê¸° ì‹¤íŒ¨`);
                callback(false, null);
            };
            
            // ì¸ì½”ë”©ì— ë”°ë¼ ë‹¤ë¥´ê²Œ ì½ê¸°
            if (encoding === 'EUC-KR') {
                reader.readAsText(file, 'EUC-KR');
            } else {
                reader.readAsText(file, 'UTF-8');
            }
        }

        // CSV ê²°ê³¼ ì²˜ë¦¬
        function processCSVResults(results) {
            console.log('ğŸ” CSV íŒŒì‹± ê²°ê³¼:', results);
            console.log('ğŸ” ì²« ë²ˆì§¸ í–‰ ë°ì´í„°:', results.data[0]);
            console.log('ğŸ” í—¤ë”ë“¤:', Object.keys(results.data[0] || {}));
            
            // í—¤ë” ì •ë¦¬ í•¨ìˆ˜ (ê³µë°±, íŠ¹ìˆ˜ë¬¸ì ì œê±°)
            function cleanHeader(header) {
                return header.replace(/[\s\uFEFF\xA0]/g, '').toLowerCase();
            }

            // ê°€ëŠ¥í•œ ëª¨ë“  í—¤ë” ì¡°í•© í™•ì¸
            const parsedStudents = results.data
                .filter(row => {
                    // ëª¨ë“  í‚¤ë¥¼ ì •ë¦¬í•´ì„œ í™•ì¸
                    const cleanKeys = Object.keys(row).map(key => ({
                        original: key,
                        clean: cleanHeader(key)
                    }));
                    
                    // í•™ìƒë²ˆí˜¸ ì°¾ê¸°
                    const numberKey = cleanKeys.find(k => 
                        k.clean.includes('ë²ˆí˜¸') || 
                        k.clean.includes('number') || 
                        k.clean === 'í•™ìƒë²ˆí˜¸' ||
                        k.clean === 'ë²ˆí˜¸'
                    )?.original;
                    
                    // í•™ìƒì´ë¦„ ì°¾ê¸°
                    const nameKey = cleanKeys.find(k => 
                        k.clean.includes('ì´ë¦„') || 
                        k.clean.includes('name') || 
                        k.clean === 'í•™ìƒì´ë¦„' ||
                        k.clean === 'ì´ë¦„'
                    )?.original;
                    
                    return numberKey && nameKey && row[numberKey] && row[nameKey];
                })
                .map(row => {
                    const cleanKeys = Object.keys(row).map(key => ({
                        original: key,
                        clean: cleanHeader(key)
                    }));
                    
                    const numberKey = cleanKeys.find(k => 
                        k.clean.includes('ë²ˆí˜¸') || 
                        k.clean.includes('number') || 
                        k.clean === 'í•™ìƒë²ˆí˜¸' ||
                        k.clean === 'ë²ˆí˜¸'
                    )?.original;
                    
                    const nameKey = cleanKeys.find(k => 
                        k.clean.includes('ì´ë¦„') || 
                        k.clean.includes('name') || 
                        k.clean === 'í•™ìƒì´ë¦„' ||
                        k.clean === 'ì´ë¦„'
                    )?.original;
                    
                    const studentNumber = parseInt(String(row[numberKey]).trim());
                    const studentName = String(row[nameKey]).trim();
                    
                    return {
                        student_number: studentNumber,
                        student_name: studentName
                    };
                })
                .filter(student => !isNaN(student.student_number) && student.student_name && student.student_name !== '');

            console.log('ğŸ” ìµœì¢… ì²˜ë¦¬ëœ í•™ìƒ ë°ì´í„°:', parsedStudents);

            if (parsedStudents.length === 0) {
                alert(`ìœ íš¨í•œ í•™ìƒ ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤.\n\ní˜„ì¬ ê°ì§€ëœ í—¤ë”: ${Object.keys(results.data[0] || {}).join(', ')}\n\nì˜¬ë°”ë¥¸ í˜•ì‹:\ní•™ìƒë²ˆí˜¸,í•™ìƒì´ë¦„\n1,í™ê¸¸ë™\n2,ê¹€ì² ìˆ˜`);
                return;
            }

            const duplicates = parsedStudents.filter((student, index, arr) => 
                arr.findIndex(s => s.student_number === student.student_number) !== index
            );
            
            if (duplicates.length > 0) {
                alert('ì¤‘ë³µëœ í•™ìƒë²ˆí˜¸ê°€ ìˆìŠµë‹ˆë‹¤: ' + duplicates.map(s => s.student_number).join(', '));
                return;
            }

            uploadedStudents = parsedStudents.sort((a, b) => a.student_number - b.student_number);
            
            document.getElementById('studentPreview').classList.remove('hidden');
            document.getElementById('studentPreviewList').innerHTML = uploadedStudents
                .map(s => `<div>${s.student_number}. ${s.student_name}</div>`)
                .join('');
        }

        function showStudentUploadModal() {
            document.getElementById('studentUploadModal').classList.remove('hidden');
            document.getElementById('studentPreview').classList.add('hidden');
            document.getElementById('csvFileInput').value = '';
            uploadedStudents = [];
        }

        function closeStudentUploadModal() {
            document.getElementById('studentUploadModal').classList.add('hidden');
            uploadedStudents = [];
        }

        async function saveStudentData() {
            if (uploadedStudents.length === 0) {
                alert('ì €ì¥í•  í•™ìƒ ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤.');
                return;
            }

            if (!supabase || !teacherId) {
                alert('ë¡œê·¸ì¸ ìƒíƒœë¥¼ í™•ì¸í•´ì£¼ì„¸ìš”.');
                return;
            }

            try {
                showSyncStatus('syncing', 'í•™ìƒ ì •ë³´ ì €ì¥ ì¤‘...');

                try {
                    const { error: deleteError } = await supabase
                        .from('students')
                        .delete()
                        .eq('teacher_id', teacherId);

                    if (deleteError && !deleteError.message.includes('relation "students" does not exist')) {
                        throw deleteError;
                    }
                } catch (deleteError) {
                    console.log('Delete error (table may not exist):', deleteError);
                }

                const studentsToSave = uploadedStudents.map(student => ({
                    id: Date.now() + student.student_number,
                    teacher_id: teacherId,
                    student_number: student.student_number,
                    student_name: student.student_name,
                    created_at: new Date().toISOString(),
                    updated_at: new Date().toISOString()
                }));

                const { error: insertError } = await supabase
                    .from('students')
                    .insert(studentsToSave);

                if (insertError) {
                    if (insertError.message.includes('relation "students" does not exist')) {
                        alert('Supabaseì—ì„œ students í…Œì´ë¸”ì„ ë¨¼ì € ìƒì„±í•´ì£¼ì„¸ìš”.\n\nê´€ë¦¬ìì—ê²Œ ë¬¸ì˜í•˜ì„¸ìš”.');
                        return;
                    }
                    throw insertError;
                }

                students = studentsToSave;
                updateStudentDisplay();
                closeStudentUploadModal();
                
                showSyncStatus('success', `${students.length}ëª…ì˜ í•™ìƒ ì •ë³´ê°€ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤!`);
                setTimeout(() => hideSyncStatus(), 3000);

            } catch (error) {
                console.error('í•™ìƒ ì •ë³´ ì €ì¥ ì‹¤íŒ¨:', error);
                showSyncStatus('error', 'ì €ì¥ ì‹¤íŒ¨: ' + error.message);
                setTimeout(() => hideSyncStatus(), 3000);
            }
        }

        // ëª¨ë‘  ì²´í¬ë¦¬ìŠ¤íŠ¸ ëª¨ë‹¬ í‘œì‹œ
        function showGroupChecklistModal() {
            document.getElementById('groupChecklistModal').classList.remove('hidden');
            document.getElementById('groupCountInput').value = '6';
            document.getElementById('groupChecklistName').value = '';
            setTimeout(() => {
                document.getElementById('groupChecklistName').focus();
            }, 100);
        }

        // ëª¨ë‘  ì²´í¬ë¦¬ìŠ¤íŠ¸ ëª¨ë‹¬ ë‹«ê¸°
        function closeGroupChecklistModal() {
            document.getElementById('groupChecklistModal').classList.add('hidden');
        }

        // ëª¨ë‘  ì²´í¬ë¦¬ìŠ¤íŠ¸ ìƒì„±
        async function createGroupChecklist() {
            if (!supabase) {
                alert('Supabaseì— ì—°ê²°ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. ì„¤ì •ì„ í™•ì¸í•´ì£¼ì„¸ìš”.');
                return;
            }

            const groupCount = parseInt(document.getElementById('groupCountInput').value);
            const checklistName = document.getElementById('groupChecklistName').value.trim() || `ëª¨ë‘  ì²´í¬ë¦¬ìŠ¤íŠ¸ ${checklists.length + 1}`;
            const category = document.getElementById('groupCategorySelect').value; // ëª¨ë‘  ì „ìš© ì¹´í…Œê³ ë¦¬ ì„ íƒê¸° ì‚¬ìš©
            
            if (groupCount <= 0 || groupCount > 20) {
                alert('ëª¨ë‘  ê°œìˆ˜ëŠ” 1~20ê°œ ì‚¬ì´ë¡œ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                return;
            }
            
            const now = new Date().toISOString();
            const checklist = {
                id: Date.now(),
                n: checklistName,
                c: category, // ì„ íƒí•œ ì¹´í…Œê³ ë¦¬ ì‚¬ìš©
                sc: groupCount, // ëª¨ë‘  ê°œìˆ˜
                s: Array(groupCount).fill(0),
                ct: now,
                ut: now,
                t: Array(groupCount).fill(null),
                isDeadline: false,
                isGroupChecklist: true // ëª¨ë‘  ì²´í¬ë¦¬ìŠ¤íŠ¸ í‘œì‹œ
            };

            checklists.unshift(checklist);
            
            try {
                showSyncStatus('syncing', 'ì €ì¥ ì¤‘...');
                await saveChecklistToSupabase(checklist);
                showSyncStatus('success', 'ì €ì¥ë¨');
                setTimeout(() => hideSyncStatus(), 1000);
                
                renderChecklistList();
                selectChecklist(checklist.id);
                updateCategoryCheckboxes();
                closeGroupChecklistModal();
                
            } catch (error) {
                console.error('ëª¨ë‘  ì²´í¬ë¦¬ìŠ¤íŠ¸ ìƒì„± ì‹¤íŒ¨:', error);
                showSyncStatus('error', 'ì €ì¥ ì‹¤íŒ¨');
                setTimeout(() => hideSyncStatus(), 3000);
                checklists.shift();
                renderChecklistList();
            }
        }

        async function googleLogin() {
            if (!supabase) {
                supabase = window.supabase.createClient(SUPABASE_CONFIG.URL, SUPABASE_CONFIG.ANON_KEY);
            }
            
            try {
                console.log('ğŸ” êµ¬ê¸€ ë¡œê·¸ì¸ ì‹œì‘');
                const { data, error } = await supabase.auth.signInWithOAuth({
                    provider: 'google',
                    options: {
                        redirectTo: 'https://euphonious-pixie-336fea.netlify.app/',
                        queryParams: {
                            access_type: 'offline',
                            prompt: 'consent',
                        }
                    }
                });
                
                if (error) {
                    console.error('êµ¬ê¸€ ë¡œê·¸ì¸ ì˜¤ë¥˜:', error);
                    alert('êµ¬ê¸€ ë¡œê·¸ì¸ ì‹¤íŒ¨: ' + error.message);
                } else {
                    console.log('âœ… êµ¬ê¸€ ë¡œê·¸ì¸ ìš”ì²­ ì„±ê³µ:', data);
                }
            } catch (error) {
                console.error('êµ¬ê¸€ ë¡œê·¸ì¸ ì˜ˆì™¸:', error);
                alert('êµ¬ê¸€ ë¡œê·¸ì¸ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
            }
        }

        // í˜ì´ì§€ ë¡œë“œ ì‹œ(ë˜ëŠ” ë¡œê·¸ì¸ í›„) ì„¸ì…˜ ë° ì‚¬ìš©ì ì •ë³´ í™•ì¸
        async function handleGoogleLoginResult() {
            // ë¡œì»¬ìŠ¤í† ë¦¬ì§€ì— ì´ë¯¸ êµì‚¬ IDê°€ ìˆìœ¼ë©´ êµ¬ê¸€ ë¡œê·¸ì¸ ì²˜ë¦¬í•˜ì§€ ì•ŠìŒ
            const savedTeacherId = localStorage.getItem(STORAGE_KEYS.TEACHER_ID);
            if (savedTeacherId && savedTeacherId.trim() !== '') {
                console.log('ë¡œì»¬ êµì‚¬ IDê°€ ìˆìœ¼ë¯€ë¡œ êµ¬ê¸€ ë¡œê·¸ì¸ ë¬´ì‹œ:', savedTeacherId);
                return;
            }
            if (!supabase) {
                supabase = window.supabase.createClient(SUPABASE_CONFIG.URL, SUPABASE_CONFIG.ANON_KEY);
            }
            const { data: { session }, error } = await supabase.auth.getSession();
            if (error) {
                console.error('ì„¸ì…˜ ì •ë³´ ê°€ì ¸ì˜¤ê¸° ì˜¤ë¥˜:', error);
                return;
            }
            if (session && session.user) {
                // ì‚¬ìš©ì ì •ë³´ í™œìš© ì˜ˆì‹œ
                const user = session.user;
                console.log('êµ¬ê¸€ ë¡œê·¸ì¸ ì„±ê³µ! ì‚¬ìš©ì ì •ë³´:', user);

                // ì˜ˆì‹œ: ì´ë©”ì¼ì„ teacherIdë¡œ ì‚¬ìš©
                teacherId = user.email;
                localStorage.setItem(STORAGE_KEYS.TEACHER_ID, teacherId);

                // UI ì—…ë°ì´íŠ¸ ë° ë°ì´í„° ë¡œë“œ
                document.getElementById('configModal').style.display = 'none';
                document.getElementById('noConnection').classList.add('hidden');
                document.getElementById('mainContent').classList.remove('hidden');
                document.getElementById('teacherInfo').textContent = `ğŸ‘¨â€ğŸ« ${user.email}`;

                // ì²´í¬ë¦¬ìŠ¤íŠ¸ ë° í•™ìƒ ë°ì´í„° ë¡œë“œ
                await loadChecklists();
                await loadStudents();
            }
        }

        function cleanUpOAuthParams() {
            if (window.location.search.includes('code=') || window.location.search.includes('access_token=')) {
                // í˜„ì¬ URLì—ì„œ ì¿¼ë¦¬ìŠ¤íŠ¸ë§ ì œê±°
                window.history.replaceState({}, document.title, window.location.pathname);
            }
        }
    </script>
</body>
</html>